<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarberConnect - Cliente</title>
    <link rel="manifest" href="manifest-cliente.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
    /* --- INICIO: NUEVOS ESTILOS DARK MODE --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: system-ui, -apple-system, sans-serif; 
        background: #000; 
        height: 100vh; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
    }
    .chat-container { 
        width: 100%; 
        max-width: 400px; 
        height: 100vh; 
        background: #121212; 
        color: #E0E0E0;
        display: flex; 
        flex-direction: column; 
        box-shadow: 0 0 15px rgba(255,179,0,0.1); 
    }
    .chat-header {
        background: #1E1E1E;
        color: white;
        padding: 10px 15px;
        text-align: left;
        position: relative;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 15px;
        border-bottom: 1px solid #2C2C2C;
    }
    .chat-header h1 { margin: 0; font-size: 1.5em; }
    .chat-header p { margin: 5px 0 0 0; opacity: 0.7; font-size: 0.9em; color: #A0A0A0; }

    .messages-container { 
        flex: 1; 
        padding: 15px; 
        overflow-y: auto; 
        background: #121212; 
        min-height: 0; 
    }
    .message { margin-bottom: 12px; display: flex; flex-direction: column; animation: fadeIn 0.3s ease-in; }
    .message.user { align-items: flex-end; }
    .message.bot { align-items: flex-start; }
    .message-content { padding: 10px 14px; border-radius: 18px; max-width: 85%; word-wrap: break-word; line-height: 1.4; }
    .message.user .message-content { 
        background: #FFB300; 
        color: #121212; 
        font-weight: 500;
        border-bottom-right-radius: 4px; 
    }
    .message.bot .message-content { 
        background: #1E1E1E; 
        color: #E0E0E0; 
        border-bottom-left-radius: 4px; 
    }
    .message-time { font-size: 0.7em; color: #A0A0A0; margin-top: 4px; padding: 0 8px; }

    .typing { display: flex; padding: 10px 14px; background: #1E1E1E; border-radius: 18px; }
    .typing span { height: 6px; width: 6px; background: #A0A0A0; border-radius: 50%; display: block; margin: 0 2px; animation: typing 1s infinite ease-in-out; }
    .typing span:nth-child(1) { animation-delay: 0.2s; }
    .typing span:nth-child(2) { animation-delay: 0.4s; }
    .typing span:nth-child(3) { animation-delay: 0.6s; }

    .input-container { 
        display: flex; 
        padding: 12px; 
        background: #1E1E1E; 
        border-top: 1px solid #2C2C2C; 
        gap: 8px; 
        align-items: center; /* Alinear verticalmente */
    }
    .message-input { 
        flex: 1; 
        padding: 10px 14px; 
        border: 1px solid #2C2C2C; 
        background-color: #121212;
        color: #E0E0E0;
        border-radius: 20px; 
        outline: none; 
        font-size: 14px; 
    }
    .message-input:focus {
        border-color: #FFB300;
    }
    .send-button { 
        padding: 10px 16px; 
        background: #FFB300; 
        color: #121212; 
        font-weight: bold;
        border: none; 
        border-radius: 20px; 
        cursor: pointer; 
    }
    .send-button:disabled { background: #555; color: #888; cursor: not-allowed; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

    .bot-card { 
        background-color: #1E1E1E; 
        border: 1px solid #2C2C2C; 
        border-radius: 12px; 
        padding: 16px; 
        width: 100%; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
    }
    .bot-card h3 { margin: 0 0 12px 0; color: #FFFFFF; border-bottom: 1px solid #2C2C2C; padding-bottom: 8px; font-size: 1.1em; }
    .bot-card p { margin: 0 0 8px 0; line-height: 1.5; color: #A0A0A0; }
    .bot-card ul { list-style: none; padding: 0; margin: 0 0 10px 0; }
    .bot-card li { padding: 8px 0; border-bottom: 1px solid #2C2C2C; display: flex; justify-content: space-between; align-items: center; }
    .bot-card li:last-child { border-bottom: none; }
    .bot-card .helper-text { font-size: 0.8em; color: #888; margin-top: 5px; }

    .command-buttons-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
    .command-button { 
        background-color: #2C2C2C; 
        border: 1px solid #444; 
        border-radius: 8px; 
        padding: 12px 8px; 
        font-size: 0.9em; 
        font-weight: 500; 
        color: #E0E0E0; 
        cursor: pointer; 
        text-align: center; 
        transition: background-color 0.2s, box-shadow 0.2s; 
        width: 100%; 
    }
    .command-button:hover { background-color: #444; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .command-button.full-width { grid-column: 1 / -1; }
    .command-button.confirm { background-color: #4CAF50; color: white; }
    .command-button.cancel { background-color: #F44336; color: white; }

    .header-icons { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); }
    .icon-wrapper { position: relative; cursor: pointer; }
    .icon-wrapper svg { width: 26px; height: 26px; fill: white; }
    .notification-badge {
        position: absolute; top: -5px; right: -8px; background-color: #F44336; color: white;
        border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: none;
        justify-content: center; align-items: center; font-weight: bold; border: 2px solid #1E1E1E;
    }
    .notification-badge.visible { display: flex; animation: pulse-badge 2s infinite; }
    @keyframes pulse-badge { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 8px rgba(244, 67, 54, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); } }

    #qr-reader {
        width: 100%;
        border: 2px solid #2C2C2C;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 10px;
    }
    .profile-picture-container {
        width: 50px; height: 50px; border-radius: 50%; overflow: hidden; flex-shrink: 0;
        border: 2px solid rgba(255, 255, 255, 0.5); box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .barber-profile-pic { width: 100%; height: 100%; object-fit: cover; }
    
    .menu-button {
        display: none; /* Oculto por defecto */
        flex-shrink: 0;
        padding: 8px;
        background: #2C2C2C;
        border: 1px solid #444;
        border-radius: 50%; /* Redondo */
        cursor: pointer;
        width: 38px; /* Tama√±o consistente */
        height: 38px;
        transition: background-color 0.2s;
    }
    .menu-button.visible {
        display: block; /* Mostrarlo en modo chat */
    }
    .menu-button:hover {
        background-color: #444;
    }
    .menu-button svg {
        width: 100%;
        height: 100%;
        fill: #E0E0E0;
    }

    .profile-avatar-wrapper { display: flex; justify-content: center; margin-bottom: 16px; }
    .profile-avatar {
        width: 100px; height: 100px; border-radius: 50%; background-color: #FFB300; color: #121212;
        display: flex; justify-content: center; align-items: center; font-size: 2.5em; font-weight: bold;
        border: 3px solid #1E1E1E; box-shadow: 0 4px 8px rgba(0,0,0,0.3); overflow: hidden;
    }
    .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
    
    .edit-icon-button {
        background-color: #2C2C2C;
        border: 1px solid #444;
        border-radius: 6px; /* Bordes suaves */
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
        flex-shrink: 0; /* Evita que el bot√≥n se encoja */
    }
    .edit-icon-button:hover {
        background-color: #444;
    }
    .edit-icon-button svg {
        width: 16px;
        height: 16px;
        fill: #E0E0E0; /* Color del √≠cono */
    }
    .bot-card li { 
        padding: 8px 0; border-bottom: 1px solid #2C2C2C; 
        display: flex; justify-content: space-between; align-items: center; 
    }
    .bot-card .item-name { font-weight: 500; color: #E0E0E0; }
    .bot-card .item-detail { color: #A0A0A0; font-size: 0.9em; text-align: right; }

    /* --- INICIO: Mejora Est√©tica Horario de Atenci√≥n --- */
    .bot-card ul.availability-list {
        margin-top: 10px; /* Espacio despu√©s del nombre del barbero (h4) */
    }

    .bot-card ul.availability-list li {
        display: flex;
        flex-direction: column; /* Apilar verticalmente */
        align-items: flex-start; /* Alinear a la izquierda */
        padding: 12px 0; /* M√°s espacio */
        /* Sobrescribir el 'justify-content' y 'align-items' por defecto */
        justify-content: flex-start;
    }
    
    .bot-card ul.availability-list li .day-name {
        /* "Lunes", "Martes", etc. */
        font-weight: 500;
        color: #FFFFFF; /* Blanco para el d√≠a */
        font-size: 1.05em; /* Un poco m√°s grande */
        margin-bottom: 6px;
    }
    
    .bot-card ul.availability-list li .time-available {
        /* "09:00, 09:30..." */
        font-size: 0.9em;
        color: #A0A0A0; /* Gris claro para las horas */
        line-height: 1.7; /* M√°s espacio entre l√≠neas si se envuelve */
        word-wrap: break-word; /* Asegura que se envuelva bien */
        font-family: monospace; /* Opcional: para que los n√∫meros se alineen bien */
    }

    .bot-card ul.availability-list li .time-closed {
        /* "Cerrado" */
        font-size: 0.9em;
        color: #F44336; /* Rojo para "Cerrado" */
        font-weight: 500;
    }
    /* --- FIN: Mejora Est√©tica Horario de Atenci√≥n --- */

</style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header" id="chatHeader">
            <div id="header-title">
                <h1>üíà BarberConnect</h1>
                <p>Portal del Cliente</p>
            </div>
            <div class="header-icons">
                <div class="icon-wrapper" id="messagesIconWrapper" title="Ver mensajes">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 10H6v-2h12v2zm0-4H6V6h12v2z"></path></svg>
                    <span class="notification-badge" id="notificationBadge"></span>
                </div>
            </div>
        </div>
        <div class="messages-container" id="messagesContainer"></div>
        <div class="input-container">
            <button class="menu-button" id="menuButton" title="Volver al Men√∫">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 18h16v-2H4v2zm0-5h16v-2H4v2zm0-7v2h16V6H4z"></path></svg>
            </button>
            <input type="text" class="message-input" id="messageInput" placeholder="Escribe un mensaje...">
            <button class="send-button" id="sendButton">‚û§</button>
        </div>
    </div>

    <input type="file" id="clientPicInput" accept="image/png, image/jpeg" style="display: none;">

    <script>
        const SUPABASE_URL = 'https://olkjevlkqdafbhuiszfz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sa2pldmxrcWRhZmJodWlzemZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNzc5ODcsImV4cCI6MjA3NDg1Mzk4N30.5V7LTjITA3szqyNxUy67K0r1IhaB9MpnxSML7IygYcM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        class ClientChatApp {
            constructor() {
                this.currentFlow = 'init';
                this.barberData = null;
                this.clientProfile = null;
                this.bookingData = {};
                this.profileUpdateData = {}; 
                this.isTyping = false;
                
                this.chatId = null;
                this.chatSubscription = null;
                this.notificationSubscription = null;
                this.qrScanner = null;
                this.paymentDataToConfirm = null;
                
                this.unreadCount = 0;

                this.messagesContainer = document.getElementById('messagesContainer');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.chatHeader = document.getElementById('chatHeader');
                this.notificationBadge = document.getElementById('notificationBadge');
                this.messagesIconWrapper = document.getElementById('messagesIconWrapper');
                this.menuButton = document.getElementById('menuButton'); 
                
                this.clientPicInput = null; 

                this.mainMenuButton = `<div class="command-buttons-container" style="margin-top: 15px;"><button class="command-button" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button></div>`;

                this.init();
            }

            async init() {
                this.sendButton.addEventListener('click', () => this.handleSend());
                this.messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.handleSend(); });
                this.messagesContainer.addEventListener('click', this.handleButtonClick.bind(this));
                
                this.messagesIconWrapper.addEventListener('click', () => {
                    if (this.unreadCount > 0) {
                        this.enterLiveChatMode();
                    }
                });
                
                this.menuButton.addEventListener('click', () => this.handleMenuButton());
                
                this.clientPicInput = document.getElementById('clientPicInput');
                this.clientPicInput.addEventListener('change', (event) => this.uploadClientPicture(event));

                await this.checkConnection();
            }
            
            /**
             * INICIO: Nueva funci√≥n para formatear precios seg√∫n la moneda del BARBERO.
             */
            formatCurrency(amount, code)  {
                // Usa un c√≥digo espec√≠fico si se pasa, o el del perfil del BARBERO, o 'USD'
                const  currencyCode = code ||  this.barberData?.currency_code ||  'USD' ;
                const  numAmount =  parseFloat(amount ||  0 ).toFixed( 2 );
                
                // Usamos los formatos que pediste
                switch (currencyCode.toUpperCase()) {
                    case   'USD' :  // D√≥lar Americano
                        return   `$${numAmount}` ;
                    case   'VES' :  // Bol√≠var Venezolano
                        return   `${numAmount} Bs.` ;
                    case   'COP' :  // Peso Colombiano
                        return   `$${numAmount} COP` ;
                    case   'PEN' :  // Sol Peruano
                        return   `S/${numAmount}` ;
                    default :     // Fallback por si acaso
                        return   `$${numAmount}` ;
                }
            }
            // FIN: Nueva funci√≥n

            /**
             * INICIO: Nueva funci√≥n para formatear horas (Mejora 30min)
             * Convierte un n√∫mero (ej: 9.5) a un string (ej: "09:30")
             */
            formatTime(hourFloat) {
                const hour = Math.floor(hourFloat);
                const minutes = (hourFloat % 1) * 60;
                const formattedHour = String(hour).padStart(2, '0');
                const formattedMinutes = String(minutes).padStart(2, '0');
                return `${formattedHour}:${formattedMinutes}`;
            }
            // FIN: Nueva funci√≥n

            // --- INICIO: L√ìGICA PARA NOTIFICACIONES PUSH ---
            /**
             * Pide permiso al usuario para enviar notificaciones y lo suscribe.
             */
            async registerServiceWorker() {
                if (!('Notification' in window) || !('serviceWorker' in navigator)) {
                    this.addBotMessage('<div class="bot-card"><p>‚ùå Tu navegador no es compatible con las notificaciones.</p></div>');
                    return;
                }

                const currentPermission = Notification.permission;
                if (currentPermission === 'granted') {
                    this.addBotMessage('<div class="bot-card"><p>‚úÖ ¬°Las notificaciones ya est√°n activas!</p></div>');
                    return;
                }
                if (currentPermission === 'denied') {
                    this.addBotMessage('<div class="bot-card"><p>üö´ Has bloqueado las notificaciones. Debes activarlas en la configuraci√≥n de tu navegador.</p></div>');
                    return;
                }

                this.showTyping();
                try {
                    const swRegistration = await navigator.serviceWorker.ready;
                    const permissionResult = await window.Notification.requestPermission();

                    if (permissionResult !== 'granted') {
                        this.hideTyping();
                        this.addBotMessage('<div class="bot-card"><p>‚ö†Ô∏è Permiso denegado. No recibir√°s notificaciones.</p></div>');
                        return;
                    }

                    // Reemplaza esta clave con tu CLAVE P√öBLICA VAPID
                    const vapidPublicKey = 'BJCOJ2WGEu7_29mhcE56t5zkmkmO2phKSVEELfWjTVe1RtmeZOZ5LWZfMyNWpWo7q7jNhBqezFf5MQFNq9NYSqA'; 
                    const pushSubscription = await swRegistration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: this.urlBase64ToUint8Array(vapidPublicKey)
                    });

                    await this.savePushSubscription(pushSubscription);
                } catch (error) {
                    console.error("Error durante el registro de notificaciones:", error);
                    this.addBotMessage(`<div class="bot-card"><p>‚ùå Hubo un error al activar las notificaciones: ${error.message}</p></div>`);
                } finally {
                    this.hideTyping();
                }
            }

            /**
             * Guarda la suscripci√≥n en la base de datos para el cliente actual.
             */
            async savePushSubscription(subscription) {
                if (!this.clientProfile || !this.clientProfile.id) {
                    this.addBotMessage('<div class="bot-card"><p>Error cr√≠tico: No pude identificarte. Intenta recargar.</p></div>');
                    return;
                }
                
                const { error } = await supabase
                  .from('clients')
                  .update({ push_subscription: subscription })
                  .eq('id', this.clientProfile.id);

                if (error) {
                    console.error("Fallo al guardar la suscripci√≥n:", error);
                    this.addBotMessage(`<div class="bot-card"><p>‚ùå Error en la base de datos al guardar la configuraci√≥n.<br><small>${error.message}</small></p></div>`);
                } else {
                    this.addBotMessage('<div class="bot-card" style="border-left: 4px solid #4CAF50;"><p><strong>¬°Listo! ‚úÖ</strong> Recibir√°s notificaciones de nuevos mensajes.</p></div>');
                }
            }
            
            /**
             * Helper para convertir la clave VAPID.
             */
            urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) {
                  outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }
            // --- FIN: L√ìGICA PARA NOTIFICACIONES PUSH ---

            handleMenuButton() {
                if (this.currentFlow !== 'live_chat') return; 

                if (this.chatSubscription) {
                    this.chatSubscription.unsubscribe();
                    this.chatSubscription = null;
                }
                
                this.messagesContainer.innerHTML = '';
                this.menuButton.classList.remove('visible');
                this.showClientMainMenu();
                this.subscribeToNotifications();
            }

            updateNotificationBadge() {
                if (this.unreadCount > 0) {
                    this.notificationBadge.textContent = this.unreadCount > 9 ? '9+' : this.unreadCount;
                    this.notificationBadge.classList.add('visible');
                } else {
                    this.notificationBadge.classList.remove('visible');
                }
            }

            resetUnreadCount() {
                this.unreadCount = 0;
                this.updateNotificationBadge();
            }

            subscribeToNotifications() {
                if (!this.chatId || this.notificationSubscription) return;

                this.notificationSubscription = supabase
                    .channel(`client_notifications_${this.chatId}`)
                    .on('postgres_changes', {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'messages',
                        filter: `chat_id=eq.${this.chatId}`
                    }, (payload) => {
                        if (payload.new.sender_type === 'barber' && this.currentFlow !== 'live_chat') {
                            this.unreadCount++;
                            this.updateNotificationBadge();
                        }
                    })
                    .subscribe();
            }

            async handleButtonClick(event) {
                const button = event.target.closest('.command-button, .edit-icon-button');
                if (!button || button.disabled) return;
                
                const container = button.closest('.command-buttons-container');
                if (container && !button.closest('.return-menu')) {
                   container.querySelectorAll('.command-button').forEach(btn => {
                       btn.disabled = true;
                       btn.style.cursor = 'not-allowed';
                       btn.style.backgroundColor = '#e9ecef';
                   });
                }
                
                const command = button.dataset.command;
                
                if(command === '/editar_client_name') {
                    await this.processUserInput(command);
                    return;
                }

                this.addUserMessage(button.textContent.trim());
                await this.processUserInput(command);
            }

            async handleSend() {
                const text = this.messageInput.value.trim();
                if (!text || this.isTyping) return;
                this.messageInput.value = '';
                
                if (this.currentFlow === 'live_chat') {
                    this.sendRealtimeMessage(text);
                } else {
                    this.addUserMessage(text);
                    await this.processUserInput(text.toLowerCase());
                }
            }
            
            async processUserInput(input) {
                if (this.qrScanner) {
                    await this.qrScanner.stop().catch(e => console.log("Scanner already stopped."));
                    this.qrScanner = null;
                }
                
               if (this.currentFlow === 'live_chat') {
                    if (input === 'menu') { 
                        this.handleMenuButton();
                    }
                    return;
                }

                this.showTyping();
                await new Promise(resolve => setTimeout(resolve, 600));
                this.hideTyping();

                if (input === 'menu') {
                    this.bookingData = {}; 
                    this.profileUpdateData = {};
                    this.showClientMainMenu();
                    return;
                }

                if (input.startsWith('seleccionar_barbero:')) {
                    const barberName = input.split(':')[1];
                    this.bookingData.barberName = barberName;
                    await this.showServicesForBooking();
                    return;
                }

                if (this.currentFlow === 'awaiting_code') {
                    await this.handleCodeEntry(input);
                    return; 
                }

                if (this.currentFlow === 'awaiting_phone') {
                    await this.findOrCreateClientByPhone(input);
                    return; 
                }

                switch (this.currentFlow) {
                    case 'booking_date':
                        await this.handleDateSelection(input);
                        return;
                    case 'booking_time':
                        await this.handleTimeSelection(input);
                        return;
                    case 'booking_confirmation':
                         if (input === 'confirmar_reserva') {
                            await this.confirmAndCreateBooking();
                         } else {
                            this.addBotMessage(`<div class="bot-card"><p>Reserva cancelada.</p></div>`);
                            this.showClientMainMenu();
                         }
                        return;
                    case 'editing_profile_firstname':
                        this.profileUpdateData.firstName = input;
                        this.addBotMessage(`<div class="bot-card"><p>¬°Entendido, ${input}!</p><p>Ahora, por favor, dime tu apellido.</p>${this.mainMenuButton}</div>`);
                        this.currentFlow = 'editing_profile_lastname';
                        return;
                    case 'editing_profile_lastname':
                        this.profileUpdateData.lastName = input;
                        await this.updateClientProfile();
                        return;
                }
                
                if (input.startsWith('reservar_servicio:')) {
                    const serviceName = input.split(':')[1];
                    const barberServices = this.barberData.services[this.bookingData.barberName] || [];
                    this.bookingData.service = barberServices.find(s => s.name === serviceName);
                    this.addBotMessage(`<div class="bot-card"><p>Has seleccionado: <strong>${this.bookingData.service.name}</strong> (${this.formatCurrency(this.bookingData.service.price)}).</p><p>Por favor, elige una fecha (p. ej., "hoy", "ma√±ana" o "25/12"):</p>${this.mainMenuButton}</div>`);
                    this.currentFlow = 'booking_date';
                    return;
                }

                switch (input) {
                    case '/servicios': await this.showServices(); break;
                    case '/horario': await this.showAvailability(); break;
                    case '/reservar': await this.startBookingFlow(); break;
                    case '/hablar': await this.enterLiveChatMode(); break;
                    case '/miperfil': await this.startProfileEditFlow(); break;
                    case '/pagar_qr': await this.startQRScanner(); break;
                    case '/suscribirse_notificaciones': await this.registerServiceWorker(); break; // Manejar el nuevo comando
                    case '/editar_client_name':
                        this.addBotMessage(`<div class="bot-card"><p>Tu nombre actual es <strong>${this.clientProfile.first_name}</strong>.</p><p>Por favor, escribe tu nuevo nombre.</p>${this.mainMenuButton}</div>`);
                        this.currentFlow = 'editing_profile_firstname';
                        break;
                    case 'menu': this.showClientMainMenu(); break;
                    default:
                        this.addBotMessage(`<div class="bot-card"><p>Actualmente, no puedo responder de manera natural. Sin embargo, puedes explorar utilizando los botones del men√∫. üòÄ</p></div>`);
                        this.showClientMainMenu();
                        break;
                }
            }

            async startQRScanner() {
                const scannerHTML = `
                <div class="bot-card">
                    <h3>Escanear C√≥digo QR</h3>
                    <p>Apunta la c√°mara al c√≥digo QR que te muestre tu barbero.</p>
                    <div id="qr-reader"></div>
                    <div class="command-buttons-container" style="margin-top: 15px;">
                        <button class="command-button return full-width" data-command="menu">Cancelar</button>
                    </div>
                </div>`;
                this.addBotMessage(scannerHTML);

                await new Promise(resolve => setTimeout(resolve, 100));

                const html5QrCode = new Html5Qrcode("qr-reader");
                this.qrScanner = html5QrCode; 
                
                const qrCodeSuccessCallback = async (decodedText, decodedResult) => {
                    if (this.qrScanner) {
                        await this.qrScanner.stop();
                        this.qrScanner = null;
                        await this.handleScannedQRCode(decodedText);
                    }
                };

                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                    .catch(err => {
                        console.error("Error al iniciar el escaner QR", err)
                        this.addBotMessage(`<div class="bot-card"><p>‚ùå No se pudo iniciar la c√°mara. Aseg√∫rate de dar los permisos necesarios.</p></div>`);
                        this.showClientMainMenu();
                    });
            }

            async handleScannedQRCode(qrDataString) {
                try {
                    const paymentData = JSON.parse(qrDataString);
                    if (paymentData.barber_id !== this.barberData.id) {
                        this.addBotMessage(`<div class="bot-card"><p>‚ö†Ô∏è <strong>Error:</strong> Este c√≥digo QR no pertenece a ${this.barberData.barber_shop_name}.</p></div>`);
                        this.showClientMainMenu();
                        return;
                    }

                    this.paymentDataToConfirm = paymentData;

                    // --- INICIO: ACTUALIZACI√ìN DE MONEDA (B.4) ---
                    const confirmationHTML = `
                    <div class="bot-card">
                        <h3>Confirmar Pago</h3>
                        <p>Est√°s a punto de registrar un pago para <strong>${this.barberData.barber_shop_name}</strong>.</p>
                        <ul>
                            <li><strong>Monto:</strong> ${this.formatCurrency(paymentData.amount, paymentData.currency)}</li>
                            <li><strong>Por:</strong> ${paymentData.description}</li>
                            <li><strong>Atendido por:</strong> ${paymentData.performer}</li>
                        </ul>
                        <p class="helper-text">Recuerda realizar el pago por tu m√©todo preferido (efectivo, transferencia, etc). Esto solo registra la transacci√≥n.</p>
                        <div class="command-buttons-container">
                            <button class="command-button confirm" onclick="app.confirmAndProcessPayment()">‚úÖ S√≠, Confirmar Pago</button>
                            <button class="command-button cancel" data-command="menu">‚ùå Cancelar</button>
                        </div>
                    </div>`;
                    // --- FIN: ACTUALIZACI√ìN DE MONEDA (B.4) ---
                    this.addBotMessage(confirmationHTML);

                } catch (error) {
                    this.addBotMessage(`<div class="bot-card"><p>‚ùå <strong>C√≥digo QR no v√°lido.</strong> No pude leer la informaci√≥n de pago.</p></div>`);
                    this.showClientMainMenu();
                }
            }

            async confirmAndProcessPayment() {
                if (!this.paymentDataToConfirm) return;
                
                this.addUserMessage("S√≠, Confirmar Pago");
                this.showTyping();

                // --- INICIO: ACTUALIZACI√ìN DE MONEDA (C.2) ---
                const { amount, description, performer, currency } = this.paymentDataToConfirm; // <-- Extraer 'currency'

                const { error: transactionError } = await supabase
                    .from('transactions')
                    .insert({
                        barber_id: this.barberData.id,
                        client_id: this.clientProfile.id,
                        amount: amount,
                        description: description,
                        barber_name_performer: performer,
                        currency: currency || 'USD'   // <-- A√ëADIR ESTO
                    });
                // --- FIN: ACTUALIZACI√ìN DE MONEDA (C.2) ---

                if (transactionError) {
                    this.hideTyping();
                    this.addBotMessage(`<div class="bot-card"><p>‚ùå Hubo un error al registrar la transacci√≥n.</p></div>`);
                    console.error("Error inserting transaction:", transactionError);
                    this.showClientMainMenu();
                    return;
                }

                const { error: rpcError } = await supabase.rpc('increment_barber_balance', {
                    barber_id_in: this.barberData.id,
                    amount_in: parseFloat(amount)
                });

                this.hideTyping();

                if (rpcError) {
                    this.addBotMessage(`<div class="bot-card"><p>‚ùå Hubo un error al actualizar el saldo del barbero.</p></div>`);
                    console.error("Error calling RPC:", rpcError);
                } else {
                    this.addBotMessage(`<div class="bot-card"><p>‚úÖ <strong>¬°Pago registrado con √©xito!</strong> Gracias.</p></div>`);
                }
                
                this.paymentDataToConfirm = null;
                setTimeout(() => this.showClientMainMenu(), 2000);
            }
            
            async startProfileEditFlow() {
                this.showTyping();
                
                const { data: profile, error } = await supabase
                    .from('clients')
                    .select('*')
                    .eq('id', this.clientProfile.id)
                    .single();
                
                this.hideTyping();
                
                if(error) {
                    this.addBotMessage('<div class="bot-card"><p>‚ùå No pude cargar tu perfil. Intenta de nuevo.</p></div>');
                    return;
                }
                
                this.clientProfile = profile; 
                
                let avatarHTML = '';
                if (profile.avatar_url) {
                    avatarHTML = `<div class="profile-avatar"><img src="${profile.avatar_url}" alt="Foto de Perfil"></div>`;
                } else {
                    const initial = profile.first_name ? profile.first_name.charAt(0).toUpperCase() : 'C';
                    avatarHTML = `<div class="profile-avatar"><span>${initial}</span></div>`;
                }

                let photoButtonsHTML = '';
                if (profile.avatar_url) {
                    photoButtonsHTML = `
                        <button class="command-button" onclick="app.triggerClientFileUpload()">‚úèÔ∏è Editar Foto</button>
                        <button class="command-button cancel" onclick="app.deleteClientPicture()">üóëÔ∏è Eliminar Foto</button>
                    `;
                } else {
                    photoButtonsHTML = `
                        <button class="command-button full-width confirm" onclick="app.triggerClientFileUpload()">üì∏ Subir Foto de Perfil</button>
                    `;
                }

                const profileHTML = `
                <div class="bot-card">
                    <h3>üë§ Mi Perfil</h3>
                    <div class="profile-avatar-wrapper">${avatarHTML}</div>
            
                    <div class="command-buttons-container" style="margin-bottom: 15px; grid-template-columns: 1fr 1fr;">
                        ${photoButtonsHTML}
                    </div>
            
                    <ul>
                        <li style="display: flex; align-items: center;">
                            <span class="item-name">Nombre:</span>
                            <span class="item-detail" style="margin-left: 1rem; text-align: left;">${profile.first_name} ${profile.last_name}</span>
                            <button class="edit-icon-button" data-command="/editar_client_name" style="margin-left: auto;" title="Editar nombre">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg>
                            </button>
                        </li>
                        <li><span class="item-name">Tel√©fono:</span><span class="item-detail">${profile.phone_number}</span></li>
                    </ul>
            
                    <div class="command-buttons-container" style="margin-top: 10px;">
                        <button class="command-button full-width" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button>
                    </div>
                </div>`;
                
                this.addBotMessage(profileHTML);
                this.currentFlow = 'profile_menu';
            }

            async updateClientProfile() {
                this.showTyping();
                const { firstName, lastName } = this.profileUpdateData;

                const { data: updatedClient, error } = await supabase
                    .from('clients')
                    .update({ first_name: firstName, last_name: lastName })
                    .eq('id', this.clientProfile.id)
                    .select()
                    .single();

                this.hideTyping();

                if (error) {
                    console.error("Error updating profile:", error);
                    this.addBotMessage(`<div class="bot-card"><p>‚ùå Hubo un error al actualizar tu perfil.</p>${this.mainMenuButton}</div>`);
                } else {
                    this.clientProfile = updatedClient;
                    this.addBotMessage(`<div class="bot-card"><p>‚úÖ ¬°Perfecto, ${firstName}! Tu perfil ha sido actualizado.</p></div>`);
                }

                this.profileUpdateData = {};
                this.currentFlow = 'authenticated';
                setTimeout(() => this.startProfileEditFlow(), 1000);
            }
            
            triggerClientFileUpload() {
                this.clientPicInput.click();
            }
            
            async uploadClientPicture(event) {
                const file = event.target.files[0];
                if (!file) return;

                const fileTypes = ['image/png', 'image/jpeg'];
                if (!fileTypes.includes(file.type)) {
                    this.addBotMessage(`<div class="bot-card" style="border-color: #F44336;"><p>‚ùå <strong>Formato no v√°lido.</strong><br>Por favor, sube una imagen PNG o JPG.</p></div>`);
                    return;
                }
                if (file.size > 2 * 1024 * 1024) { // L√≠mite de 2MB
                    this.addBotMessage(`<div class="bot-card" style="border-color: #F44336;"><p>‚ùå <strong>Imagen muy grande.</strong><br>El l√≠mite es de 2 MB.</p></div>`);
                    return;
                }
                
                this.addBotMessage('<div class="bot-card"><p>Subiendo foto, por favor espera... ‚è≥</p></div>');
                this.showTyping();
                
                const bucketName = 'client_pictures';
                const filePath = `${this.clientProfile.id}/profile.png`; 

                try {
                    const { error: uploadError } = await supabase.storage
                        .from(bucketName)
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: true,
                        });

                    if (uploadError) {
                        console.error("Error en Subida (Storage):", uploadError);
                        throw new Error(`Error de Storage: ${uploadError.message}`);
                    }

                    const { data: urlData } = supabase.storage
                        .from(bucketName)
                        .getPublicUrl(filePath);
                        
                    const publicURLWithCacheBuster = `${urlData.publicUrl}?t=${new Date().getTime()}`;

                    const { data: updatedProfile, error: dbError } = await supabase
                        .from('clients')
                        .update({ avatar_url: publicURLWithCacheBuster })
                        .eq('id', this.clientProfile.id)
                        .select()
                        .single();

                    if (dbError) {
                        console.error("Error en Actualizaci√≥n (DB):", dbError);
                        throw new Error(`Error de Base de Datos: ${dbError.message}`);
                    }

                    this.clientProfile = updatedProfile;
                    this.addBotMessage('<div class="bot-card"><p>‚úÖ ¬°Foto de perfil actualizada con √©xito!</p></div>');
                    
                } catch (error) {
                    console.error("Error subiendo la foto:", error);
                    this.addBotMessage(`<div class="bot-card" style="background-color: #ffdddd; color: #D8000C;">
                        <p><strong>‚ùå Hubo un error al subir tu foto:</strong><br><small>${error.message}</small></p>
                        <p class="helper-text">Por favor, int√©ntalo de nuevo. Si el error persiste, contacta al barbero.</p>
                    </div>`);
                } finally {
                    this.hideTyping();
                    this.clientPicInput.value = '';
                    await this.startProfileEditFlow();
                }
            }
            
            async deleteClientPicture() {
                if (!confirm("¬øEst√°s seguro de que quieres eliminar tu foto de perfil?")) return;

                this.addBotMessage('<div class="bot-card"><p>Eliminando foto...</p></div>');
                this.showTyping();
                
                const bucketName = 'client_pictures';
                const filePath = `${this.clientProfile.id}/profile.png`;

                try {
                    const { error: removeError } = await supabase.storage
                        .from(bucketName)
                        .remove([filePath]);
                    
                    if (removeError && removeError.message !== 'The resource was not found') {
                         console.error("Error borrando de Storage:", removeError);
                         throw new Error(`Error de Storage: ${removeError.message}`);
                    }

                    const { data: updatedProfile, error: dbError } = await supabase
                        .from('clients')
                        .update({ avatar_url: null })
                        .eq('id', this.clientProfile.id)
                        .select()
                        .single();

                    if (dbError) {
                        console.error("Error actualizando DB:", dbError);
                        throw new Error(`Error de Base de Datos: ${dbError.message}`);
                    }

                    this.clientProfile = updatedProfile;
                    this.addBotMessage('<div class="bot-card"><p>‚úÖ Foto eliminada correctamente.</p></div>');

                } catch (error) {
                    console.error("Error eliminando la foto:", error);
                    this.addBotMessage(`<div class="bot-card" style="background-color: #ffdddd; color: #D8000C;">
                        <p><strong>‚ùå Hubo un error al eliminar tu foto:</strong><br><small>${error.message}</small></p>
                    </div>`);
                } finally {
                    this.hideTyping();
                    await this.startProfileEditFlow();
                }
            }

            parseDateInput(input) {
                const now = new Date();
                now.setHours(0, 0, 0, 0);

                if (input === 'hoy') return now;
                if (input === 'ma√±ana') {
                    now.setDate(now.getDate() + 1);
                    return now;
                }
                const parts = input.match(/^(\d{1,2})[\/\-](\d{1,2})$/);
                if (parts) {
                    const day = parseInt(parts[1], 10);
                    const month = parseInt(parts[2], 10) - 1;
                    const year = now.getFullYear();
                    const date = new Date(year, month, day);
                    if (date < now) date.setFullYear(year + 1);
                    return date;
                }
                return null;
            }

            async handleDateSelection(input) {
                const selectedDate = this.parseDateInput(input);

                if (!selectedDate || selectedDate < new Date().setHours(0, 0, 0, 0)) {
                    this.addBotMessage(`<div class="bot-card"><p>‚ùå Fecha no v√°lida. Int√©ntalo de nuevo (p. ej., "hoy", "ma√±ana" o "25/12").</p>${this.mainMenuButton}</div>`);
                    return;
                }

                this.bookingData.date = selectedDate;
                
                this.showTyping();
                await this.showAvailableTimesForDate(selectedDate);
                this.hideTyping();
            }
            
            async showAvailableTimesForDate(date) {
                const dayMapping = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                const dayKey = dayMapping[date.getDay()];
                const barberSchedule = this.barberData.availability[this.bookingData.barberName][dayKey] || [];

                if (barberSchedule.length === 0) {
                    this.addBotMessage(`<div class="bot-card"><p>‚ùå ${this.bookingData.barberName} no trabaja el ${date.toLocaleDateString()}. Por favor, elige otra fecha.</p>${this.mainMenuButton}</div>`);
                    this.currentFlow = 'booking_date';
                    return;
                }

                const startOfDay = new Date(date); startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(date); endOfDay.setHours(23, 59, 59, 999);

                const { data: existingBookings, error } = await supabase.from('bookings').select('booking_date').eq('barber_id', this.barberData.id).in('status', ['pending', 'confirmed']).gte('booking_date', startOfDay.toISOString()).lte('booking_date', endOfDay.toISOString());

                if (error) {
                    this.addBotMessage(`<div class="bot-card"><p>‚ö†Ô∏è Error al verificar disponibilidad.</p>${this.mainMenuButton}</div>`);
                    this.showClientMainMenu();
                    return;
                }
                
                // --- INICIO: MODIFICACI√ìN 30 MINUTOS ---
                // Convertimos las horas de las reservas a formato float (ej: 9:30 -> 9.5)
                const bookedSlots = existingBookings.map(b => {
                    const d = new Date(b.booking_date);
                    return d.getHours() + (d.getMinutes() / 60.0);
                });

                // El horario del barbero (barberSchedule) ya viene con floats (ej: [9, 9.5, 10])
                let availableSlots = barberSchedule.filter(slot => !bookedSlots.includes(slot));
                
                const now = new Date();
                const isToday = date.toDateString() === now.toDateString();

                if (isToday) {
                    const currentHourFloat = now.getHours() + (now.getMinutes() / 60.0);
                    // Filtramos para que solo muestre horas que est√°n en el futuro
                    availableSlots = availableSlots.filter(slot => slot > currentHourFloat);
                }
                
                if (availableSlots.length === 0) {
                    this.addBotMessage(`<div class="bot-card"><p>‚ùå <strong>No hay cupos disponibles</strong> para el ${date.toLocaleDateString()}.</p><p>Por favor, elige otra fecha.</p>${this.mainMenuButton}</div>`);
                    this.currentFlow = 'booking_date';
                    return;
                }

                const timeButtons = availableSlots.map(slot => {
                    const timeString = this.formatTime(slot);
                    // El comando ahora solo pasa el valor flotante (ej: 9.5)
                    return `<button class="command-button" data-command="reservar_hora:${slot}">${timeString}</button>`;
                }).join('');
                // --- FIN: MODIFICACI√ìN 30 MINUTOS ---

                this.addBotMessage(`<div class="bot-card"><h3>‚è∞ Horas disponibles para el ${date.toLocaleDateString()}</h3><div class="command-buttons-container">${timeButtons}<button class="command-button" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button></div></div>`);
                this.currentFlow = 'booking_time';
            }

            async handleTimeSelection(input) {
                if (!input.startsWith('reservar_hora:')) {
                    this.addBotMessage(`<div class="bot-card"><p>Selecci√≥n no v√°lida. Por favor, usa uno de los botones.</p>${this.mainMenuButton}</div>`);
                    await this.showAvailableTimesForDate(this.bookingData.date);
                    return;
                }

                const timeSlotFloatString = input.split(':')[1]; // Esto ser√° "9" o "9.5"
                
                // --- INICIO: MODIFICACI√ìN 30 MINUTOS ---
                const finalTimestamp = new Date(this.bookingData.date);
                const slotFloat = parseFloat(timeSlotFloatString);
                const hour = Math.floor(slotFloat);
                const minutes = (slotFloat % 1) * 60;
                
                finalTimestamp.setHours(hour, minutes, 0, 0);
                // --- FIN: MODIFICACI√ìN 30 MINUTOS ---

                this.bookingData.finalTimestamp = finalTimestamp;
                
                // --- INICIO: ACTUALIZACI√ìN DE MONEDA (B.3) ---
                const confirmationHTML = `<div class="bot-card"><h3>Confirmar Reserva</h3><p>Por favor, revisa los detalles de tu cita:</p><ul><li><strong>Barbero:</strong> ${this.bookingData.barberName}</li><li><strong>Servicio:</strong> ${this.bookingData.service.name}</li><li><strong>Precio:</strong> ${this.formatCurrency(this.bookingData.service.price)}</li><li><strong>Fecha:</strong> ${finalTimestamp.toLocaleDateString()}</li><li><strong>Hora:</strong> ${finalTimestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</li></ul><div class="command-buttons-container"><button class="command-button confirm" data-command="confirmar_reserva">‚úÖ Confirmar</button><button class="command-button cancel" data-command="cancelar_reserva">‚ùå Cancelar</button></div></div>`;
                // --- FIN: ACTUALIZACI√ìN DE MONEDA (B.3) ---
                this.addBotMessage(confirmationHTML);
                this.currentFlow = 'booking_confirmation';
            }
            
            async confirmAndCreateBooking() {
                this.showTyping();
                
                // --- INICIO: ACTUALIZACI√ìN DE MONEDA (C.1) ---
                const payload = { 
                    barber_id: this.barberData.id, 
                    client_id: this.clientProfile.id, 
                    service_name: this.bookingData.service.name, 
                    price: this.bookingData.service.price, 
                    currency: this.barberData?.currency_code || 'USD', // <-- A√ëADIDO
                    booking_date: this.bookingData.finalTimestamp.toISOString(), 
                    status: 'confirmed', 
                    barber_name: this.bookingData.barberName 
                };
                // --- FIN: ACTUALIZACI√ìN DE MONEDA (C.1) ---

                const { error } = await supabase.from('bookings').insert(payload);
                
                this.hideTyping();
                
                if (error) {
                    console.error('Error al crear la reserva en Supabase:', error);
                    this.addBotMessage(`<div class="bot-card"><p>Lo siento, ocurri√≥ un error al crear tu reserva. <br><small>Detalle: ${error.message}</small></p>${this.mainMenuButton}</div>`);
                } else {
                    this.addBotMessage('<div class="bot-card"><p>‚úÖ ¬°Tu reserva ha sido confirmada con √©xito!</p></div>');
                }
                this.bookingData = {};
                setTimeout(() => this.showClientMainMenu(), 1500);
            }

            async checkConnection() {
                const storedCode = localStorage.getItem('barber_code');
                const clientId = localStorage.getItem('client_id');

                if (storedCode && clientId) {
                    this.showTyping();
                    const { data: barber, error: barberError } = await supabase.from('barbers').select('*').eq('public_code', storedCode).single();
                    const { data: client, error: clientError } = await supabase.from('clients').select('*, avatar_url').eq('id', clientId).single();
                    this.hideTyping();
                    
                    if (barber && client) {
                        this.barberData = barber;
                        this.clientProfile = client;
                        await this.getOrCreateChatSession();
                        this.updateHeader();
                        this.addBotMessage(`<div class="bot-card"><h3>¬°Hola de nuevo, ${this.clientProfile.first_name}! üëã</h3><p>Est√°s conectado con <strong>${this.barberData.barber_shop_name}</strong>.</p></div>`);
                        this.showClientMainMenu();
                        this.subscribeToNotifications();
                    } else {
                        localStorage.clear();
                        this.promptForCode();
                    }
                } else {
                    this.promptForCode();
                }
            }

            promptForCode() {
                this.addBotMessage(`<div class="bot-card"><h3>¬°Bienvenido!</h3><p>Por favor, introduce el c√≥digo √∫nico de tu barbero para conectar.</p></div>`);
                this.currentFlow = 'awaiting_code';
                this.messageInput.placeholder = "Escribe el c√≥digo del barbero...";
            }

            async handleCodeEntry(code) {
                this.showTyping();
                const { data, error } = await supabase.from('barbers').select('*').eq('public_code', code.toUpperCase()).single();
                this.hideTyping();

                if (data && !error) {
                    this.barberData = data;
                    localStorage.setItem('barber_code', this.barberData.public_code);
                    
                    this.updateHeader();
                    this.addBotMessage(`<div class="bot-card">
                        <p>‚úÖ ¬°Conexi√≥n exitosa con <strong>${this.barberData.barber_shop_name}</strong>!</p>
                        <p>Para recuperar tu historial o crear tu perfil, por favor, introduce tu <strong>n√∫mero de tel√©fono</strong> (Ej: 04121234567).</p>
                    </div>`);
                    
                    this.currentFlow = 'awaiting_phone'; 
                    this.messageInput.placeholder = "Escribe tu n√∫mero de tel√©fono...";
                } else {
                    this.addBotMessage(`<div class="bot-card"><p>‚ùå C√≥digo no v√°lido. Por favor, int√©ntalo de nuevo.</p></div>`);
                }
            }

            async findOrCreateClientByPhone(phone) {
                this.showTyping();
                
                const { data: existingClient, error: findError } = await supabase
                    .from('clients')
                    .select('*, avatar_url')
                    .eq('linked_barber_id', this.barberData.id)
                    .eq('phone_number', phone)
                    .single(); 

                if (existingClient) {
                    this.hideTyping();
                    this.clientProfile = existingClient;
                    localStorage.setItem('client_id', this.clientProfile.id);

                    await this.getOrCreateChatSession();
                    this.updateHeader();
                    
                    this.addBotMessage(`<div class="bot-card"><h3>¬°Bienvenido de nuevo, ${this.clientProfile.first_name}! üëã</h3><p>Hemos recuperado tu historial con <strong>${this.barberData.barber_shop_name}</strong>.</p></div>`);
                    
                    this.showClientMainMenu();
                    this.subscribeToNotifications();

                } else {
                    const anonymousName = `An√≥nimo-${Math.random().toString(36).substring(2, 8)}`;
                    const { data: newClient, error: createError } = await supabase
                        .from('clients')
                        .insert({ 
                            first_name: 'Cliente', 
                            last_name: anonymousName, 
                            linked_barber_id: this.barberData.id,
                            phone_number: phone 
                        })
                        .select('*, avatar_url')
                        .single();
                    
                    this.hideTyping();

                    if (createError) {
                        console.error("Error creating client:", createError);
                        this.addBotMessage(`<div class="bot-card"><p>‚ùå Hubo un error al crear tu perfil. Es posible que ese tel√©fono ya est√© en uso. <br><small>${createError.message}</small></p></div>`);
                        this.promptForCode();
                        return;
                    }

                    this.clientProfile = newClient;
                    localStorage.setItem('client_id', this.clientProfile.id);

                    await this.getOrCreateChatSession();
                    this.updateHeader();

                    this.addBotMessage(`<div class="bot-card"><p>¬°Perfecto! Hemos creado tu perfil con el n√∫mero ${phone}.</p></div>`);
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    this.addBotMessage(`<div class="bot-card"><h3>üìù Completa tu Perfil</h3><p>Para una mejor atenci√≥n, ¬øcu√°l es tu <strong>nombre</strong>?</p>${this.mainMenuButton}</div>`);
                    this.currentFlow = 'editing_profile_firstname';
                    this.messageInput.placeholder = "Escribe tu nombre...";
                }
            }


            async getOrCreateChatSession() {
                if (!this.clientProfile) return;
                const { data, error } = await supabase.from('chats').select('id').eq('barber_id', this.barberData.id).eq('client_id', this.clientProfile.id).single();
                if (data) { this.chatId = data.id; } 
                else {
                    const { data: newChat, error: newChatError } = await supabase.from('chats').insert({ barber_id: this.barberData.id, client_id: this.clientProfile.id }).select('id').single();
                    if (newChat) this.chatId = newChat.id; else console.error("Error creating chat:", newChatError);
                }
            }

            updateHeader() {
                let avatarHTML = '';
                const shopName = this.barberData ? this.barberData.barber_shop_name : "BarberConnect";
                const avatarUrl = this.barberData ? this.barberData.avatar_url : null;
                const subTitle = this.barberData ? "Asistente de Citas" : "Portal del Cliente";

                if (avatarUrl) {
                    avatarHTML = `
                        <div class="profile-picture-container">
                            <img src="${avatarUrl}" alt="Perfil de ${shopName}" class="barber-profile-pic">
                        </div>`;
                } else {
                    const initial = shopName ? shopName.charAt(0).toUpperCase() : 'B';
                    avatarHTML = `
                        <div class="profile-picture-container" style="display:flex; align-items:center; justify-content:center; background-color:#FFB300; color:#121212; font-size: 1.8em; font-weight: bold;">
                           <span>${initial}</span>
                        </div>`;
                }

                this.chatHeader.innerHTML = `
                    ${avatarHTML}
                    <div id="header-title" style="margin-right: auto;">
                        <h1 style="font-size: 1.2em; margin: 0;">${shopName}</h1>
                        <p style="font-size: 0.8em; opacity: 0.9; margin: 0;">${subTitle}</p>
                    </div>
                    <div class="header-icons">
                        <div class="icon-wrapper" id="messagesIconWrapper" title="Ver mensajes">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 10H6v-2h12v2zm0-4H6V6h12v2z"></path></svg>
                            <span class="notification-badge" id="notificationBadge"></span>
                        </div>
                    </div>`;
                
                this.notificationBadge = document.getElementById('notificationBadge');
                this.messagesIconWrapper = document.getElementById('messagesIconWrapper');
                this.messagesIconWrapper.addEventListener('click', () => {
                    if (this.unreadCount > 0) this.enterLiveChatMode();
                });
            }
            
            showClientMainMenu() {
                const menuHTML = `<div class="bot-card"><h3>Men√∫ Principal</h3><p>¬øC√≥mo puedo ayudarte hoy?</p><div class="command-buttons-container">
                <button class="command-button" data-command="/reservar">üìÖ Hacer una Reserva</button>
                <button class="command-button" data-command="/servicios">üõ†Ô∏è Ver Servicios</button>
                <button class="command-button" data-command="/horario">‚è∞ Ver Horario</button>
                <button class="command-button" data-command="/miperfil">üë§ Mi Perfil</button>
                <button class="command-button" data-command="/hablar">üí¨ Hablar con el Barbero</button>
                <button class="command-button" data-command="/suscribirse_notificaciones">üîî Activar Notificaciones</button>
                <button class="command-button full-width" style="background-color: #4CAF50; color: white;" data-command="/pagar_qr">üì≤ Pagar con QR</button>
                </div></div>`;
                this.addBotMessage(menuHTML);
                this.currentFlow = 'main_menu';
                this.messageInput.placeholder = "Usa los botones o escribe 'menu'";
            }

            async showServicesForBooking() {
                const barberServices = this.barberData.services[this.bookingData.barberName] || [];
                
                if (barberServices.length === 0) {
                    this.addBotMessage(`<div class="bot-card"><p>Lo siento, ${this.bookingData.barberName} no tiene servicios disponibles para reservar.</p>${this.mainMenuButton}</div>`);
                    this.showClientMainMenu();
                    return;
                }

                // --- INICIO: ACTUALIZACI√ìN DE MONEDA (B.2) ---
                const buttonsHTML = barberServices.map(s => `<button class="command-button" data-command="reservar_servicio:${s.name}">${s.name} (${this.formatCurrency(s.price)})</button>`).join('');
                // --- FIN: ACTUALIZACI√ìN DE MONEDA (B.2) ---
                this.addBotMessage(`<div class="bot-card"><h3>Selecciona un servicio con ${this.bookingData.barberName}</h3><div class="command-buttons-container">${buttonsHTML}${this.mainMenuButton}</div></div>`);
                this.currentFlow = 'booking_service';
            }
            
            showServices() {
                let servicesHTML = '<p>Este barbero a√∫n no ha agregado servicios.</p>';
                if (this.barberData.services && Object.keys(this.barberData.services).length > 0) {
                    let allServices = [];
                    Object.values(this.barberData.services).forEach(serviceList => {
                        allServices = allServices.concat(serviceList);
                    });
                    // --- INICIO: ACTUALIZACI√ìN DE MONEDA (B.1) ---
                    servicesHTML = allServices.map(svc => `<li><span>${svc.name}</span><strong>${this.formatCurrency(svc.price)}</strong></li>`).join('');
                    // --- FIN: ACTUALIZACI√ìN DE MONEDA (B.1) ---
                }
                this.addBotMessage(`<div class="bot-card"><h3>üõ†Ô∏è Servicios Disponibles</h3><ul>${servicesHTML}</ul>${this.mainMenuButton}</div>`);
            }

            showAvailability() {
                const days = { mon: 'Lunes', tue: 'Martes', wed: 'Mi√©rcoles', thu: 'Jueves', fri: 'Viernes', sat: 'S√°bado', sun: 'Domingo' };
                let availabilityHTML = '';
                Object.keys(this.barberData.availability).forEach(barberName => {
                    availabilityHTML += `<h4>${barberName}</h4>`;
                    const schedule = this.barberData.availability[barberName];
                    let barberScheduleHTML = Object.keys(days).map(key => {
                        const hours = schedule[key] || [];
                        
                        // --- INICIO: MODIFICACI√ìN 30 MINUTOS (YA HECHA) ---
                        const timeRange = hours.length > 0 ? hours.map(h => this.formatTime(h)).join(', ') : 'Cerrado';
                        // --- FIN: MODIFICACI√ìN 30 MINUTOS ---

                        // --- INICIO: NUEVA MODIFICACI√ìN EST√âTICA ---
                        const timeClass = timeRange === 'Cerrado' ? 'time-closed' : 'time-available';
                        return `<li>
                                    <span class="day-name">${days[key]}</span>
                                    <span class="${timeClass}">${timeRange}</span>
                                </li>`;
                        // --- FIN: NUEVA MODIFICACI√ìN EST√âTICA ---
                    }).join('');
                    availabilityHTML += `<ul class="availability-list">${barberScheduleHTML}</ul>`; // <-- A√±adida esta clase
                });
                this.addBotMessage(`<div class="bot-card"><h3>‚è∞ Horario de Atenci√≥n</h3>${availabilityHTML}${this.mainMenuButton}</div>`);
            }

            async startBookingFlow() {
                if (!this.barberData.services) { 
                    this.addBotMessage(`<div class="bot-card"><p>Lo siento, no hay servicios disponibles para reservar.</p>${this.mainMenuButton}</div>`); 
                    return; 
                }
                
                const barbers = Object.keys(this.barberData.availability);

                if (barbers.length > 1) {
                    const barberButtons = barbers.map(name => 
                        `<button class="command-button" data-command="seleccionar_barbero:${name}">${name}</button>`
                    ).join('');
                    this.addBotMessage(`<div class="bot-card"><h3>Selecciona un barbero</h3><div class="command-buttons-container">${barberButtons}${this.mainMenuButton}</div></div>`);
                    this.currentFlow = 'booking_barber';
                } else {
                    this.bookingData.barberName = barbers[0];
                    await this.showServicesForBooking(); 
                }
            }
            
            async enterLiveChatMode() {
                if (this.notificationSubscription) {
                    this.notificationSubscription.unsubscribe();
                    this.notificationSubscription = null;
                }

                this.currentFlow = 'live_chat';
                this.messagesContainer.innerHTML = '';
                
                this.menuButton.classList.add('visible');
                this.messageInput.placeholder = "Escribe un mensaje al barbero...";
                this.addBotMessage('<div class="bot-card"><p>Ahora est√°s chateando directamente con tu barbero.</p></div>'); 

                this.resetUnreadCount();

                const { data: messages, error } = await supabase.from('messages').select('*').eq('chat_id', this.chatId).order('created_at');
                if (messages) { messages.forEach(msg => this.renderMessage(msg, false)); }
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;

                if (this.chatSubscription) this.chatSubscription.unsubscribe();
                this.chatSubscription = supabase.channel(`chat-room-${this.chatId}`)
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${this.chatId}`},
                        payload => {
                            if (payload.new.sender_type === 'barber') this.renderMessage(payload.new);
                        }
                    ).subscribe();
            }

            async sendRealtimeMessage(text) {
                const payload = { chat_id: this.chatId, sender_id: this.clientProfile.id, sender_type: 'client', content: text };
                this.renderMessage({ ...payload });
                await supabase.from('messages').insert(payload);
            }

            addMessage(text, sender) { this.renderMessage({ text, sender, time: new Date() }); }
            addUserMessage(text) { this.addMessage(text, 'user'); }
            addBotMessage(htmlContent) { this.addMessage(htmlContent, 'bot'); }
            
            renderMessage(message, isNew = true) {
                const messageDiv = document.createElement('div');
                let senderClass = 'bot';
                if (message.sender === 'user' || message.sender_type === 'client') senderClass = 'user';
                messageDiv.className = `message ${senderClass}`;
                const content = message.text || message.content;
                const time = new Date(message.time || message.created_at || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                messageDiv.innerHTML = `<div class="message-content">${content}</div><div class="message-time">${time}</div>`;
                this.messagesContainer.appendChild(messageDiv);
                if (isNew) this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            showTyping() { if (this.isTyping) return; this.isTyping = true; const typingDiv = document.createElement('div'); typingDiv.className = 'message bot'; typingDiv.id = 'typing-indicator'; typingDiv.innerHTML = `<div class="message-content"><div class="typing"><span></span><span></span><span></span></div></div>`; this.messagesContainer.appendChild(typingDiv); this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight; }
            hideTyping() { this.isTyping = false; const indicator = document.getElementById('typing-indicator'); if (indicator) indicator.remove(); }
        }

        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new ClientChatApp();
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('‚úÖ ServiceWorker para Cliente registrado con √©xito!');
                }).catch(err => {
                    console.error('‚ùå Fallo en el registro del ServiceWorker para Cliente: ', err);
                });
            });
        }
    </script>
</body>
</html>

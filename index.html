<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarberConnect</title>
    <meta name="theme-color" content="#1E1E1E">
<link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
<style>
    /* --- INICIO: NUEVOS ESTILOS DARK MODE --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: system-ui, -apple-system, sans-serif; 
        background: #000; /* Fondo exterior negro para inmersi√≥n total */
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .chat-container { 
        width: 100%; 
        max-width: 400px; 
        height: 100vh; 
        background: #121212; /* Fondo principal oscuro */
        color: #E0E0E0; /* Texto principal claro */
        display: flex; 
        flex-direction: column; 
        box-shadow: 0 0 15px rgba(255,179,0,0.1); 
        overflow: hidden; 
    }
    .chat-header { 
        background: #1E1E1E; /* Fondo de componentes */
        color: #FFFFFF; 
        padding: 20px; 
        border-bottom: 1px solid #2C2C2C; /* Borde sutil */
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .chat-header h1 { margin: 0; font-size: 1.5em; }
    .chat-header p { margin: 5px 0 0 0; opacity: 0.7; font-size: 0.9em; color: #A0A0A0; }
    .back-button { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 1.5em; cursor: pointer; display: none; }

    .messages-container { 
        flex: 1; 
        padding: 15px; 
        overflow-y: auto; 
        background: #121212; /* Fondo principal */
    }
    .message { margin-bottom: 12px; display: flex; flex-direction: column; animation: fadeIn 0.3s ease-in; }
    .message.user { align-items: flex-end; }
    .message.bot { align-items: flex-start; }
    .message-content { padding: 10px 14px; border-radius: 18px; max-width: 85%; word-wrap: break-word; line-height: 1.4; }
    .message.user .message-content { 
        background: #FFB300; /* Acento dorado/√°mbar */
        color: #121212; /* Texto oscuro para contraste */
        font-weight: 500;
        border-bottom-right-radius: 4px; 
    }
    .message.bot .message-content { 
        background: #1E1E1E; 
        color: #E0E0E0; 
        border-bottom-left-radius: 4px; 
    }
    .message.bot .bot-card-wrapper { background: transparent; padding: 0; border: none; max-width: 95%; }
    .message-time { font-size: 0.7em; color: #A0A0A0; margin-top: 4px; padding: 0 8px; }

    .typing { display: flex; padding: 10px 14px; background: #1E1E1E; border-radius: 18px; border-bottom-left-radius: 4px; }
    .typing span { height: 6px; width: 6px; background: #A0A0A0; border-radius: 50%; display: block; margin: 0 2px; animation: typing 1s infinite ease-in-out; }
    .typing span:nth-child(1) { animation-delay: 0.2s; }
    .typing span:nth-child(2) { animation-delay: 0.4s; }
    .typing span:nth-child(3) { animation-delay: 0.6s; }

    .input-container { display: flex; padding: 12px; background: #1E1E1E; border-top: 1px solid #2C2C2C; gap: 8px; }
    .message-input { 
        flex: 1; 
        padding: 10px 14px; 
        border: 1px solid #2C2C2C; 
        background-color: #121212;
        color: #E0E0E0;
        border-radius: 20px; 
        outline: none; 
        font-size: 14px; 
    }
    .message-input:focus {
        border-color: #FFB300;
    }
    .send-button { 
        padding: 10px 16px; 
        background: #FFB300; 
        color: #121212; 
        font-weight: bold;
        border: none; 
        border-radius: 20px; 
        cursor: pointer; 
    }
    .send-button:disabled { background: #555; color: #888; cursor: not-allowed; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

    .bot-card { 
        background-color: #1E1E1E; 
        border: 1px solid #2C2C2C; 
        border-radius: 12px; 
        padding: 16px; 
        width: 100%; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
    }
    .bot-card h3 { margin: 0 0 12px 0; color: #FFFFFF; border-bottom: 1px solid #2C2C2C; padding-bottom: 8px; font-size: 1.1em; }
    .bot-card h4 { margin-top: 20px; margin-bottom: 8px; padding-top: 12px; border-top: 1px solid #2C2C2C; }
    .bot-card p { margin: 0 0 8px 0; line-height: 1.5; color: #A0A0A0; }
    .bot-card ul { list-style: none; padding: 0; margin: 0; }
    .bot-card li { padding: 8px 0; border-bottom: 1px solid #2C2C2C; display: flex; justify-content: space-between; align-items: center; }
    .bot-card li:last-child { border-bottom: none; }
    .bot-card .item-name { font-weight: 500; color: #E0E0E0; }
    .bot-card .item-detail { color: #A0A0A0; font-size: 0.9em; text-align: right; }
    .bot-card .helper-text { font-size: 0.8em; color: #888; margin-top: 5px; }

    .command-buttons-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
    .command-button { 
        background-color: #2C2C2C; 
        border: 1px solid #444; 
        border-radius: 8px; 
        padding: 12px 8px; 
        font-size: 0.9em; 
        font-weight: 500; 
        color: #E0E0E0; 
        cursor: pointer; 
        text-align: center; 
        transition: background-color 0.2s, box-shadow 0.2s; 
        width: 100%; 
    }
    .command-button:hover { background-color: #444; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .command-button.full-width { grid-column: 1 / -1; }
    .command-button.confirm { background-color: #4CAF50; color: white; }
    .command-button.cancel { background-color: #F44336; color: white; }
    .command-button.return { background-color: #444; color: #A0A0A0; }

    .schedule-selector { display: flex; flex-direction: column; gap: 12px; }
    .schedule-row { display: flex; align-items: center; gap: 10px; }
    .schedule-row label { font-weight: 500; color: #E0E0E0; flex-basis: 100px; }
    .schedule-row select { 
        flex-grow: 1; 
        padding: 8px; 
        border: 1px solid #444; 
        background-color: #121212;
        color: #E0E0E0;
        border-radius: 6px; 
        font-size: 1em; 
    }
    .schedule-actions { margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    
    /* --- INICIO: CORRECCI√ìN DE ESTILOS PARA FORMULARIO QR --- */
    .form-group {
        margin-bottom: 15px; /* Espacio entre los grupos de input */
    }
    .form-group label {
        display: block; /* El label ocupa su propia l√≠nea */
        margin-bottom: 5px; /* Espacio entre el label y el input */
        font-weight: 500; 
        color: #E0E0E0; 
    }
    .form-control {
        width: 100%; /* El input ocupa todo el ancho disponible */
        padding: 10px 14px; 
        border: 1px solid #444; 
        background-color: #121212;
        color: #E0E0E0;
        border-radius: 6px; 
        font-size: 1em; 
        box-sizing: border-box; /* Importante */
    }
    .form-control:focus {
        border-color: #FFB300;
        outline: none;
    }
    /* --- FIN: CORRECCI√ìN DE ESTILOS PARA FORMULARIO QR --- */
    
    .view { display: none; flex: 1; flex-direction: column; min-height: 0; }
    .view.active { display: flex; }

    #clientChatsView ul { list-style: none; padding: 10px 0; overflow-y: auto; }
    #clientChatsView li { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2C2C2C; cursor: pointer; gap: 12px; }
    #clientChatsView li:hover { background: #1E1E1E; }
    #clientChatsView .avatar { width: 45px; height: 45px; background: #FFB300; color: #121212; border-radius: 50%; display: grid; place-items: center; font-weight: bold; flex-shrink: 0;
    overflow: hidden; }
    
    #clientChatsView .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    #clientChatsView .chat-info { flex: 1; }
    #clientChatsView .chat-name { font-weight: 500; }
    #clientChatsView .unread-indicator { width: 10px; height: 10px; background: #FFB300; border-radius: 50%; visibility: hidden; transition: visibility 0.2s; }
    #clientChatsView .unread-indicator.visible { visibility: visible; }

    .availability-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 8px; margin: 10px 0; }
    .time-slot { padding: 8px 5px; border-radius: 6px; text-align: center; font-size: 0.8em; font-weight: 500; }
    .time-slot.available { background: #4CAF50; color: white; }
    .time-slot.booked { background: #F44336; color: white; }
    .availability-stats { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 10px; border-top: 1px solid #2C2C2C; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 1.2em; font-weight: bold; }
    .stat-label { font-size: 0.8em; color: #A0A0A0; }

    .header-icons { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); display: flex; gap: 16px; }
    .icon-wrapper { position: relative; cursor: pointer; }
    .icon-wrapper svg { width: 26px; height: 26px; fill: white; opacity: 0.8; transition: opacity 0.2s; }
    .icon-wrapper:hover svg { opacity: 1; }
    .notification-badge {
        position: absolute; top: -5px; right: -8px; background-color: #F44336; color: white;
        border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: none;
        justify-content: center; align-items: center; font-weight: bold; border: 2px solid #1E1E1E;
    }
    .notification-badge.visible { display: flex; animation: pulse-badge 2s infinite; }
    @keyframes pulse-badge { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 8px rgba(244, 67, 54, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); } }
    
    #qrcode-display { 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        padding: 20px; 
        background: white; 
        border-radius: 8px; 
        margin-top: 10px; /* Margen superior a√±adido */
        margin-bottom: 10px; /* Margen inferior a√±adido */
    }
    /* --- INICIO: Correcci√≥n Est√©tica QR --- */
    #qrcode-display img {
        max-width: 100%; /* Asegura que la imagen del QR no se desborde */
        height: auto; /* Mantiene la proporci√≥n */
        display: block; /* Elimina espacio extra bajo la imagen */
    }
    /* --- FIN: Correcci√≥n Est√©tica QR --- */

    .profile-avatar-wrapper { display: flex; justify-content: center; margin-bottom: 16px; }
    .profile-avatar {
        width: 100px; height: 100px; border-radius: 50%; background-color: #FFB300; color: #121212;
        display: flex; justify-content: center; align-items: center; font-size: 2.5em; font-weight: bold;
        border: 3px solid #1E1E1E; box-shadow: 0 4px 8px rgba(0,0,0,0.3); overflow: hidden;
    }
    .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }

    /* --- INICIO DE LA CORRECCI√ìN VISUAL: NUEVO ESTILO PARA EL BOT√ìN DE L√ÅPIZ --- */
    .edit-icon-button {
        background-color: #2C2C2C;
        border: 1px solid #444;
        border-radius: 6px; /* Bordes suaves */
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
        flex-shrink: 0; /* Evita que el bot√≥n se encoja */
    }
    .edit-icon-button:hover {
        background-color: #444;
    }
    .edit-icon-button svg {
        width: 16px;
        height: 16px;
        fill: #E0E0E0; /* Color del √≠cono */
    }
    /* --- FIN DE LA CORRECCI√ìN VISUAL --- */

    /* --- INICIO: NUEVOS ESTILOS PARA HEADER DE CHAT DE CLIENTE --- */
    .chat-header-avatar {
        width: 40px; 
        height: 40px; 
        border-radius: 50%; 
        overflow: hidden; 
        flex-shrink: 0;
        background-color: #FFB300; /* Color de fallback */
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #121212;
        font-size: 1.2em;
        margin-left: 25px; /* Espacio para el bot√≥n de 'atr√°s' */
    }
    .chat-header-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    /* --- FIN: NUEVOS ESTILOS PARA HEADER DE CHAT DE CLIENTE --- */
    
    /* --- INICIO: Mejora Est√©tica Horario de Atenci√≥n (index.html) --- */
    .bot-card ul.availability-list {
        margin-top: 10px;
    }

    .bot-card ul.availability-list li {
        display: flex;
        flex-direction: column; /* Apilar verticalmente */
        align-items: flex-start; /* Alinear a la izquierda */
        padding: 12px 0; /* M√°s espacio */
        /* Sobrescribir el 'justify-content' y 'align-items' por defecto */
        justify-content: flex-start;
    }
    
    .bot-card ul.availability-list li .day-name {
        /* "Lunes", "Martes", etc. */
        font-weight: 500;
        color: #FFFFFF; /* Blanco para el d√≠a */
        font-size: 1.05em; /* Un poco m√°s grande */
        margin-bottom: 6px;
    }
    
    .bot-card ul.availability-list li .time-available {
        /* "09:00, 09:30..." */
        font-size: 0.9em;
        color: #A0A0A0; /* Gris claro para las horas */
        line-height: 1.7; /* M√°s espacio entre l√≠neas si se envuelve */
        word-wrap: break-word; /* Asegura que se envuelva bien */
        font-family: monospace; /* Opcional: para que los n√∫meros se alineen bien */
    }

    .bot-card ul.availability-list li .time-closed {
        /* "Cerrado" */
        font-size: 0.9em;
        color: #F44336; /* Rojo para "Cerrado" */
        font-weight: 500;
    }
    /* --- FIN: Mejora Est√©tica Horario de Atenci√≥n --- */

    /* --- FIN: NUEVOS ESTILOS DARK MODE --- */


    /* --- INICIO: MEJORA TEXTO DIN√ÅMICO --- */
    .dynamic-text-wrapper {
        font-size: 0.9em;
        color: #A0A0A0; /* Color de subt√≠tulo */
        margin-top: 8px; /* Espacio */
        font-family: monospace; /* Look de terminal */
        height: 1.2em; /* Altura fija para evitar saltos */
    }

    #dynamic-text {
        color: #FFB300; /* Color de acento */
        font-weight: bold;
        /* Simula el cursor parpadeante */
        border-right: 2px solid #FFB300;
        animation: blink 1s steps(1) infinite;
        padding-right: 2px;
        letter-spacing: .05em; /* Un poco m√°s de espacio */
    }
    
    /* Animaci√≥n del cursor */
    @keyframes blink {
        50% {
            border-color: transparent;
        }
    }
    /* --- FIN: MEJORA TEXTO DIN√ÅMICO --- */
</style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
             <span class="back-button" id="backButton">‚Üê</span>
             <div id="header-title">
                <h1>üíà BarberConnect</h1>
                <p id="headerSubtitle">Asistente Virtual</p>
                
                <div class="dynamic-text-wrapper">
                    <span>Gestiona tu: </span>
                    <span id="dynamic-text"></span>
                </div>
                </div>
             <div class="header-icons">
                <div class="icon-wrapper" id="chatsIconWrapper" title="Ver mis chats">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 10H6v-2h12v2zm0-4H6V6h12v2z"></path></svg>
                    <span class="notification-badge" id="chatsBadge"></span>
                </div>
                <div class="icon-wrapper" id="bookingsIconWrapper" title="Ver nuevas citas">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"></path></svg>
                    <span class="notification-badge" id="bookingsBadge"></span>
                </div>
                <div class="icon-wrapper" id="financeIconWrapper" title="Ver Finanzas">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c2.14-.46 3.5-1.78 3.5-3.97 0-2.02-1.31-3.32-4.2-4.04z"></path></svg>
                    <span class="notification-badge" id="financeBadge"></span>
                </div>
            </div>
        </div>

        <div id="botView" class="view active">
            <div class="messages-container" id="messagesContainer"></div>
        </div>

        <div id="clientChatsView" class="view">
            <ul id="clientChatsList"></ul>
        </div>
        
        <div id="singleChatView" class="view">
            <div class="messages-container" id="singleChatMessages"></div>
        </div>

        <input type="file" id="profilePicInput" accept="image/png, image/jpeg" style="display: none;">
        <div class="input-container">
            <input type="text" class="message-input" id="messageInput" placeholder="Escribe un mensaje...">
            <button class="send-button" id="sendButton">‚û§</button>
        </div>
    </div>

<script> 
    const SUPABASE_URL = 'https://olkjevlkqdafbhuiszfz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sa2pldmxrcWRhZmJodWlzemZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNzc5ODcsImV4cCI6MjA3NDg1Mzk4N30.5V7LTjITA3szqyNxUy67K0r1IhaB9MpnxSML7IygYcM';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    class ChatApp {
        constructor() {
            this.currentFlow = 'checking_auth';
            this.userData = {};
            this.isTyping = false;
            this.currentUser = null;
            this.barberProfile = null;
            this.activeView = 'bot';
            // --- INICIO: MODIFICACI√ìN ---
            // A√±adido 'clientAvatar' para guardar la foto del cliente activo
            this.activeChat = { id: null, clientName: null, clientId: null, clientAvatar: null };
            // --- FIN: MODIFICACI√ìN ---
            
            this.unreadCounts = {};
            this.newBookingsData = [];
            this.newTransactionsCount = 0;

            this.chatSubscription = null;
            this.notificationsSubscription = null;
            this.bookingsSubscription = null;
            this.transactionsSubscription = null;

            this.messagesContainer = document.getElementById('messagesContainer');
            this.messageInput = document.getElementById('messageInput');
            this.sendButton = document.getElementById('sendButton');
            this.headerSubtitle = document.getElementById('headerSubtitle');
            this.backButton = document.getElementById('backButton');
            this.clientChatsList = document.getElementById('clientChatsList');
            this.singleChatMessages = document.getElementById('singleChatMessages');

            this.chatsBadge = document.getElementById('chatsBadge');
            this.bookingsBadge = document.getElementById('bookingsBadge');
            this.financeBadge = document.getElementById('financeBadge');
            
            this.chatsIconWrapper = document.getElementById('chatsIconWrapper');
            this.profilePicInput = document.getElementById('profilePicInput');
            
            this.bookingsIconWrapper = document.getElementById('bookingsIconWrapper');
            this.financeIconWrapper = document.getElementById('financeIconWrapper');
            
            // --- INICIO: MODIFICACI√ìN ---
            // Guardamos el contenedor y el HTML original de la cabecera
            this.headerTitleContainer = document.getElementById('header-title');
            this.originalHeaderTitleHTML = this.headerTitleContainer.innerHTML;
            // --- FIN: MODIFICACI√ìN ---

            this.init();
        }
        
        async init() {
            this.sendButton.addEventListener('click', () => this.handleSend());
            this.messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.handleSend(); });
            this.messagesContainer.addEventListener('click', this.handleButtonClick.bind(this));
            this.backButton.addEventListener('click', () => this.handleBack());
            this.chatsIconWrapper.addEventListener('click', () => this.showClientChats());
            this.bookingsIconWrapper.addEventListener('click', () => {
                this.showNewBookings();
            });
            this.financeIconWrapper.addEventListener('click', () => {
                this.showFinanceMenu();
                this.newTransactionsCount = 0;
                this.updateBadges();
            });
            this.profilePicInput.addEventListener('change', (event) => this.uploadProfilePicture(event));
            await this.checkAuthState();
        }
        
        /**
         * INICIO: Nueva funci√≥n para formatear precios seg√∫n la moneda del perfil.
         */
        formatCurrency(amount, code) {
            // Usa un c√≥digo espec√≠fico si se pasa, o el del perfil, o 'USD' como √∫ltimo recurso
            const currencyCode = code || this.barberProfile?.currency_code || 'USD';
            const numAmount = parseFloat(amount || 0).toFixed(2);
            
            // Usamos los formatos que pediste
            switch(currencyCode.toUpperCase()) {
                case 'USD': // D√≥lar Americano
                    return `$${numAmount}`;
                case 'VES': // Bol√≠var Venezolano
                    return `${numAmount} Bs.`;
                case 'COP': // Peso Colombiano
                    return `$${numAmount} COP`;
                case 'PEN': // Sol Peruano
                    return `S/${numAmount}`;
                default:    // Fallback por si acaso
                    return `$${numAmount}`;
            }
        }
        // FIN: Nueva funci√≥n

        /**
         * INICIO: Nueva funci√≥n para formatear horas
         * Convierte un n√∫mero (ej: 9.5) a un string (ej: "09:30")
         */
        formatTime(hourFloat) {
            const hour = Math.floor(hourFloat);
            const minutes = (hourFloat % 1) * 60;
            const formattedHour = String(hour).padStart(2, '0');
            const formattedMinutes = String(minutes).padStart(2, '0');
            return `${formattedHour}:${formattedMinutes}`;
        }
        // FIN: Nueva funci√≥n

        async getClientNameById(clientId) {
            if (!clientId) return null;
            try {
                // Hacemos una consulta r√°pida a la tabla de clientes
                const { data, error } = await supabase
                    .from('clients')
                    .select('first_name, last_name')
                    .eq('id', clientId)
                    .single();
                
                if (error) {
                    console.error("Error fetching client name:", error);
                    return null;
                }
                // Devolvemos el nombre completo
                return data ? `${data.first_name} ${data.last_name}` : null;
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        capitalizeName(name) {
            if (!name) return '';
            return name.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        async registerServiceWorker() {
            if (!('Notification' in window) || !('serviceWorker' in navigator)) {
                this.addBotMessage('<div class="bot-card" style="background-color: #ffdddd;"><p><strong>No Soportado.</strong> Tu navegador no es compatible con las notificaciones push.</p></div>');
                return;
            }
            const currentPermission = Notification.permission;
            if (currentPermission === 'granted') {
                this.addBotMessage('<div class="bot-card" style="background-color: #ddffdd;"><p><strong>¬°Ya est√°s suscrito!</strong> ‚úÖ No es necesario volver a activar las notificaciones.</p></div>');
                return;
            }
            if (currentPermission === 'denied') {
                this.addBotMessage('<div class="bot-card" style="background-color: #ffffcc;"><p><strong>Permiso Bloqueado.</strong> üö´ Has bloqueado las notificaciones para esta app. Para activarlas, necesitas cambiar los permisos desde la configuraci√≥n de tu navegador.</p></div>');
                return;
            }
            this.showTyping();
            try {
                const swRegistration = await navigator.serviceWorker.register('./sw.js');
                console.log("Notificaciones: Service Worker registrado con √©xito.", swRegistration);
                const permissionResult = await window.Notification.requestPermission();
                if (permissionResult !== 'granted') {
                    console.warn("Notificaciones: El usuario no concedi√≥ el permiso.");
                    this.hideTyping();
                    this.addBotMessage('<div class="bot-card" style="background-color: #ffffcc;"><p><strong>Permiso denegado.</strong> No podr√© enviarte notificaciones si no aceptas el permiso en la ventana de tu navegador.</p></div>');
                    return;
                }
                console.log("Notificaciones: Permiso concedido. Obteniendo suscripci√≥n push...");
                let pushSubscription = await swRegistration.pushManager.getSubscription();
                if (pushSubscription === null) {
                    console.log("Notificaciones: No se encontr√≥ suscripci√≥n, creando una nueva...");
                    const vapidPublicKey = 'BJCOJ2WGEu7_29mhcE56t5zkmkmO2phKSVEELfWjTVe1RtmeZOZ5LWZfMyNWpWo7q7jNhBqezFf5MQFNq9NYSqA';
                    pushSubscription = await swRegistration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: this.urlBase64ToUint8Array(vapidPublicKey)
                    });
                    console.log("Notificaciones: Nueva suscripci√≥n creada.");
                } else {
                    console.log("Notificaciones: Se encontr√≥ una suscripci√≥n existente.");
                }
                await this.savePushSubscription(pushSubscription);
            } catch (error) {
                console.error("Notificaciones: Error catastr√≥fico durante el registro.", error);
                this.addBotMessage(`<div class="bot-card" style="background-color: #ffdddd;"><p><strong>¬°Ups! Hubo un error.</strong> No se pudieron activar las notificaciones. <br><small>Detalle: ${error.message}</small></p></div>`);
            } finally {
                this.hideTyping();
            }
        }

        urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
              outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async savePushSubscription(subscription) {
            console.log("BD: Intentando guardar la suscripci√≥n en Supabase...");
            if (!this.currentUser || !this.currentUser.id) {
                console.error("BD Error: No se encontr√≥ un usuario logueado para guardar la suscripci√≥n.");
                this.addBotMessage('<div class="bot-card" style="background-color: #ffdddd;"><p><strong>Error Cr√≠tico:</strong> No pude identificarte. Por favor, intenta recargar la p√°gina.</p></div>');
                return;
            }
            const userId = this.currentUser.id;
            console.log(`BD: Actualizando perfil para user_id: ${userId}`);
            const { data, error } = await supabase
              .from('barbers')
              .update({ push_subscription: subscription })
              .eq('user_id', userId) 
              .select();
            if (error) {
                console.error("BD Error: Fallo al guardar la suscripci√≥n.", error);
                this.addBotMessage(`<div class="bot-card" style="background-color: #ffdddd;"><p><strong>Error en la base de datos:</strong> No se pudo guardar la configuraci√≥n de notificaciones.<br><small>${error.message}</small></p></div>`);
            } else if (data && data.length > 0) {
                console.info("BD: ¬°Suscripci√≥n guardada con √©xito!");
                this.addBotMessage('<div class="bot-card" style="background-color: #ddffdd;"><p><strong>¬°Listo! ‚úÖ</strong> Las notificaciones han sido activadas. A partir de ahora recibir√°s alertas de nuevas citas y mensajes.</p></div>');
            } else {
                console.warn("BD: La operaci√≥n no fall√≥, pero no se actualiz√≥ ninguna fila. Posible problema con RLS o ID de usuario.");
                this.addBotMessage('<div class="bot-card" style="background-color: #ffffcc;"><p><strong>Atenci√≥n:</strong> La configuraci√≥n se complet√≥, pero parece que no se guard√≥. Si no recibes notificaciones, contacta a soporte.</p></div>');
            }
        }

        updateBadges() {
            const totalUnread = Object.values(this.unreadCounts).reduce((sum, count) => sum + count, 0);
            if (totalUnread > 0) {
                this.chatsBadge.textContent = totalUnread > 9 ? '9+' : totalUnread;
                this.chatsBadge.classList.add('visible');
            } else {
                this.chatsBadge.classList.remove('visible');
            }
            if (this.newBookingsData.length > 0) {
                this.bookingsBadge.textContent = this.newBookingsData.length > 9 ? '9+' : this.newBookingsData.length;
                this.bookingsBadge.classList.add('visible');
            } else {
                this.bookingsBadge.classList.remove('visible');
            }
            if (this.newTransactionsCount > 0) {
                this.financeBadge.textContent = this.newTransactionsCount > 9 ? '9+' : this.newTransactionsCount;
                this.financeBadge.classList.add('visible');
            } else {
                this.financeBadge.classList.remove('visible');
            }
        }

        switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewName).classList.add('active');
            this.activeView = viewName.replace('View', '');

            // --- INICIO: MODIFICACI√ìN ---
            // L√≥gica para cambiar din√°micamente el header
            if (this.activeView === 'bot' || this.activeView === 'clientChats') {
                // Restaurar el header original
                this.headerTitleContainer.innerHTML = this.originalHeaderTitleHTML;
                this.headerTitleContainer.style.display = 'block'; // Restaurar display original
                
                // Re-seleccionar el subt√≠tulo porque el innerHTML lo elimin√≥
                this.headerSubtitle = document.getElementById('headerSubtitle');
                if (this.headerSubtitle) {
                    this.headerSubtitle.textContent = this.activeView === 'bot' ? 'Asistente Virtual' : 'Mis Chats';
                }
                
                this.backButton.style.display = 'none';
                this.activeChat.id = null;
                this.activeChat.clientAvatar = null; // Limpiar avatar
                if (this.chatSubscription) { this.chatSubscription.unsubscribe(); this.chatSubscription = null; }
            
            } else if (this.activeView === 'singleChat') {
                // Construir el header de chat (estilo WhatsApp)
                let avatarHTML = '';
                const clientName = this.activeChat.clientName;
                const clientAvatar = this.activeChat.clientAvatar;
                
                if (clientAvatar) {
                    avatarHTML = `<div class="chat-header-avatar"><img src="${clientAvatar}" alt="${clientName}"></div>`;
                } else {
                    const initial = clientName ? clientName.charAt(0).toUpperCase() : '?';
                    avatarHTML = `<div class="chat-header-avatar"><span>${initial}</span></div>`;
                }
                
                // Reemplazamos el contenido del header
                this.headerTitleContainer.innerHTML = `
                    ${avatarHTML}
                    <div style="margin-left: 12px;">
                        <h1 style="font-size: 1.2em; margin: 0; color: #FFFFFF;">${clientName}</h1>
                        <p style="font-size: 0.8em; opacity: 0.9; margin: 0; color: #A0A0A0;">en l√≠nea</p> 
                    </div>
                `;
                
                // Hacemos que el contenedor sea flex
                this.headerTitleContainer.style.display = 'flex';
                this.headerTitleContainer.style.alignItems = 'center';

                this.backButton.style.display = 'block';
            }
            // --- FIN: MODIFICACI√ìN ---
        }
        
        handleBack() {
            if (this.activeView === 'singleChat') {
                this.switchView('clientChatsView');
            }
        }

        async handleButtonClick(event) {
            const button = event.target.closest('.command-button, .edit-icon-button'); // Incluir el nuevo bot√≥n
            if (!button || button.disabled) return;
            const buttonContainer = button.closest('.command-buttons-container, .schedule-actions');
            if (buttonContainer) { buttonContainer.querySelectorAll('.command-button').forEach(btn => btn.disabled = true); }
            const command = button.dataset.command;
            const serviceToEdit = button.dataset.serviceEdit;
            const dayToEdit = button.dataset.dayEdit;
            const dayToConfirm = button.dataset.dayConfirm;
            if (command) {
                // Si el bot√≥n es el de editar, no mostramos el mensaje del usuario
                if(command !== '/editar_shop_name' && command !== '/editar_moneda') {
                    this.addUserMessage(button.textContent.trim());
                }
                if (command.startsWith('check_availability:')) {
                    const parts = command.split(':');
                    const dateString = parts[1];
                    const barberName = parts.length > 2 ? parts[2] : null; 
                    const dateParts = dateString.split('-');
                    const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                    if (isNaN(date.getTime())) { this.addBotMessage(`<div class="bot-card"><p>‚ùå Error: La fecha recibida no es v√°lida.</p></div>`); return; }
                    await this.showAvailabilityForDate(date, barberName);
                } else if (command.startsWith('select_barber_for_flow:')) {
                    const [_, barberName, nextFlow] = command.split(':');
                    this.userData.selectedBarber = barberName;
                    this.currentFlow = 'authenticated';
                    await this.handleAuthenticatedCommand(`/${nextFlow}`);
                } else {
                    await this.processUserInput(command.toLowerCase());
                }
            } else if (serviceToEdit) {
                const serviceName = JSON.parse(serviceToEdit.replace(/'/g, '"')).name;
                this.addUserMessage(`Quiero editar el servicio: ${serviceName}`);
                await this.startServiceEditFlow(serviceToEdit);
            } else if (dayToEdit) {
                const dayName = { mon: 'Lunes', tue: 'Martes', wed: 'Mi√©rcoles', thu: 'Jueves', fri: 'Viernes', sat: 'S√°bado', sun: 'Domingo' }[dayToEdit];
                this.addUserMessage(`Configurar horario para: ${dayName}`);
                await this.startDayEditFlow(dayToEdit);
            } else if (dayToConfirm) {
                // --- INICIO: MODIFICACI√ìN 30 MINUTOS ---
                const startHour = document.getElementById(`start-hour-${dayToConfirm}`).value;
                const endHour = document.getElementById(`end-hour-${dayToConfirm}`).value;
                
                const startFloat = parseFloat(startHour);
                const endFloat = parseFloat(endHour);

                if (startFloat >= endFloat) { 
                    this.addBotMessage('<div class="bot-card"><p>UPS... La hora de finalizaci√≥n debe ser mayor que la de inicio. Por favor, int√©ntalo de nuevo.</p></div>'); 
                    this.showHorarioMenu(); 
                    return; 
                }
                
                this.addUserMessage(`Confirmar horario de ${this.formatTime(startFloat)} a ${this.formatTime(endFloat)}`);
                
                let hours = [];
                // Bucle modificado para ir de 30 en 30 minutos (0.5)
                for (let i = startFloat; i < endFloat; i += 0.5) { 
                    hours.push(i); 
                }
                await this.setAvailability(dayToConfirm, hours);
                // --- FIN: MODIFICACI√ìN 30 MINUTOS ---
            }
        }
        
        async handleSend() {
            const text = this.messageInput.value.trim();
            if (!text || this.isTyping) return;
            this.messageInput.value = '';
            if (this.activeView === 'bot') { this.addUserMessage(text); await this.processUserInput(text.toLowerCase(), text); }
            else if (this.activeView === 'singleChat') { await this.sendClientMessage(text); }
        }

        addMessage(text, sender, container) { const message = { text, sender, time: new Date() }; this.renderMessage(message, container); }
        addUserMessage(text) { this.addMessage(text, 'user', this.messagesContainer); }
        addBotMessage(htmlContent) { this.addMessage(`<div class="bot-card-wrapper">${htmlContent}</div>`, 'bot', this.messagesContainer); }
        
        renderMessage(message, container, isNew = true) {
            const targetContainer = container || (this.activeView === 'singleChat' ? this.singleChatMessages : this.messagesContainer);
            const messageDiv = document.createElement('div');
            let senderClass = 'bot';
            if (message.sender === 'user' || message.sender_type === 'barber') { senderClass = 'user'; }
            messageDiv.className = `message ${senderClass}`;
            const content = message.text || message.content;
            let time;
            try { time = new Date(message.time || message.created_at || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); } 
            catch (error) { time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
            messageDiv.innerHTML = `<div class="message-content">${content}</div><div class="message-time">${time}</div>`;
            targetContainer.appendChild(messageDiv);
            if (isNew) { targetContainer.scrollTop = targetContainer.scrollHeight; }
        }
        
        showTyping() { if (this.isTyping) return; this.isTyping = true; const typingDiv = document.createElement('div'); typingDiv.className = 'message bot'; typingDiv.id = 'typing-indicator'; typingDiv.innerHTML = `<div class="typing"><span></span><span></span><span></span></div>`; this.messagesContainer.appendChild(typingDiv); this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight; }
        hideTyping() { this.isTyping = false; const indicator = document.getElementById('typing-indicator'); if (indicator) indicator.remove(); }
        
               async processUserInput(input, originalText = null) {
            if (originalText === null) originalText = input;
            this.showTyping();
            await new Promise(resolve => setTimeout(resolve, 600));
            this.hideTyping();
            
            switch(this.currentFlow) {
                case 'welcome': case 'has_account': case 'register_name':
                case 'register_last_name': case 'register_email': case 'register_password':
                case 'login_email': case 'login_password':
                    await this.handleAuthFlow(input, originalText);
                    break;
                case 'servicio_add_name':
                    this.userData.tempServiceName = originalText;
                    this.addBotMessage(`<div class="bot-card"><p>¬°Entendido! El servicio se llamar√° "<strong>${originalText}</strong>".</p><p>Ahora, por favor, dime el precio (solo el n√∫mero).</p></div>`);
                    this.currentFlow = 'servicio_add_price';
                    break;
                case 'servicio_add_price':
                    await this.addService(this.userData.tempServiceName, input);
                    break;
                case 'editing_service':
                    await this.handleServiceEditFlow(input, originalText);
                    break;
                case 'editing_service_name':
                    await this.updateService('name', originalText);
                    break;
                case 'editing_service_price':
                    await this.updateService('price', input);
                    break;
                case 'adding_barber_name':
                    await this.addNewBarberToJSON(originalText.trim());
                    break;
                case 'editing_shop_name':
                    await this.updateShopName(originalText.trim());
                    break;
                
                // --- INICIO DE LA MODIFICACI√ìN: UBICACI√ìN ---
                case 'awaiting_location_link':
                    await this.parseAndSaveMapLink(originalText);
                    break;
                // --- FIN DE LA MODIFICACI√ìN: UBICACI√ìN ---

                case 'authenticated':
                    await this.handleAuthenticatedCommand(input);
                    break;
                // --- INICIO: L√ìGICA DE APROBACI√ìN ---
                case 'pending_approval':
                    if (input === '/cerrar') {
                        await this.logout();
                    }
                    // Si no es /cerrar, no hacemos nada. El usuario est√° bloqueado.
                    break;
                // --- FIN: L√ìGICA DE APROBACI√ìN ---
                default:
                    this.addBotMessage('<div class="bot-card"><p>Vaya, no he entendido eso. ¬øPodr√≠as intentarlo de nuevo o usar uno de los botones del men√∫ principal?</p></div>');
            }
        }

async handleAuthenticatedCommand(input) {
            
            // --- INICIO: CORRECCI√ìN DE L√ìGICA ---
            // Primero, intentamos separar por ':', que usamos en los botones
            let command, argString;
            if (input.includes(':')) {
                const parts = input.split(':');
                command = parts[0];       // ej: "/set_currency"
                argString = parts[1] || ''; // ej: "pen"
            } else {
                // Si no hay ':', usamos la l√≥gica anterior de separar por espacio
                const parts = input.split(' ');
                command = parts[0];
                argString = parts.slice(1).join(' ');
            }
            // --- FIN: CORRECCI√ìN DE L√ìGICA ---

            switch(command) {
                case '/miperfil': await this.showBarberProfile(); break;
                case '/citas': await this.showAllBookings(); break;
                case '/disponibilidad': await this.promptDateForAvailability(); break;
                case '/chats': await this.showClientChats(); break;
                case '/cerrar': await this.logout(); break;
                case '/finanzas': await this.showFinanceMenu(); break;
                case '/generar_qr': await this.promptForQRCodeGeneration(); break;
                case '/editar_shop_name':
                    this.addBotMessage('<div class="bot-card"><p>Introduce el nuevo nombre para tu barber√≠a:</p></div>');
                    this.currentFlow = 'editing_shop_name';
                    break;
                
                // --- INICIO: MANEJO DE MONEDA ---
                case '/editar_moneda':
                    this.promptCurrencySelection();
                    break;
                case '/set_currency': // <-- ¬°Ahora s√≠ va a funcionar!
                    const newCode = argString.toUpperCase();
                    await this.updateCurrency(newCode);
                    break;
                // --- FIN: MANEJO DE MONEDA ---

                // --- INICIO DE LA MODIFICACI√ìN: UBICACI√ìN ---
                case '/editar_ubicacion':
                    this.promptLocationEdit();
                    break;
                case '/location_use_gps':
                    await this.getLocationFromGPS();
                    break;
                case '/location_paste_link':
                    this.addBotMessage(`<div class="bot-card">
                        <p>Pega el enlace de Google Maps aqu√≠.</p>
                        <p class="helper-text">Busca tu barber√≠a en Google Maps, haz clic en "Compartir" y luego en "Copiar enlace".</p>
                    </div>`);
                    this.currentFlow = 'awaiting_location_link';
                    break;
                case '/location_delete':
                    await this.updateLocation(null);
                    break;
                // --- FIN DE LA MODIFICACI√ìN: UBICACI√ìN ---

                case 'menu': case 'men√∫': this.showMainMenu(); break;
                case '/suscribirse_notificaciones': await this.registerServiceWorker(); break;
                case '/horario':
                    if (argString === 'ver') await this.promptBarberSelection('horario ver');
                    else if (argString === 'definir') await this.promptBarberSelection('horario definir');
                    else await this.promptBarberSelection('horario');
                    break;
                case '/servicios':
                     if (argString === 'ver') await this.promptBarberSelection('servicios ver');
                    else if (argString === 'agregar') await this.promptBarberSelection('servicios agregar');
                    else if (argString === 'editar') await this.promptBarberSelection('servicios editar');
                    else await this.promptBarberSelection('servicios');
                    break;
                case '/equipo': this.showTeamManagementMenu(); break;
                case '/activar_equipo': await this.activateTeamAccount(); break;
                case '/ver_equipo': await this.showTeamMembers(); break;
                case '/agregar_barbero':
                    this.addBotMessage('<div class="bot-card"><p>¬°Perfecto! Escribe el nombre del nuevo barbero.</p></div>');
                    this.currentFlow = 'adding_barber_name';
                    break;
                case '/horario-interno':
                    if (argString === 'ver') await this.showAvailability();
                    else if (argString === 'definir') await this.promptDaySelection();
                    else this.showHorarioMenu();
                    break;
                case '/servicios-interno':
                     if (argString === 'ver') await this.showServices();
                    else if (argString === 'agregar') { this.addBotMessage('<div class="bot-card"><p>¬°Claro! Dime el nombre del nuevo servicio para <strong>' + this.userData.selectedBarber + '</strong>.</p></div>'); this.currentFlow = 'servicio_add_name'; }
                    else if (argString === 'editar') await this.promptServiceSelectionToEdit();
                    else this.showServicesMenu();
                    break;
                case '/horario-cerrado':
                    // --- CORRECCI√ìN DE BUG 2 ---
                    // 'argString' contendr√° el 'dayKey' (ej: 'mon')
                    if (argString) await this.setAvailability(argString, []);
                    break;
                default:
                    this.addBotMessage('<div class="bot-card"><p>Lo siento, no reconozco ese comando. Aqu√≠ tienes las opciones principales.</p></div>');
                    this.showMainMenu();
            }
        }

        
        showMainMenu() {
            const menuHTML = `<div class="bot-card"><h3>Men√∫ Principal</h3><p>Hola de nuevo, ¬øen qu√© te puedo ayudar hoy?</p><div class="command-buttons-container">
            <button class="command-button" data-command="/miperfil">üë§ Mi Perfil</button>
            <button class="command-button" data-command="/equipo">üë• Gestionar Equipo</button>
            <button class="command-button" data-command="/horario">‚è∞ Horarios</button>
            <button class="command-button" data-command="/servicios">üõ†Ô∏è Servicios</button>
            <button class="command-button" data-command="/citas">üìÖ Ver Citas</button>
            <button class="command-button" data-command="/finanzas">üí∞ Finanzas</button>
            <button class="command-button" data-command="/chats">üí¨ Mis Chats</button>
            <button class="command-button" data-command="/disponibilidad">üîç Ver Disponibilidad</button>
            <button class="command-button" data-command="/suscribirse_notificaciones">üîî Activar Notificaciones</button>
            <button class="command-button" data-command="/cerrar">üö™ Cerrar Sesi√≥n</button>
            </div></div>`;
            this.addBotMessage(menuHTML);
        }

        // --- INICIO: NUEVA FUNCI√ìN DE APROBACI√ìN ---
        showPendingApproval() {
            this.messagesContainer.innerHTML = ''; // Limpiar la pantalla
            const name = this.barberProfile ? this.barberProfile.first_name : 'barbero';
            
            const pendingHTML = `
            <div class="bot-card">
                <h3>‚è≥ Cuenta Pendiente de Aprobaci√≥n</h3>
                <p>¬°Gracias por registrarte, <strong>${name}</strong>!</p>
                <p>Tu cuenta ha sido creada, pero necesita ser aprobada manually por un administrador. Recibiremos una notificaci√≥n y la revisaremos pronto.</p>
                <p>Por favor, ten paciencia. No necesitas hacer nada m√°s.</p>
                <div class="command-buttons-container" style="margin-top: 15px;">
                    <button class="command-button full-width return" data-command="/cerrar">Cerrar Sesi√≥n</button>
                </div>
            </div>`;
            
            this.addBotMessage(pendingHTML);
            
            // Desactivamos la entrada de texto
            this.messageInput.placeholder = "Cuenta pendiente de aprobaci√≥n";
            this.messageInput.disabled = true;
            this.sendButton.disabled = true;
            this.currentFlow = 'pending_approval'; // Estado de bloqueo
        }
        // --- FIN: NUEVA FUNCI√ìN DE APROBACI√ìN ---

        // --- INICIO: NUEVAS FUNCIONES DE MONEDA ---
        /**
         * Muestra las opciones de moneda al barbero.
         */
        promptCurrencySelection() {
            const menuHTML = `<div class="bot-card">
                <h3>Selecciona tu moneda principal</h3>
                <p>Esta ser√° la moneda mostrada a tus clientes para servicios y pagos.</p>
                <div class="command-buttons-container">
                    <button class="command-button" data-command="/set_currency:USD">D√≥lar Americano ($)</button>
                    <button class="command-button" data-command="/set_currency:VES">Bol√≠var Venezolano (Bs.)</button>
                    <button class="command-button" data-command="/set_currency:COP">Peso Colombiano (COP)</button>
                    <button class="command-button" data-command="/set_currency:PEN">Sol Peruano (S/)</button>
                    <button class="command-button full-width return" data-command="/miperfil">Cancelar</button>
                </div>
            </div>`;
            this.addBotMessage(menuHTML);
        }

        /**
         * Actualiza la moneda en la base de datos y localmente.
         */
        async updateCurrency(newCode) {
            this.showTyping();
            const { data, error } = await supabase
                .from('barbers')
                .update({ currency_code: newCode })
                .eq('user_id', this.currentUser.id)
                .select()
                .single();
            this.hideTyping();
            
            if (error) {
                console.error("Error updating currency:", error);
                this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al actualizar la moneda.</p></div>');
            } else {
                this.barberProfile = data; // Actualiza el perfil local
                this.addBotMessage(`<div class="bot-card"><p>‚úÖ ¬°Moneda actualizada a <strong>${newCode}</strong>!</p></div>`);
            }
            await this.showBarberProfile(); // Muestra el perfil actualizado
        }
        // --- FIN: NUEVAS FUNCIONES DE MONEDA ---


        showServicesMenu() {
            const title = this.barberProfile.is_team_account 
                ? `para <strong>${this.userData.selectedBarber}</strong>` 
                : '';
            const menuHTML = `<div class="bot-card"><h3>üõ†Ô∏è Gesti√≥n de Servicios ${title}</h3><div class="command-buttons-container"><button class="command-button" data-command="/servicios-interno ver">Ver Lista</button><button class="command-button" data-command="/servicios-interno agregar">Agregar Nuevo</button><button class="command-button" data-command="/servicios-interno editar">Editar / Borrar</button><button class="command-button full-width return" data-command="menu">Volver al Men√∫</button></div></div>`;
            this.addBotMessage(menuHTML);
        }
        
        showHorarioMenu() {
            const title = this.barberProfile.is_team_account 
                ? `para <strong>${this.userData.selectedBarber}</strong>` 
                : '';
            const menuHTML = `<div class="bot-card"><h3>‚è∞ Gesti√≥n de Horario ${title}</h3><div class="command-buttons-container"><button class="command-button" data-command="/horario-interno ver">Ver mi Horario</button><button class="command-button" data-command="/horario-interno definir">Definir/Editar</button><button class="command-button full-width return" data-command="menu">Volver al Men√∫</button></div></div>`;
            this.addBotMessage(menuHTML);
        }
        
        async promptDaySelection() {
            const days = { 
                mon: 'Lunes', tue: 'Martes', wed: 'Mi√©rcoles', 
                thu: 'Jueves', fri: 'Viernes', sat: 'S√°bado', sun: 'Domingo' 
            };
            const barberName = this.userData.selectedBarber;
            const buttonsHTML = Object.keys(days).map(key => 
                `<button class="command-button" data-day-edit="${key}">${days[key]}</button>`
            ).join('');
            const menuHTML = `<div class="bot-card">
                <h3>Definir Horario para ${barberName}</h3>
                <p>Por favor, selecciona el d√≠a que quieres configurar.</p>
                <div class="command-buttons-container">
                    ${buttonsHTML}
                    <button class="command-button full-width return" data-command="/horario-interno">‚Ü©Ô∏è Volver a Horarios</button>
                </div>
            </div>`;
            this.addBotMessage(menuHTML);
        }
        
        showTeamManagementMenu() {
            if (this.barberProfile.is_team_account) {
                this.addBotMessage(`<div class="bot-card">
                    <h3>üë• Gesti√≥n de Equipo</h3>
                    <p>Desde aqu√≠ puedes a√±adir o ver los barberos de tu negocio.</p>
                    <div class="command-buttons-container">
                        <button class="command-button" data-command="/ver_equipo">Ver Mi Equipo</button>
                        <button class="command-button" data-command="/agregar_barbero">‚ûï A√±adir Barbero</button>
                        <button class="command-button full-width return" data-command="menu">Volver al Men√∫</button>
                    </div>
                </div>`);
            } else {
                this.addBotMessage(`<div class="bot-card">
                    <h3>üë• Activar Cuenta de Equipo</h3>
                    <p>Actualmente tu cuenta es para un barbero individual. Activa el modo equipo para poder a√±adir m√°s barberos, cada uno con sus propios horarios y servicios.</p>
                    <p><strong>Esta acci√≥n es permanente.</strong></p>
                    <div class="command-buttons-container">
                        <button class="command-button confirm" data-command="/activar_equipo">üöÄ Activar Cuenta de Equipo</button>
                        <button class="command-button full-width return" data-command="menu">Volver al Men√∫</button>
                    </div>
                </div>`);
            }
        }

        async activateTeamAccount() {
            this.showTyping();
            const { data, error } = await supabase
                .from('barbers')
                .update({ is_team_account: true })
                .eq('user_id', this.currentUser.id)
                .select()
                .single();
            this.hideTyping();
            if (error) {
                console.error("Error activating team account:", error);
                this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al activar la cuenta de equipo. Por favor, int√©ntalo de nuevo.</p></div>');
            } else {
                this.barberProfile = data;
                this.addBotMessage('<div class="bot-card"><h3>¬°Cuenta de Equipo Activada! ‚úÖ</h3><p>Ahora puedes empezar a a√±adir miembros a tu equipo desde este men√∫.</p></div>');
                this.showTeamManagementMenu();
            }
        }

        async showTeamMembers() {
            const b = await this.getBarberProfile();
            const barbers = Object.keys(b.availability || {});
            
            let membersHTML = '<p>A√∫n no has a√±adido a ning√∫n barbero. ¬°A√±ade el primero!</p>';
            if (barbers.length > 0) {
                membersHTML = barbers.map(name => `<li><span class="item-name">${name}</span></li>`).join('');
            }
            this.addBotMessage(`<div class="bot-card"><h3>üë• Mi Equipo</h3><ul>${membersHTML}</ul></div>`);
            this.showTeamManagementMenu();
        }

        async addNewBarberToJSON(barberName) {
            const formattedName = this.capitalizeName(barberName);
            if (!formattedName) { this.addBotMessage('<div class="bot-card"><p>El nombre no puede estar vac√≠o.</p></div>'); return; }
            this.showTyping();
            const b = await this.getBarberProfile();
            let availability = b.availability || {};
            let services = b.services || {};
            if (availability[formattedName] || services[formattedName]) {
                this.hideTyping();
                this.addBotMessage(`<div class="bot-card"><p>‚ö†Ô∏è El barbero "<strong>${formattedName}</strong>" ya existe.</p></div>`);
                this.showTeamManagementMenu();
                return;
            }
            availability[formattedName] = {};
            services[formattedName] = [];
            const { error } = await supabase.from('barbers').update({ availability, services }).eq('user_id', this.currentUser.id);
            this.hideTyping();
            if (error) {
                this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al guardar.</p></div>');
            } else {
                this.addBotMessage(`<div class="bot-card"><p>‚úÖ <strong>${formattedName}</strong> ha sido a√±adido. Ahora puedes configurar su horario y servicios.</p></div>`);
            }
            this.currentFlow = 'authenticated';
            this.showTeamManagementMenu();
        }

        async promptBarberSelection(nextFlow) {
            const b = await this.getBarberProfile();
            const barbers = Object.keys(b.availability || {});
            
            if (!b.is_team_account || barbers.length === 1) {
                this.userData.selectedBarber = barbers[0];
                await this.handleAuthenticatedCommand(`/${nextFlow}-interno`);
                return;
            }
            if (barbers.length === 0) {
                this.addBotMessage('<div class="bot-card"><p>Primero debes a√±adir al menos un barbero a tu equipo. Usa el men√∫ de "Gestionar Equipo".</p></div>');
                this.showMainMenu();
                return;
            }
            const buttonsHTML = barbers.map(name => 
                `<button class="command-button" data-command="select_barber_for_flow:${name}:${nextFlow}-interno">${name}</button>`
            ).join('');
            this.addBotMessage(`<div class="bot-card">
                <h3>¬øPara qu√© barbero deseas realizar esta acci√≥n?</h3>
                <div class="command-buttons-container">${buttonsHTML}</div>
            </div>`);
        }

        getBarberProfile() { return this.barberProfile; }
        
        async refreshProfileFromDB() {
            const { data, error } = await supabase
                .from('barbers')
                .select('*')
                .eq('user_id', this.currentUser.id)
                .single();
            if (data && !error) {
                this.barberProfile = data;
                console.log("Perfil local refrescado con √©xito desde la BD.");
            } else {
                console.error("Error al refrescar el perfil desde la BD:", error);
            }
        }
        
              async showBarberProfile() {
            this.showTyping();
            const profile = this.getBarberProfile();
            await new Promise(resolve => setTimeout(resolve, 500));
            this.hideTyping();
        
            if (!profile) {
                this.addBotMessage('<div class="bot-card"><p>‚ùå No pude cargar tu perfil. Intenta recargar la p√°gina.</p></div>');
                return;
            }
        
            const accountType = profile.is_team_account ? 'Equipo (M√∫ltiples Barberos)' : 'Individual';
            const sanitizedShopName = profile.barber_shop_name.replace(/'/g, "\\'");
        
            let avatarHTML = '';
            if (profile.avatar_url) {
                avatarHTML = `<div class="profile-avatar"><img src="${profile.avatar_url}" alt="Foto de Perfil"></div>`;
            } else {
                const initial = profile.first_name ? profile.first_name.charAt(0).toUpperCase() : '?';
                avatarHTML = `<div class="profile-avatar"><span>${initial}</span></div>`;
            }
        
            let photoButtonsHTML = '';
            if (profile.avatar_url) {
                photoButtonsHTML = `
                    <button class="command-button" onclick="app.triggerFileUpload()">‚úèÔ∏è Editar Foto</button>
                    <button class="command-button cancel" onclick="app.deleteProfilePicture()">üóëÔ∏è Eliminar Foto</button>
                `;
            } else {
                photoButtonsHTML = `
                    <button class="command-button full-width confirm" onclick="app.triggerFileUpload()">üì∏ Subir Foto de Perfil</button>
                `;
            }
        
            const profileHTML = `
            <div class="bot-card">
                <h3>üë§ Mi Perfil</h3>
                <div class="profile-avatar-wrapper">${avatarHTML}</div>
        
                <div class="command-buttons-container" style="margin-bottom: 15px; grid-template-columns: 1fr 1fr;">
                    ${photoButtonsHTML}
                </div>
        
                <ul>
                    <li><span class="item-name">Nombre:</span><span class="item-detail">${profile.first_name} ${profile.last_name}</span></li>
                    
                    <li style="display: flex; align-items: center;">
                        <span class="item-name">Barber√≠a:</span>
                        <span class="item-detail" style="margin-left: 1rem; text-align: left;">${profile.barber_shop_name}</span>
                        <button class="edit-icon-button" data-command="/editar_shop_name" style="margin-left: auto;" title="Editar nombre de la barber√≠a">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg>
                        </button>
                    </li>
        
                    <li><span class="item-name">Tipo de Cuenta:</span><span class="item-detail">${accountType}</span></li>
                    <li><span class="item-name">C√≥digo Clientes:</span><span class="item-detail" style="font-weight: bold; color: #764ba2;">${profile.public_code}</span></li>
                    
                    <li style="display: flex; align-items: center;">
                        <span class="item-name">Moneda:</span>
                        <span class="item-detail" style="margin-left: 1rem; text-align: left;">${profile.currency_code}</span>
                        <button class="edit-icon-button" data-command="/editar_moneda" style="margin-left: auto;" title="Editar moneda">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg>
                        </button>
                    </li>

                    <li style="display: flex; align-items: center;">
                        <span class="item-name">Ubicaci√≥n:</span>
                        <span class="item-detail" style="margin-left: 1rem; text-align: left;">
                            ${profile.location ? 
                                `<a href="https://www.google.com/maps?q=$${profile.location}" target="_blank" style="color: #FFB300; text-decoration: none;">Ver en Google Maps</a>` :
                                'No establecida'
                            }
                        </span>
                        <button class="edit-icon-button" data-command="/editar_ubicacion" style="margin-left: auto;" title="Editar ubicaci√≥n">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path></svg>
                        </button>
                    </li>
                    </ul>
                <p class="helper-text">Tus clientes usan este c√≥digo para conectar contigo.</p>
        
                <div class="command-buttons-container" style="margin-top: 15px; grid-template-columns: 1fr 1fr;">
                    <button class="command-button" onclick="app.copyCodeToClipboard('${profile.public_code}', this)">üìã Copiar C√≥digo</button>
                    <button class="command-button confirm" onclick="app.shareProfileCode('${profile.public_code}', '${sanitizedShopName}')">üì≤ Compartir</button>
                </div>
                <div class="command-buttons-container" style="margin-top: 10px;">
                    <button class="command-button full-width return" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button>
                </div>
            </div>`;
        
            this.addBotMessage(profileHTML);
        }

        
        async copyCodeToClipboard(code, buttonElement) {
            try {
                await navigator.clipboard.writeText(code);
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = '‚úÖ ¬°Copiado!';
                buttonElement.style.backgroundColor = '#28a745';
                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                    buttonElement.style.backgroundColor = '';
                }, 2000);
            } catch (err) {
                console.error('Error al copiar el c√≥digo: ', err);
                this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al intentar copiar el c√≥digo.</p></div>');
            }
        }

        async shareProfileCode(code, shopName) {
            const shareData = {
                title: `C√≥digo para ${shopName}`,
                text: `¬°Hola! Usa este c√≥digo para conectar con nuestra barber√≠a "${shopName}" en BarberConnect: ${code}`,
                url: window.location.origin + '/Cliente.html'
            };
            if (navigator.share && navigator.canShare(shareData)) {
                try {
                    await navigator.share(shareData);
                    console.log('C√≥digo compartido con √©xito');
                } catch (err) {
                    console.error('Error al compartir: ', err);
                }
            } else {
                this.addBotMessage('<div class="bot-card"><p>La funci√≥n de compartir no est√° disponible en este navegador. Puedes copiar el c√≥digo manualmente.</p></div>');
            }
        }
        
        triggerFileUpload() {
            this.profilePicInput.click();
        }

        async uploadProfilePicture(event) {
            const file = event.target.files[0];
            if (!file) return;
            const fileTypes = ['image/png', 'image/jpeg'];
            if (!fileTypes.includes(file.type)) {
                this.addBotMessage('<div class="bot-card"><p>‚ùå Formato no v√°lido. Sube una imagen PNG o JPG.</p></div>');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                this.addBotMessage('<div class="bot-card"><p>‚ùå La imagen es muy grande. El l√≠mite es de 5 MB.</p></div>');
                return;
            }
            this.addBotMessage('<div class="bot-card"><p>Subiendo foto, por favor espera... ‚è≥</p></div>');
            this.showTyping();
            const bucketName = 'profile_pictures';
            const filePath = `${this.currentUser.id}/profile.png`;
            try {
                const { error: uploadError } = await supabase.storage
                    .from(bucketName)
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: true,
                    });
                if (uploadError) throw uploadError;
                const { data: urlData } = supabase.storage
                    .from(bucketName)
                    .getPublicUrl(filePath);
                const publicURLWithCacheBuster = `${urlData.publicUrl}?t=${new Date().getTime()}`;
                const { data: updatedProfile, error: dbError } = await supabase
                    .from('barbers')
                    .update({ avatar_url: publicURLWithCacheBuster })
                    .eq('user_id', this.currentUser.id)
                    .select()
                    .single();
                if (dbError) throw dbError;
                this.barberProfile = updatedProfile;
                this.addBotMessage('<div class="bot-card"><p>‚úÖ ¬°Foto de perfil actualizada con √©xito!</p></div>');
                await this.showBarberProfile();
            } catch (error) {
                console.error("Error subiendo la foto:", error);
                this.addBotMessage(`<div class="bot-card" style="background-color: #ffdddd;"><p><strong>‚ùå Hubo un error al subir tu foto:</strong><br><small>${error.message}</small></p></div>`);
            } finally {
                this.hideTyping();
                this.profilePicInput.value = '';
            }
        }

        async deleteProfilePicture() {
            if (!confirm("¬øEst√°s seguro de que quieres eliminar tu foto de perfil?")) return;
            this.addBotMessage('<div class="bot-card"><p>Eliminando foto...</p></div>');
            this.showTyping();
            const filePath = `${this.currentUser.id}/profile.png`;
            try {
                const { error: removeError } = await supabase.storage
                    .from('profile_pictures')
                    .remove([filePath]);
                if (removeError) throw removeError;
                const { error: dbError } = await supabase
                    .from('barbers')
                    .update({ avatar_url: null })
                    .eq('user_id', this.currentUser.id);
                if (dbError) throw dbError;
                await this.refreshProfileFromDB();
                this.addBotMessage('<div class="bot-card"><p>‚úÖ Foto eliminada correctamente.</p></div>');
                await this.showBarberProfile();
            } catch (error) {
                console.error("Error eliminando la foto:", error);
                this.addBotMessage(`<div class="bot-card"><p>‚ùå Hubo un error al eliminar tu foto: ${error.message}</p></div>`);
            } finally {
                this.hideTyping();
            }
        }
        
        async updateShopName(newName) {
            const formattedName = this.capitalizeName(newName);
            if (!formattedName || formattedName.length < 3) {
                this.addBotMessage('<div class="bot-card"><p>‚ùå El nombre es muy corto. Por favor, introduce un nombre v√°lido.</p></div>');
                this.currentFlow = 'authenticated';
                await this.showBarberProfile();
                return;
            }
            this.showTyping();
            const { data, error } = await supabase
                .from('barbers')
                .update({ barber_shop_name: formattedName })
                .eq('user_id', this.currentUser.id)
                .select()
                .single();
            this.hideTyping();
            this.currentFlow = 'authenticated';
            if (error) {
                console.error("Error updating shop name:", error);
                this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al actualizar el nombre de la barber√≠a.</p></div>');
            } else {
                this.barberProfile = data;
                this.addBotMessage('<div class="bot-card"><p>‚úÖ ¬°Nombre de la barber√≠a actualizado con √©xito!</p></div>');
            }
            await this.showBarberProfile();
        }
        
        // --- INICIO: NUEVAS FUNCIONES DE UBICACI√ìN ---

        /**
         * Muestra las opciones para editar la ubicaci√≥n.
         */
        promptLocationEdit() {
            const profile = this.getBarberProfile();
            let deleteButtonHTML = '';

            if (profile.location) {
                deleteButtonHTML = `<button class="command-button cancel" data-command="/location_delete">üóëÔ∏è Eliminar Ubicaci√≥n</button>`;
            }

            const menuHTML = `<div class="bot-card">
                <h3>Gestionar Ubicaci√≥n</h3>
                <p>¬øC√≥mo quieres establecer la ubicaci√≥n de tu barber√≠a?</p>
                <div class="command-buttons-container">
                    <button class="command-button confirm" data-command="/location_use_gps">üìç Usar mi ubicaci√≥n actual</button>
                    <button class="command-button" data-command="/location_paste_link">üîó Pegar enlace de Google Maps</button>
                    ${deleteButtonHTML}
                    <button class="command-button full-width return" data-command="/miperfil">Cancelar</button>
                </div>
            </div>`;
            this.addBotMessage(menuHTML);
        }

        /**
         * Intenta obtener la geolocalizaci√≥n del navegador.
         */
        async getLocationFromGPS() {
            if (!('geolocation' in navigator)) {
                this.addBotMessage('<div class="bot-card"><p>‚ùå Tu navegador no soporta la geolocalizaci√≥n.</p></div>');
                await this.showBarberProfile();
                return;
            }

            this.addBotMessage('<div class="bot-card"><p>Por favor, acepta el permiso en tu navegador para obtener la ubicaci√≥n...</p></div>');
            this.showTyping();

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const locationString = `${lat},${lng}`;
                    await this.updateLocation(locationString);
                },
                (error) => {
                    this.hideTyping();
                    let errorMsg = '‚ùå Hubo un error desconocido.';
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMsg = '‚ùå Has denegado el permiso de ubicaci√≥n. Debes activarlo en la configuraci√≥n de tu navegador.';
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        errorMsg = '‚ùå No se pudo determinar tu ubicaci√≥n actual.';
                    }
                    this.addBotMessage(`<div class="bot-card"><p>${errorMsg}</p></div>`);
                    this.showBarberProfile();
                }
            );
        }

        /**
         * Parsea un enlace de Google Maps para extraer latitud y longitud.
         */
        async parseAndSaveMapLink(link) {
            // Regex para encontrar @lat,lng, en un enlace de Google
            const regex = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
            const match = link.match(regex);

            if (match && match[1] && match[2]) {
                const lat = match[1];
                const lng = match[2];
                const locationString = `${lat},${lng}`;
                await this.updateLocation(locationString);
            } else {
                this.addBotMessage(`<div class="bot-card">
                    <p>‚ùå El enlace no parece ser v√°lido o no contiene coordenadas (formato @lat,lng).</p>
                    <p class="helper-text">Aseg√∫rate de copiar el enlace correcto de Google Maps.</p>
                </div>`);
                this.currentFlow = 'authenticated';
                await this.showBarberProfile();
            }
        }

        /**
         * Guarda la cadena de ubicaci√≥n (o null) en Supabase.
         */
        async updateLocation(locationString) {
            this.showTyping();
            
            const { data, error } = await supabase
                .from('barbers')
                .update({ location: locationString })
                .eq('user_id', this.currentUser.id)
                .select()
                .single();

            this.hideTyping();
            this.currentFlow = 'authenticated';

            if (error) {
                console.error("Error updating location:", error);
                this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al actualizar tu ubicaci√≥n.</p></div>');
            } else {
                this.barberProfile = data; // Actualiza el perfil local
                this.addBotMessage(`<div class="bot-card"><p>‚úÖ ¬°Ubicaci√≥n actualizada con √©xito!</p></div>`);
            }
            
            await this.showBarberProfile(); // Muestra el perfil actualizado
        }

        // --- FIN: NUEVAS FUNCIONES DE UBICACI√ìN ---

        
        async showServices() {
            const barberName = this.userData.selectedBarber;
            const b = await this.getBarberProfile();
            let servicesOfBarber = (b.services || {})[barberName] || [];
            let s = '';
            if (servicesOfBarber.length > 0) {
                // --- MODIFICACI√ìN MONEDA ---
                s = servicesOfBarber.map(svc => `<li><span class="item-name">${svc.name}</span><span class="item-detail">${this.formatCurrency(svc.price)}</span></li>`).join('');
            } else {
                s = `<p><strong>${barberName}</strong> a√∫n no tiene servicios asignados.</p>`;
            }
            this.addBotMessage(`<div class="bot-card"><h3>üõ†Ô∏è Lista de Servicios de ${barberName}</h3><ul>${s}</ul></div>`);
            this.showServicesMenu();
        }
        
        async showAvailability() {
            const barberName = this.userData.selectedBarber;
            const b = await this.getBarberProfile();
            const availabilityOfBarber = (b.availability || {})[barberName] || {};
            
            const d = { mon: 'Lunes', tue: 'Martes', wed: 'Mi√©rcoles', thu: 'Jueves', fri: 'Viernes', sat: 'S√°bado', sun: 'Domingo' };
            
            // --- INICIO: MODIFICACI√ìN EST√âTICA ---
            let a = Object.keys(d).map(k => {
                const h = availabilityOfBarber[k] || [];
                const t = h.length > 0 ? h.map(hr => this.formatTime(hr)).join(', ') : 'Cerrado';
                
                const timeClass = t === 'Cerrado' ? 'time-closed' : 'time-available';
                return `<li>
                            <span class="day-name">${d[k]}</span>
                            <span class="${timeClass}">${t}</span>
                        </li>`;
            }).join('');
            
            // Se a√±ade la clase 'availability-list' al <ul>
            this.addBotMessage(`<div class="bot-card"><h3>‚è∞ Horario Semanal de ${barberName}</h3><ul class="availability-list">${a}</ul></div>`);
            // --- FIN: MODIFICACI√ìN EST√âTICA ---
            
            this.showHorarioMenu();
        }
        
        async showAllBookings() {
            this.showTyping();
            const { data: bookings, error } = await supabase
                .from('bookings')
                .select('*, clients(first_name, last_name)')
                .eq('barber_id', this.barberProfile.id)
                .order('booking_date', { ascending: true });
            this.hideTyping();
            const backButtonHTML = `<div class="command-buttons-container" style="margin-top: 15px;"><button class="command-button full-width return" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button></div>`;
            if (error) {
                this.addBotMessage(`<div class="bot-card"><p>‚ùå Error al consultar tus citas.</p>${backButtonHTML}</div>`);
                console.error("Error fetching bookings:", error);
                return;
            }
            if (!bookings || bookings.length === 0) {
                this.addBotMessage(`<div class="bot-card"><h3>üìÖ Mis Citas</h3><p>No tienes ninguna cita programada por el momento.</p>${backButtonHTML}</div>`);
                return;
            }
            const bookingsList = bookings.map(b => {
                const date = new Date(b.booking_date);
                const clientName = b.clients ? `${b.clients.first_name} ${b.clients.last_name}` : 'Cliente';
                const formattedDate = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const formattedTime = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                // --- MODIFICACI√ìN MONEDA ---
                return `<li>
                    <span class="item-name">${b.service_name} con ${clientName} (${this.formatCurrency(b.price, b.currency)})</span>
                    <span class="item-detail">${formattedDate} - ${formattedTime}</span>
                </li>`;
            }).join('');
            this.addBotMessage(`<div class="bot-card"><h3>üìÖ Mis Citas Programadas</h3><ul>${bookingsList}</ul>${backButtonHTML}</div>`);
        }

        async showNewBookings() {
            this.switchView('botView');
            const bookingsToProcess = [...this.newBookingsData];
            this.newBookingsData = [];
            this.updateBadges();
            const backButtonHTML = `<div class="command-buttons-container" style="margin-top: 15px;"><button class="command-button full-width return" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button></div>`;
            if (bookingsToProcess.length === 0) {
                this.addBotMessage(`<div class="bot-card"><h3>üîî Notificaciones de Citas</h3><p>No tienes ninguna cita nueva en este momento.</p><hr style="border: 0; border-top: 1px solid #f1f3f5; margin: 10px 0;"><p style="font-size: 0.9em; color: #666;">Para ver todas tus citas (nuevas y antiguas), usa el comando <strong>/citas</strong>.</p>${backButtonHTML}</div>`);
                return;
            }
            this.showTyping();
            const clientIds = [...new Set(bookingsToProcess.map(b => b.client_id))];
            const { data: clients, error } = await supabase
                .from('clients')
                .select('id, first_name, last_name')
                .in('id', clientIds);
            this.hideTyping();
            if (error) {
                 this.addBotMessage(`<div class"bot-card"><p>‚ùå Error al cargar los nombres de los clientes para las notificaciones.</p>${backButtonHTML}</div>`);
                 return;
            }
            const clientMap = new Map(clients.map(c => [c.id, `${c.first_name} ${c.last_name}`]));
            const bookingsListHTML = bookingsToProcess.map(b => {
                const date = new Date(b.booking_date);
                const clientName = clientMap.get(b.client_id) || 'Cliente Desconocido';
                const formattedDate = date.toLocaleDateString('es-ES', { weekday: 'short', day: '2-digit', month: 'short' });
                const formattedTime = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const barberPerformer = b.barber_name || 'Staff';
                return `<li>
                    <span class="item-name">${b.service_name} con <strong>${clientName}</strong> (Atiende: ${barberPerformer})</span>
                    <span class="item-detail">${formattedDate} - ${formattedTime}</span>
                </li>`;
            }).join('');
            const finalCard = `
            <div class="bot-card">
                <h3>üîî ¬°${bookingsToProcess.length} Cita(s) Nueva(s)!</h3>
                <p>Aqu√≠ est√°n los detalles de las nuevas reservas:</p>
                <ul>${bookingsListHTML}</ul>
                <div class="command-buttons-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <button class="command-button" data-command="/citas">Ver Todas las Citas</button>
                    <button class="command-button return" data-command="menu">Volver al Men√∫</button>
                </div>
            </div>`;
            this.addBotMessage(finalCard);
        }

        async promptDateForAvailability() {
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            const formatDateForCommand = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            const promptHTML = `<div class="bot-card">
                <h3>üîç Ver Disponibilidad</h3>
                <p>Por favor, selecciona una fecha para revisar los horarios disponibles y ocupados.</p>
                <div class="command-buttons-container">
                    <button class="command-button" data-command="check_availability:${formatDateForCommand(today)}">Hoy</button>
                    <button class="command-button" data-command="check_availability:${formatDateForCommand(tomorrow)}">Ma√±ana</button>
                </div>
                <p class="helper-text">Pr√≥ximamente podr√°s escribir una fecha espec√≠fica.</p>
            </div>`;
            this.addBotMessage(promptHTML);
        }

        async showAvailabilityForDate(date, barberName = null) {
            this.showTyping();
            const profile = await this.getBarberProfile();
            const allBarbers = Object.keys(profile.availability || {});
            if (profile.is_team_account && !barberName) {
                const buttonsHTML = allBarbers.map(name => 
                    `<button class="command-button" data-command="check_availability:${date.toISOString().split('T')[0]}:${name}">${name}</button>`
                ).join('');
                this.hideTyping();
                this.addBotMessage(`<div class="bot-card">
                    <h3>¬øPara qu√© barbero quieres ver la disponibilidad del ${date.toLocaleDateString()}?</h3>
                    <div class="command-buttons-container">${buttonsHTML}</div>
                    <div class="command-buttons-container" style="margin-top: 10px;"><button class="command-button full-width return" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button></div>
                </div>`);
                return;
            }
            if (!barberName) barberName = allBarbers[0];
            const backButtonHTML = `<div class="command-buttons-container" style="margin-top: 15px;"><button class="command-button full-width return" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button></div>`;
            const dayMapping = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const dayKey = dayMapping[date.getDay()];
            const barberSchedule = (profile.availability[barberName] || {})[dayKey] || [];
            if (barberSchedule.length === 0) {
                this.hideTyping();
                this.addBotMessage(`<div class="bot-card"><p><strong>${barberName}</strong> no trabaja el ${date.toLocaleDateString()}.</p>${backButtonHTML}</div>`);
                return;
            }
            const startOfDay = new Date(date); startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(date); endOfDay.setHours(23, 59, 59, 999);
            const { data: bookings, error } = await supabase.from('bookings').select('booking_date').eq('barber_name', barberName).in('status', ['pending', 'confirmed']).gte('booking_date', startOfDay.toISOString()).lte('booking_date', endOfDay.toISOString());
            
            // --- INICIO: MODIFICACI√ìN 30 MINUTOS ---
            // Convertimos las horas de las reservas a formato float (ej: 9:30 -> 9.5)
            const bookedSlots = bookings.map(b => {
                const d = new Date(b.booking_date);
                return d.getHours() + (d.getMinutes() / 60.0);
            });

            let bookedCount = 0;
            const slotsHTML = barberSchedule.map(hourSlot => {
                const isBooked = bookedSlots.includes(hourSlot);
                if (isBooked) bookedCount++;
                // Usamos formatTime para mostrar la hora (ej: 09:30)
                return `<div class="time-slot ${isBooked ? 'booked' : 'available'}">${this.formatTime(hourSlot)}</div>`;
            }).join('');
            
            const availableCount = barberSchedule.length - bookedCount;
            // --- FIN: MODIFICACI√ìN 30 MINUTOS ---

            this.hideTyping();
            const availabilityCard = `<div class="bot-card">
                <h3>Disponibilidad para ${barberName}</h3>
                <p><strong>Fecha:</strong> ${date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                <div class="availability-grid">${slotsHTML}</div>
                <div class="availability-stats">
                    <div class="stat-item"><span class="stat-value" style="color: #28a745;">${availableCount}</span><span class="stat-label">Disponibles</span></div>
                    <div class="stat-item"><span class="stat-value" style="color: #dc3545;">${bookedCount}</span><span class="stat-label">Ocupados</span></div>
                    <div class="stat-item"><span class="stat-value">${barberSchedule.length}</span><span class="stat-label">Total</span></div>
                </div>
                ${backButtonHTML} 
            </div>`;
            this.addBotMessage(availabilityCard);
        }

        async startDayEditFlow(dayKey) {
            const days = { mon: 'Lunes', tue: 'Martes', wed: 'Mi√©rcoles', thu: 'Jueves', fri: 'Viernes', sat: 'S√°bado', sun: 'Domingo' };
            const dayName = days[dayKey];
            let optionsHTML = '';
            // --- INICIO: MODIFICACI√ìN 30 MINUTOS ---
            // Generamos opciones de 30 en 30 min (ej: 7.0, 7.5, 8.0)
            // El bucle va hasta < 24 (para incluir 23:30)
            for (let i = 7; i < 24; i += 0.5) {
                optionsHTML += `<option value="${i}">${this.formatTime(i)}</option>`;
            }
            // --- FIN: MODIFICACI√ìN 30 MINUTOS ---
            const scheduleHTML = `<div class="bot-card">
                <h3>Configurar Horario para ${dayName}</h3>
                <p>Selecciona las horas de inicio y fin de la jornada. Las horas intermedias se a√±adir√°n autom√°ticamente.</p>
                <div class="schedule-selector">
                    <div class="schedule-row">
                        <label for="start-hour-${dayKey}">Desde:</label>
                        <select id="start-hour-${dayKey}">${optionsHTML}</select>
                    </div>
                    <div class="schedule-row">
                        <label for="end-hour-${dayKey}">Hasta:</label>
                        <select id="end-hour-${dayKey}">${optionsHTML}</select>
                    </div>
                </div>
                <div class="schedule-actions">
                     <button class="command-button confirm" data-day-confirm="${dayKey}">üíæ Guardar Horario</button>
                     <button class="command-button cancel" data-command="/horario-cerrado ${dayKey}">‚ùå Marcar como Cerrado</button>
                </div>
                 <button class="command-button full-width return" style="margin-top: 10px;" data-command="/horario-interno definir">‚Ü©Ô∏è Volver a los d√≠as</button>
            </div>`;
            this.addBotMessage(scheduleHTML);
            document.getElementById(`start-hour-${dayKey}`).value = '9';
            document.getElementById(`end-hour-${dayKey}`).value = '18';
        }

        async showFinanceMenu() {
            this.showTyping();
            await this.refreshProfileFromDB(); 
            const { data: transactions, error } = await supabase
                .from('transactions')
                .select('*')
                .eq('barber_id', this.barberProfile.id)
                .order('created_at', { ascending: false })
                .limit(5);
            this.hideTyping();
            let transactionsHTML = '<li><p>A√∫n no tienes transacciones.</p></li>';
            if (transactions && transactions.length > 0) {
                // --- MODIFICACI√ìN MONEDA ---
                transactionsHTML = transactions.map(t => {
                    const date = new Date(t.created_at).toLocaleDateString();
                    return `<li><span class="item-name">${t.description || 'Venta'} (${t.barber_name_performer})</span> <span class="item-detail" style="color: #28a745;">+${this.formatCurrency(t.amount, t.currency)}</span></li>`;
                }).join('');
            }
            const financeCard = `
            <div class="bot-card">
                <h3>üí∞ Finanzas</h3>
                <div class="stat-item" style="text-align: left; margin-bottom: 20px;">
                    <span class="stat-label">Tu Saldo Actual</span>
                    <span class="stat-value" style="font-size: 2em;">${this.formatCurrency(this.barberProfile.balance)}</span>
                </div>
                <h4>√öltimas Transacciones</h4>
                <ul>${transactionsHTML}</ul>
                <div class="command-buttons-container">
                    <button class="command-button confirm" data-command="/generar_qr">üì≤ Generar Cobro QR</button>
                    <button class="command-button return full-width" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button>
                </div>
            </div>`;
            this.addBotMessage(financeCard);
        }

        async promptForQRCodeGeneration() {
            const profile = await this.getBarberProfile();
            let barberSelectorHTML = '';
            if (profile.is_team_account) {
                const barbers = Object.keys(profile.availability || {});
                const options = barbers.map(b => `<option value="${b}">${b}</option>`).join('');
                barberSelectorHTML = `
                <div class="form-group">
                    <label for="qr-barber">Barbero:</label>
                    <select id="qr-barber" class="form-control">${options}</select>
                </div>`;
            }
            
            // --- MODIFICACI√ìN MONEDA ---
            const currencyCode = this.barberProfile?.currency_code || 'USD';
            
            const formHTML = `
            <div class="bot-card">
                <h3>Generar Cobro QR</h3>
                <div class="qr-form-container"> ${barberSelectorHTML}
                    <div class="form-group">
                        <label for="qr-amount">Monto (${currencyCode}):</label>
                        <input type="number" id="qr-amount" class="form-control" placeholder="Ej: 5.00">
                    </div>
                    <div class="form-group">
                        <label for="qr-desc">Descripci√≥n:</label>
                        <input type="text" id="qr-desc" class="form-control" placeholder="Ej: Corte de cabello">
                    </div>
                </div>
                <div class="command-buttons-container">
                    <button class="command-button confirm" onclick="app.generatePaymentQR()">Generar QR</button>
                    <button class="command-button return" data-command="/finanzas">Cancelar</button>
                </div>
            </div>`;
            this.addBotMessage(formHTML);
        }

        generatePaymentQR() {
            const amount = document.getElementById('qr-amount').value;
            const description = document.getElementById('qr-desc').value;
            const barberSelect = document.getElementById('qr-barber');
            const performer = barberSelect ? barberSelect.value : this.barberProfile.first_name;
            if (!amount || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
                alert("Por favor, introduce un monto v√°lido.");
                return;
            }

            // --- INICIO MODIFICACI√ìN MONEDA ---
            const paymentData = {
                barber_id: this.barberProfile.id,
                amount: parseFloat(amount).toFixed(2),
                description: description || 'Servicio de Barber√≠a',
                performer: performer,
                currency: this.barberProfile?.currency_code || 'USD' // <-- Se a√±ade la moneda
            };
            // --- FIN MODIFICACI√ìN MONEDA ---

            const qr = qrcode(0, 'M');
            qr.addData(JSON.stringify(paymentData));
            qr.make();

            // --- MODIFICACI√ìN MONEDA (en el mensaje) ---
            const qrCodeHTML = `
            <div class="bot-card">
                <h3>Muestra este QR al cliente</h3>
                <p>El cliente debe escanearlo desde su app para registrar el pago de <strong>${this.formatCurrency(paymentData.amount)}</strong></p>
                <div id="qrcode-display">${qr.createImgTag(6, 8)}</div>
                <p class="helper-text">Esperando confirmaci√≥n del cliente...</p>
                <div class="command-buttons-container">
                    <button class="command-button return full-width" data-command="/finanzas">‚Ü©Ô∏è Volver a Finanzas</button>
                </div>
            </div>`;
            this.addUserMessage(`Generar QR por ${this.formatCurrency(paymentData.amount)}`);
            this.addBotMessage(qrCodeHTML);
        }

        async addService(name, price) {
            const barberName = this.userData.selectedBarber;
            const p = parseFloat(price);
            if (isNaN(p) || p < 0) {
                this.addBotMessage('<div class="bot-card"><p>El precio no es v√°lido.</p></div>');
                this.showServicesMenu();
                return;
            }
            this.showTyping();
            const b = await this.getBarberProfile();
            const services = JSON.parse(JSON.stringify(b.services || {}));
            if (!services[barberName]) {
                services[barberName] = [];
            }
            services[barberName].push({ name: name, price: p });
            const { error } = await supabase
                .from('barbers')
                .update({ services: services })
                .eq('user_id', this.currentUser.id);
            this.hideTyping();
            if (error) {
                console.error("Error al guardar el servicio:", error);
                this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al guardar el servicio.</p></div>');
            } else {
                this.addBotMessage(`<div class="bot-card"><p>¬°Genial! ‚ú® He a√±adido "<strong>${name}</strong>" a los servicios de <strong>${barberName}</strong>.</p></div>`);
                await this.refreshProfileFromDB();
            }
            this.currentFlow = 'authenticated';
            await this.showServices();
        }
        
// --- INICIO DE LA CORRECCI√ìN: FUNCIONES PARA EDITAR/BORRAR SERVICIOS ---

        /**
         * Muestra los servicios del barbero actual como botones para que seleccione uno para editar.
         * Esta es la funci√≥n que faltaba y que el bot√≥n "Editar / Borrar" deb√≠a llamar.
         */
        async promptServiceSelectionToEdit() {
            const barberName = this.userData.selectedBarber;
            const b = await this.getBarberProfile();
            const servicesOfBarber = (b.services || {})[barberName] || [];

            if (servicesOfBarber.length === 0) {
                this.addBotMessage(`<div class="bot-card"><p><strong>${barberName}</strong> no tiene servicios para editar.</p></div>`);
                this.showServicesMenu();
                return;
            }

            const buttonsHTML = servicesOfBarber.map(s => {
                // Convertimos el objeto de servicio a un string JSON para pasarlo en el data-attribute
                const serviceJSONString = JSON.stringify(s).replace(/"/g, "'"); // Usamos comillas simples
                // --- MODIFICACI√ìN MONEDA ---
                return `<button class="command-button" data-service-edit="${serviceJSONString}">${s.name} (${this.formatCurrency(s.price)})</button>`;
            }).join('');

            const menuHTML = `<div class="bot-card">
                <h3>Editar/Borrar Servicio</h3>
                <p>Por favor, selecciona el servicio que quieres modificar para <strong>${barberName}</strong>.</p>
                <div class="command-buttons-container">
                    ${buttonsHTML}
                    <button class="command-button full-width return" data-command="/servicios-interno">‚Ü©Ô∏è Volver a Servicios</button>
                </div>
            </div>`;
            this.addBotMessage(menuHTML);
        }

        /**
         * Inicia el flujo de edici√≥n para un servicio espec√≠fico.
         * Se llama cuando el barbero hace clic en uno de los servicios de la lista anterior.
         */
        async startServiceEditFlow(serviceJSONString) {
            try {
                const service = JSON.parse(serviceJSONString.replace(/'/g, '"'));
                this.userData.tempService = service; // Guardamos el servicio que estamos editando
                this.currentFlow = 'editing_service'; // Establecemos el nuevo flujo

                // --- MODIFICACI√ìN MONEDA ---
                const menuHTML = `<div class="bot-card">
                    <h3>Modificando: ${service.name} (${this.formatCurrency(service.price)})</h3>
                    <p>¬øQu√© te gustar√≠a hacer?</p>
                    <div class="command-buttons-container">
                        <button class="command-button" data-command="/servicio_edit_name">‚úèÔ∏è Cambiar Nombre</button>
                        <button class="command-button" data-command="/servicio_edit_price">üí≤ Cambiar Precio</button>
                        <button class="command-button cancel" data-command="/servicio_delete_confirm">üóëÔ∏è Borrar Servicio</button>
                        <button class="command-button full-width return" data-command="/servicios-interno editar">‚Ü©Ô∏è Volver a la lista</button>
                    </div>
                </div>`;
                this.addBotMessage(menuHTML);
            } catch (e) {
                console.error("Error al parsear el servicio para editar:", e);
                this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al seleccionar ese servicio.</p></div>');
                this.currentFlow = 'authenticated';
                this.showServicesMenu();
            }
        }

        /**
         * Maneja los comandos dentro del flujo 'editing_service' (cambiar nombre, precio, borrar).
         */
        async handleServiceEditFlow(input, originalText) {
            switch(input) {
                case '/servicio_edit_name':
                    this.addBotMessage(`<div class="bot-card"><p>Introduce el <strong>nuevo nombre</strong> para "${this.userData.tempService.name}":</p></div>`);
                    this.currentFlow = 'editing_service_name';
                    break;
                case '/servicio_edit_price':
                    this.addBotMessage(`<div class="bot-card"><p>Introduce el <strong>nuevo precio</strong> para "${this.userData.tempService.name}" (s√≥lo el n√∫mero):</p></div>`);
                    this.currentFlow = 'editing_service_price';
                    break;
                case '/servicio_delete_confirm':
                    this.addBotMessage(`<div class="bot-card">
                        <p><strong>¬øEst√°s seguro?</strong> üßê</p>
                        <p>Vas a borrar el servicio: <strong>${this.userData.tempService.name}</strong>.</p>
                        <p style="color: #F44336;">Esta acci√≥n no se puede deshacer.</p>
                        <div class="command-buttons-container">
                            <button class="command-button cancel" data-command="/servicio_delete_do">S√≠, Borrar</button>
                            <button class="command-button" data-command="/servicios-interno editar">No, Cancelar</button>
                        </div>
                    </div>`);
                    break;
                case '/servicio_delete_do':
                    await this.deleteService();
                    break;
                case '/servicios-interno editar': // Bot√≥n de volver
                    this.userData.tempService = null;
                    this.currentFlow = 'authenticated';
                    await this.promptServiceSelectionToEdit();
                    break;
                default:
                    this.addBotMessage('<div class="bot-card"><p>Por favor, usa uno de los botones.</p></div>');
                    await this.startServiceEditFlow(JSON.stringify(this.userData.tempService).replace(/"/g, "'"));
                    break;
            }
        }

        /**
         * Actualiza el nombre o el precio de un servicio en la base de datos.
         */
        async updateService(field, value) {
            this.showTyping();
            const barberName = this.userData.selectedBarber;
            const oldService = this.userData.tempService;
            let newValue = value;

            if (field === 'price') {
                newValue = parseFloat(value);
                if (isNaN(newValue) || newValue < 0) {
                    this.hideTyping();
                    this.addBotMessage('<div class="bot-card"><p>‚ùå El precio no es v√°lido. Debe ser un n√∫mero (ej: 10.50).</p></div>');
                    this.currentFlow = 'editing_service';
                    await this.startServiceEditFlow(JSON.stringify(oldService).replace(/"/g, "'"));
                    return;
                }
            } else if (field === 'name') {
                newValue = this.capitalizeName(value);
            }

            const b = await this.getBarberProfile();
            const services = JSON.parse(JSON.stringify(b.services || {}));
            const servicesOfBarber = services[barberName] || [];
            
            const serviceIndex = servicesOfBarber.findIndex(s => s.name === oldService.name);
            
            if (serviceIndex === -1) {
                this.hideTyping();
                this.addBotMessage('<div class="bot-card"><p>‚ùå No pude encontrar el servicio para actualizar. Volviendo al men√∫.</p></div>');
            } else {
                servicesOfBarber[serviceIndex][field] = newValue;
                services[barberName] = servicesOfBarber;

                const { error } = await supabase.from('barbers').update({ services: services }).eq('user_id', this.currentUser.id);
                this.hideTyping();

                if (error) {
                    this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al actualizar el servicio.</p></div>');
                } else {
                    this.addBotMessage(`<div class="bot-card"><p>‚úÖ ¬°Servicio actualizado con √©xito!</p></div>`);
                    await this.refreshProfileFromDB();
                }
            }
            
            this.userData.tempService = null;
            this.currentFlow = 'authenticated';
            this.showServicesMenu();
        }

        /**
         * Borra un servicio de la base de datos.
         */
        async deleteService() {
            this.showTyping();
            const barberName = this.userData.selectedBarber;
            const serviceToDelete = this.userData.tempService;

            const b = await this.getBarberProfile();
            const services = JSON.parse(JSON.stringify(b.services || {}));
            let servicesOfBarber = services[barberName] || [];

            servicesOfBarber = servicesOfBarber.filter(s => s.name !== serviceToDelete.name);
            services[barberName] = servicesOfBarber;

            const { error } = await supabase.from('barbers').update({ services: services }).eq('user_id', this.currentUser.id);
            this.hideTyping();

            if (error) {
                this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al borrar el servicio.</p></div>');
            } else {
                this.addBotMessage(`<div class="bot-card"><p>‚úÖ El servicio "<strong>${serviceToDelete.name}</strong>" ha sido eliminado.</p></div>`);
                await this.refreshProfileFromDB();
            }

            this.userData.tempService = null;
            this.currentFlow = 'authenticated';
            this.showServicesMenu();
        }

        // --- FIN DE LA CORRECCI√ìN ---
        
        async setAvailability(dayKey, hours) {
            const barberName = this.userData.selectedBarber;
            if (!barberName) { this.addBotMessage('<div class="bot-card"><p>Error: No se ha seleccionado un barbero.</p></div>'); return; }
            
            const b = await this.getBarberProfile();
            let avail = b.availability || {};
            if (!avail[barberName]) avail[barberName] = {};
            avail[barberName][dayKey] = Array.isArray(hours) ? hours.sort((a,b) => a-b) : [];
            
            const { error } = await supabase.from('barbers').update({ availability: avail }).eq('user_id', this.currentUser.id);
            if (!error) {
                this.addBotMessage(`<div class="bot-card"><p>¬°Perfecto! El horario de <strong>${barberName}</strong> ha sido guardado. üëç</p></div>`);
            } else {
                 this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al guardar el horario.</p></div>');
            }
            this.currentFlow = 'authenticated';
            await this.showAvailability();
        }

        // --- INICIO: FUNCI√ìN 'checkAuthState' MODIFICADA PARA APROBACI√ìN ---
        async checkAuthState() { 
            this.showTyping(); 
            const { data: { session } } = await supabase.auth.getSession(); 
            this.hideTyping(); 
            
            if (session && session.user) { 
                this.currentUser = session.user; 
                
                // 1. Obtenemos el perfil del barbero
                const { data, error } = await supabase.from('barbers').select('*').eq('user_id', this.currentUser.id).single();
                
                if (data) {
                    this.barberProfile = data;

                    // 2. --- ¬°AQU√ç EST√Å LA L√ìGICA DE APROBACI√ìN! ---
                    if (!this.barberProfile.is_approved) {
                        this.showPendingApproval(); // Muestra la pantalla de "pendiente"
                        return; // Detiene la ejecuci√≥n. No puede continuar.
                    }
                    // --- FIN DE LA L√ìGICA DE APROBACI√ìN ---

                    // 3. Si S√ç est√° aprobado, contin√∫a normalmente:
                    const name = this.barberProfile.first_name || this.currentUser.email; 
                    this.addBotMessage(`<div class="bot-card"><p>¬°Qu√© bueno verte de nuevo, <strong>${name}</strong>! üëã</p><p>Estoy listo para ayudarte a organizar tu d√≠a.</p></div>`); 
                    this.showMainMenu(); 
                    this.currentFlow = 'authenticated'; 
                    this.messageInput.disabled = false; // Asegurarse de que el input est√© habilitado
                    this.sendButton.disabled = false;
                    this.messageInput.placeholder = "Escribe un mensaje...";
                    
                    this.subscribeToNotifications(); 
                    this.subscribeToBookings();
                    this.subscribeToTransactions();
                
                } else if (error) {
                    // Esto puede pasar si el usuario se registr√≥ (auth.users) pero el perfil (barbers) fall√≥ al crearse.
                    this.addBotMessage('<div class="bot-card"><p>‚ùå Error cr√≠tico: No pudimos encontrar tu perfil de barbero. Contacta a soporte.</p></div>');
                    await this.logout();
                }

            } else { 
                this.startWelcomeFlow(); 
            } 
        }
        // --- FIN: FUNCI√ìN 'checkAuthState' MODIFICADA ---

        startWelcomeFlow() { this.addBotMessage(`<div class="bot-card"><h3>¬°Bienvenido a BarberConnect! üíà</h3><p>Soy tu asistente virtual, y estoy aqu√≠ para ayudarte a gestionar tu barber√≠a de forma sencilla.</p><p>Para empezar, ¬øeres un <strong>barbero</strong>?</p></div>`); this.currentFlow = 'welcome'; }
        
        async handleAuthFlow(input, originalText = null) {
            if (originalText === null) originalText = input;
            switch(this.currentFlow) {
                case 'welcome':
                    if (input === 'barbero') {
                        this.addBotMessage(`<div class="bot-card"><p>¬°Excelente! ¬øYa tienes una cuenta con nosotros?</p><p>Por favor, responde <strong>s√≠</strong> o <strong>no</strong>.</p></div>`);
                        this.currentFlow = 'has_account';
                    } else {
                        this.addBotMessage(`<div class="bot-card"><p>Entendido. Esta interfaz est√° dise√±ada especialmente para barberos. ¬°Esperamos verte pronto!</p></div>`);
                    }
                    break;
                case 'has_account':
                    if (input.startsWith('s')) {
                        this.addBotMessage('<div class="bot-card"><p>¬°Perfecto! Por favor, ingresa tu correo electr√≥nico para iniciar sesi√≥n.</p></div>');
                        this.currentFlow = 'login_email';
                    } else {
                        this.addBotMessage('<div class="bot-card"><p>¬°Genial, vamos a crear tu cuenta! Primero, ¬øcu√°l es tu nombre?</p></div>');
                        this.currentFlow = 'register_name';
                    }
                    break;
                case 'register_name':
                    this.userData.firstName = originalText;
                    this.addBotMessage(`<div class="bot-card"><p>¬°Un placer, ${this.capitalizeName(originalText)}! Ahora, ¬øcu√°l es tu apellido?</p></div>`);
                    this.currentFlow = 'register_last_name';
                    break;
                case 'register_last_name':
                    this.userData.lastName = originalText;
                    this.addBotMessage('<div class="bot-card"><p>Muy bien. Ahora necesito tu correo electr√≥nico. Lo usaremos para iniciar sesi√≥n.</p></div>');
                    this.currentFlow = 'register_email';
                    break;
                case 'register_email':
                    this.userData.email = input;
                    this.addBotMessage('<div class="bot-card"><p>Para terminar, crea una contrase√±a segura (debe tener al menos 6 caracteres).</p></div>');
                    this.currentFlow = 'register_password';
                    break;
                case 'register_password':
                    if (input.length < 6) {
                        this.addBotMessage('<div class="bot-card"><p>La contrase√±a es muy corta. Por seguridad, necesita al menos 6 caracteres. ¬°Intenta con otra!</p></div>');
                        return;
                    }
                    this.userData.password = input;
                    await this.registerUser();
                    break;
                case 'login_email':
                    this.userData.email = input;
                    this.addBotMessage('<div class="bot-card"><p>Gracias. Ahora, ingresa tu contrase√±a.</p></div>');
                    this.currentFlow = 'login_password';
                    break;
                case 'login_password':
                    await this.loginUser(input);
                    break;
            }
        }
        
        async registerUser() {
            const firstNameFormatted = this.capitalizeName(this.userData.firstName);
            const lastNameFormatted = this.capitalizeName(this.userData.lastName);
            const { data, error } = await supabase.auth.signUp({
                email: this.userData.email,
                password: this.userData.password,
                options: {
                    data: {
                        first_name: firstNameFormatted,
                        last_name: lastNameFormatted,
                        user_type: 'barbero'
                    }
                }
            });
            if (error) {
                this.addBotMessage(`<div class="bot-card"><p>‚ùå Hubo un error en el registro: ${error.message}. Por favor, int√©ntalo de nuevo.</p></div>`);
                this.startWelcomeFlow();
                return;
            }
            if (data.user) {
                this.currentUser = data.user;
                // --- INICIO: MODIFICACI√ìN DE APROBACI√ìN ---
                // Pasamos el email a createBarberProfile
                await this.createBarberProfile(data.user.id, this.userData.email);
                
                // Obtenemos el perfil reci√©n creado para mostrar la pantalla de pendiente
                const { data: profileData } = await supabase.from('barbers').select('*').eq('user_id', this.currentUser.id).single();
                if (profileData) {
                    this.barberProfile = profileData;
                }
                
                // Mostramos la pantalla de pendiente en lugar del men√∫ principal
                this.showPendingApproval();
                // --- FIN: MODIFICACI√ìN DE APROBACI√ìN ---
            }
        }
        
        // --- INICIO: FUNCI√ìN 'createBarberProfile' MODIFICADA ---
        async createBarberProfile(userId, email) {
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            const barberName = this.capitalizeName(this.userData.firstName);
            const shopName = `Barber√≠a de ${barberName}`;
            const initialAvailability = { [barberName]: {} };
            const initialServices = { [barberName]: [] };
            
            // A√±adimos el email y 'is_approved: false' (aunque ya es el default)
            // --- MODIFICACI√ìN MONEDA: Se a√±ade 'currency_code' ---
            await supabase.from('barbers').insert([{ 
                user_id: userId, 
                email: email, // Columna de email
                first_name: barberName,
                last_name: this.capitalizeName(this.userData.lastName),
                barber_shop_name: shopName, 
                services: initialServices,
                availability: initialAvailability,
                public_code: code,
                is_team_account: false,
                balance: 0,
                is_approved: false, // Columna de aprobaci√≥n
                currency_code: 'USD' // <-- Moneda por defecto
            }]); 
        }
        // --- FIN: FUNCI√ìN 'createBarberProfile' MODIFICADA ---

        async loginUser(password) {
            this.showTyping();
            const { data, error } = await supabase.auth.signInWithPassword({
                email: this.userData.email,
                password: password
            });
            this.hideTyping();
            if (error) {
                console.error("Error de inicio de sesi√≥n de Supabase:", error);
                
                // (Ya no necesitamos la comprobaci√≥n de 'Email not confirmed' porque la quitamos)
                this.addBotMessage(
                    `<div class="bot-card">
                        <p>‚ùå Usuario o contrase√±a incorrectos.</p>
                        <small style="color: #A0A0A0;">Por favor, int√©ntalo de nuevo.</small>
                    </div>`
                );

                this.currentFlow = 'has_account';
                setTimeout(() => this.handleAuthFlow('si'), 1500);
                return;
            }
            this.currentUser = data.user;
            this.addBotMessage('<div class="bot-card"><p>‚úÖ ¬°Inicio de sesi√≥n exitoso!</p></div>');
            await this.checkAuthState(); // 'checkAuthState' se encargar√° de aprobar o bloquear
        }
        
        async logout() { 
            await supabase.auth.signOut(); 
            if (this.notificationsSubscription) { this.notificationsSubscription.unsubscribe(); this.notificationsSubscription = null; } 
            if (this.bookingsSubscription) { this.bookingsSubscription.unsubscribe(); this.bookingsSubscription = null; } 
            if (this.chatSubscription) { this.chatSubscription.unsubscribe(); this.chatSubscription = null; } 
            if (this.transactionsSubscription) { this.transactionsSubscription.unsubscribe(); this.transactionsSubscription = null; }
            this.currentUser = null; this.barberProfile = null; this.userData = {}; 
            
            this.addBotMessage('<div class="bot-card"><p>¬°Hasta pronto! Tu sesi√≥n se ha cerrado de forma segura. üëã</p></div>'); 
            
            // Habilitar la entrada de texto de nuevo para el flujo de bienvenida
            this.messageInput.disabled = false;
            this.sendButton.disabled = false;
            this.messageInput.placeholder = "Escribe un mensaje...";

            setTimeout(() => { this.messagesContainer.innerHTML = ''; this.startWelcomeFlow(); }, 1500); 
        }
        
        async subscribeToNotifications() { 
            if (this.notificationsSubscription || !this.barberProfile) return; 
            const { data: chats, error } = await supabase.from('chats').select('id').eq('barber_id', this.barberProfile.id); 
            if (error || !chats || chats.length === 0) return; 
            const chatIds = chats.map(c => c.id); 
            this.notificationsSubscription = supabase.channel('barber_notifications')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=in.(${chatIds.join(',')})` }, payload => { 
                    if (payload.new.sender_type === 'client' && payload.new.chat_id !== this.activeChat.id) { 
                        const chatId = payload.new.chat_id;
                        this.unreadCounts[chatId] = (this.unreadCounts[chatId] || 0) + 1;
                        this.updateBadges();
                        const indicator = document.getElementById(`unread-${chatId}`); 
                        if (indicator) indicator.classList.add('visible'); 
                    } 
                }).subscribe(); 
        }

        async subscribeToBookings() {
            if (this.bookingsSubscription || !this.barberProfile) return;
            this.bookingsSubscription = supabase
                .channel('barber_bookings')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'bookings',
                    filter: `barber_id=eq.${this.barberProfile.id}`
                }, payload => {
                    this.newBookingsData.push(payload.new);
                    this.updateBadges();
                })
                .subscribe();
        }
        async subscribeToTransactions() {
            if (this.transactionsSubscription || !this.barberProfile) return;
            
            this.transactionsSubscription = supabase
                .channel(`barber_transactions_${this.barberProfile.id}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'transactions',
                    filter: `barber_id=eq.${this.barberProfile.id}`
                }, async (payload) => {
                    
                    // --- Esta es la l√≥gica que ya ten√≠as ---
                    this.newTransactionsCount++;
                    this.updateBadges();
                    await this.refreshProfileFromDB(); // Actualiza el saldo
                    
                    const newTransaction = payload.new;

                    // --- INICIO DE LA NUEVA L√ìGICA ---

                    // 1. Buscamos si la tarjeta del QR est√° visible en el chat
                    const qrDisplayElement = document.getElementById('qrcode-display');
                    
                    if (qrDisplayElement) {
                        // 2. Si est√° visible, encontramos su tarjeta contenedora
                        const qrCard = qrDisplayElement.closest('.bot-card');
                        if (qrCard) {
                            
                            // 3. Obtenemos el nombre del cliente
                            const clientName = (await this.getClientNameById(newTransaction.client_id)) || 'un cliente';

                            // 4. Reemplazamos el contenido de la tarjeta
                            // --- MODIFICACI√ìN MONEDA ---
                            qrCard.innerHTML = `
                                <h3>‚úÖ ¬°Pago Confirmado!</h3>
                                <p>Has recibido un pago de <strong>${this.formatCurrency(newTransaction.amount, newTransaction.currency)}</strong> por "${newTransaction.description}" de <strong>${clientName}</strong>.</p>
                                <p>Tu saldo ha sido actualizado.</p>
                                <div class="command-buttons-container">
                                    <button class="command-button" data-command="/finanzas">Ver Finanzas</button>
                                    <button class="command-button return full-width" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button>
                                </div>
                            `;
                            // Reactivamos los botones por si acaso
                            qrCard.querySelectorAll('.command-button').forEach(btn => btn.disabled = false);
                        }
                    } 
                    // 5. Si no estamos viendo el QR, pero s√≠ el men√∫ de finanzas...
                    else if (document.querySelector('[data-command="/finanzas"]')) {
                         // Esta es la l√≥gica que ya ten√≠as
                         this.addBotMessage(`<div class="bot-card" style="border-left: 4px solid #28a745;"><p><strong>¬°Nuevo pago recibido!</strong> Tu saldo ha sido actualizado.</p></div>`);
                    }
                    
                    // --- FIN DE LA NUEVA L√ìGICA ---
                })
                .subscribe();
        }

        
       async showClientChats() { 
            // 1. MODIFICACI√ìN: Pedimos tambi√©n la 'avatar_url' del cliente
            const { data: chats, error } = await supabase.from('chats').select(`id, clients (id, first_name, last_name, avatar_url)`).eq('barber_id', this.barberProfile.id); 
            
            if (error) { console.error(error); return; } 
            
            this.clientChatsList.innerHTML = ''; 
            
            if (chats.length === 0) { 
                this.clientChatsList.innerHTML = '<li>A√∫n no tienes ninguna conversaci√≥n. Cuando un cliente te contacte, aparecer√° aqu√≠.</li>'; 
            } else { 
                chats.forEach(chat => { 
                    const client = chat.clients;
                    if (client) {
                        const li = document.createElement('li');
                        const unreadClass = (this.unreadCounts[chat.id] || 0) > 0 ? 'visible' : '';

                        // 2. MODIFICACI√ìN: L√≥gica para decidir si mostrar imagen o iniciales
                        let avatarHTML = '';
                        if (client.avatar_url) {
                            avatarHTML = `<div class="avatar"><img src="${client.avatar_url}" alt="Avatar"></div>`;
                        } else {
                            const initials = (client.first_name ? client.first_name[0] : '') + (client.last_name ? client.last_name[0] : '');
                            avatarHTML = `<div class="avatar">${initials.toUpperCase()}</div>`; // Lo pongo en may√∫sculas
                        }

                        // 3. MODIFICACI√ìN: Usamos la nueva variable avatarHTML
                        li.innerHTML = `
                            ${avatarHTML}
                            <div class="chat-info">
                                <div class="chat-name">${client.first_name} ${client.last_name}</div>
                            </div>
                            <span class="unread-indicator ${unreadClass}" id="unread-${chat.id}"></span>`;
                        
                        // --- INICIO: MODIFICACI√ìN ---
                        // 4. Pasamos la client.avatar_url a la funci√≥n openClientChat
                        li.addEventListener('click', () => this.openClientChat(chat.id, `${client.first_name} ${client.last_name}`, client.id, client.avatar_url));
                        // --- FIN: MODIFICACI√ìN ---
                        
                        this.clientChatsList.appendChild(li);
                    }
                }); 
            } 
            this.switchView('clientChatsView'); 
        }

       // --- INICIO: MODIFICACI√ìN ---
       // 1. A√±adido 'clientAvatarUrl' como par√°metro
       async openClientChat(chatId, clientName, clientId, clientAvatarUrl) { 
       // --- FIN: MODIFICACI√ìN ---

            // --- CORRECCI√ìN (ya estaba) ---
            // 1. Guardar los datos PRIMERO
            this.activeChat.id = chatId; 
            this.activeChat.clientName = clientName; 
            this.activeChat.clientId = clientId; 
            // --- INICIO: MODIFICACI√ìN ---
            // 2. Guardar el avatar
            this.activeChat.clientAvatar = clientAvatarUrl; 
            // --- FIN: MODIFICACI√ìN ---
            
            // 3. Cambiar la vista DESPU√âS
            this.switchView('singleChatView'); // Ahora s√≠ leer√° el nombre y avatar correctos
            // --- FIN CORRECCI√ìN ---

            this.singleChatMessages.innerHTML = ''; 
            this.unreadCounts[chatId] = 0; 
            this.updateBadges(); 
            const chatIndicator = document.getElementById(`unread-${chatId}`); 
            if (chatIndicator) chatIndicator.classList.remove('visible'); 
            const { data: messages, error } = await supabase.from('messages').select('*').eq('chat_id', chatId).order('created_at'); 
            if (messages) { messages.forEach(msg => this.renderMessage(msg, this.singleChatMessages, false)); } 
            this.singleChatMessages.scrollTop = this.singleChatMessages.scrollHeight;

            if (this.chatSubscription) this.chatSubscription.unsubscribe();
            this.chatSubscription = supabase.channel(`chat-room-${chatId}`)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}`},
                    payload => {
                        if (payload.new.sender_type === 'client') this.renderMessage(payload.new);
                    }
                ).subscribe();
        }

        async sendClientMessage(text) {
            const payload = { chat_id: this.activeChat.id, sender_id: this.barberProfile.id, sender_type: 'barber', content: text };
            this.renderMessage({ ...payload, sender: 'user' }, this.singleChatMessages);
            await supabase.from('messages').insert(payload);
        }
    }

    let app;
    document.addEventListener('DOMContentLoaded', () => {
        app = new ChatApp();

        // --- INICIO: MEJORA TEXTO DIN√ÅMICO ---
        function startDynamicText() {
            const words = ["Agenda", "Clientes", "Finanzas", "Horarios", "Servicios"];
            const dynamicTextEl = document.getElementById('dynamic-text');
            
            // Si el elemento no existe (p.ej. en Cliente.html), no hacer nada
            if (!dynamicTextEl) return;

            let wordIndex = 0;
            let charIndex = 0;
            let isDeleting = false;
            let typeSpeed = 150; // Velocidad de tecleo
            let deleteSpeed = 100; // Velocidad de borrado
            let pauseTime = 2000; // Pausa al final de la palabra

            function type() {
                const currentWord = words[wordIndex];
                let displayText = '';
                let timeout = typeSpeed;

                if (isDeleting) {
                    // Estamos borrando
                    displayText = currentWord.substring(0, charIndex - 1);
                    charIndex--;
                    timeout = deleteSpeed;
                } else {
                    // Estamos escribiendo
                    displayText = currentWord.substring(0, charIndex + 1);
                    charIndex++;
                }

                dynamicTextEl.innerHTML = displayText;

                if (!isDeleting && charIndex === currentWord.length) {
                    // Palabra terminada de escribir, pausar y empezar a borrar
                    timeout = pauseTime;
                    isDeleting = true;
                } else if (isDeleting && charIndex === 0) {
                    // Palabra terminada de borrar, pasar a la siguiente
                    isDeleting = false;
                    wordIndex = (wordIndex + 1) % words.length; // Loop
                }

                setTimeout(type, timeout);
            }
            
            // Iniciar la animaci√≥n
            setTimeout(type, 500); // Peque√±a pausa inicial
        }
        
        startDynamicText(); // <-- Aqu√≠ llamamos a la nueva funci√≥n
        // --- FIN: MEJORA TEXTO DIN√ÅMICO ---
    });
</script>
</body>
</html>

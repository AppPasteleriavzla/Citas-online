<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarberConnect</title>
<link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <style>
        /* Estilos base (sin cambios) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-container { width: 100%; max-width: 400px; height: 100vh; background: white; display: flex; flex-direction: column; box-shadow: 0 0 10px rgba(0,0,0,0.1); overflow: hidden; }
      .chat-header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 20px; 
            /* text-align: center; <-- Eliminado */
            border-bottom: 1px solid #e0e0e0; 
            position: relative;
            display: flex;
            justify-content: space-between; /* <-- Modificado */
            align-items: center;
        }
        .chat-header h1 { margin: 0; font-size: 1.5em; }
        .chat-header p { margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em; }
        .back-button { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 1.5em; cursor: pointer; display: none; }
        .messages-container { flex: 1; padding: 15px; overflow-y: auto; background: #f8f9fa; }
        .message { margin-bottom: 12px; display: flex; flex-direction: column; animation: fadeIn 0.3s ease-in; }
        .message.user { align-items: flex-end; }
        .message.bot { align-items: flex-start; }
        .message-content { padding: 10px 14px; border-radius: 18px; max-width: 85%; word-wrap: break-word; line-height: 1.4; }
        .message.user .message-content { background: #764ba2; color: white; border-bottom-right-radius: 4px; }
        .message.bot .message-content { background: #e9ecef; color: #333; border-bottom-left-radius: 4px; }
        .message.bot .bot-card-wrapper { background: transparent; padding: 0; border: none; max-width: 95%; }
        .message-time { font-size: 0.7em; color: #666; margin-top: 4px; padding: 0 8px; }
        .typing { display: flex; padding: 10px 14px; background: white; border-radius: 18px; border-bottom-left-radius: 4px; border: 1px solid #e0e0e0; }
        .typing span { height: 6px; width: 6px; background: #999; border-radius: 50%; display: block; margin: 0 2px; animation: typing 1s infinite ease-in-out; }
        .typing span:nth-child(1) { animation-delay: 0.2s; }
        .typing span:nth-child(2) { animation-delay: 0.4s; }
        .typing span:nth-child(3) { animation-delay: 0.6s; }
        .input-container { display: flex; padding: 12px; background: white; border-top: 1px solid #e0e0e0; gap: 8px; }
        .message-input { flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px; outline: none; font-size: 14px; }
        .send-button { padding: 10px 16px; background: #007bff; color: white; border: none; border-radius: 20px; cursor: pointer; }
        .send-button:disabled { background: #ccc; cursor: not-allowed; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        .bot-card { background-color: #ffffff; border: 1px solid #e9ecef; border-radius: 12px; padding: 16px; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .bot-card h3 { margin: 0 0 12px 0; color: #343a40; border-bottom: 1px solid #f1f3f5; padding-bottom: 8px; font-size: 1.1em; }
        .bot-card h4 { margin-top: 20px; margin-bottom: 8px; padding-top: 12px; border-top: 1px solid #f1f3f5; }
        .bot-card p { margin: 0 0 8px 0; line-height: 1.5; color: #495057; }
        .bot-card ul { list-style: none; padding: 0; margin: 0; }
        .bot-card li { padding: 8px 0; border-bottom: 1px solid #f1f3f5; display: flex; justify-content: space-between; align-items: center; }
        .bot-card li:last-child { border-bottom: none; }
        .bot-card .item-name { font-weight: 500; color: #212529; }
        .bot-card .item-detail { color: #6c757d; font-size: 0.9em; text-align: right; }
        .bot-card .helper-text { font-size: 0.8em; color: #888; margin-top: 5px; }
        .command-buttons-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
        .command-button { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px 8px; font-size: 0.9em; font-weight: 500; color: #495057; cursor: pointer; text-align: center; transition: background-color 0.2s, box-shadow 0.2s; width: 100%; }
        .command-button:hover { background-color: #e9ecef; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .command-button.full-width { grid-column: 1 / -1; }
        .command-button.confirm { background-color: #28a745; color: white; }
        .command-button.cancel { background-color: #dc3545; color: white; }
        .command-button.return { background-color: #f1f3f5; color: #888; }
        .schedule-selector, .qr-form { display: flex; flex-direction: column; gap: 12px; }
        .schedule-row, .qr-form-row { display: flex; align-items: center; gap: 10px; }
        .schedule-row label, .qr-form-row label { font-weight: 500; color: #495057; flex-basis: 100px; }
        .schedule-row select, .qr-form-row input, .qr-form-row select { flex-grow: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1em; }
        .schedule-actions { margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .view { display: none; flex: 1; flex-direction: column; min-height: 0; }
        .view.active { display: flex; }
        #clientChatsView ul { list-style: none; padding: 10px 0; overflow-y: auto; }
        #clientChatsView li { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; gap: 12px; }
        #clientChatsView li:hover { background: #f8f9fa; }
        #clientChatsView .avatar { width: 45px; height: 45px; background: #667eea; color: white; border-radius: 50%; display: grid; place-items: center; font-weight: bold; flex-shrink: 0; }
        #clientChatsView .chat-info { flex: 1; }
        #clientChatsView .chat-name { font-weight: 500; }
        #clientChatsView .unread-indicator { width: 10px; height: 10px; background: #007bff; border-radius: 50%; visibility: hidden; transition: visibility 0.2s; }
        #clientChatsView .unread-indicator.visible { visibility: visible; }
        .availability-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 8px; margin: 10px 0; }
        .time-slot { padding: 8px 5px; border-radius: 6px; text-align: center; font-size: 0.8em; font-weight: 500; }
        .time-slot.available { background: #28a745; color: white; }
        .time-slot.booked { background: #dc3545; color: white; }
        .availability-stats { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 10px; border-top: 1px solid #e9ecef; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.2em; font-weight: bold; }
        .stat-label { font-size: 0.8em; color: #6c757d; }
        
        .header-icons {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 16px;
        }
        .icon-wrapper {
            position: relative;
            cursor: pointer;
        }
        .icon-wrapper svg {
            width: 26px;
            height: 26px;
            fill: white;
            opacity: 0.9;
            transition: opacity 0.2s;
        }
        .icon-wrapper:hover svg {
            opacity: 1;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -8px;
            background-color: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
            font-weight: bold;
            border: 2px solid #667eea;
        }
        .notification-badge.visible {
            display: flex;
            animation: pulse-badge 2s infinite;
        }
        @keyframes pulse-badge {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 8px rgba(255, 71, 87, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }
         #qrcode-display { display: flex; justify-content: center; align-items: center; padding: 20px; }
         

/* --- NUEVOS ESTILOS PARA LA FOTO DE PERFIL --- */
.profile-avatar-wrapper {
    display: flex;
    justify-content: center;
    margin-bottom: 16px;
}
.profile-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background-color: #764ba2;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2.5em;
    font-weight: bold;
    border: 3px solid white;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    overflow: hidden; /* Para que la imagen no se salga del c√≠rculo */
}
.profile-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Asegura que la imagen cubra todo el espacio sin deformarse */
}
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
             <span class="back-button" id="backButton">‚Üê</span>
             <div id="header-title">
                <h1>üíà BarberConnect</h1>
                <p id="headerSubtitle">Asistente Virtual</p>
             </div>
             <div class="header-icons">
                <div class="icon-wrapper" id="chatsIconWrapper" title="Ver mis chats">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 10H6v-2h12v2zm0-4H6V6h12v2z"></path></svg>
                    <span class="notification-badge" id="chatsBadge"></span>
                </div>
                <div class="icon-wrapper" id="bookingsIconWrapper" title="Ver nuevas citas">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"></path></svg>
                    <span class="notification-badge" id="bookingsBadge"></span>
                </div>
                <div class="icon-wrapper" id="financeIconWrapper" title="Ver Finanzas">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c2.14-.46 3.5-1.78 3.5-3.97 0-2.02-1.31-3.32-4.2-4.04z"></path></svg>
                    <span class="notification-badge" id="financeBadge"></span>
                </div>
            </div>
        </div>

        <div id="botView" class="view active">
            <div class="messages-container" id="messagesContainer"></div>
        </div>

        <div id="clientChatsView" class="view">
            <ul id="clientChatsList"></ul>
        </div>
        
        <div id="singleChatView" class="view">
            <div class="messages-container" id="singleChatMessages"></div>
        </div>

        <input type="file" id="profilePicInput" accept="image/png, image/jpeg" style="display: none;">
        <div class="input-container">
            <input type="text" class="message-input" id="messageInput" placeholder="Escribe un mensaje...">
            <button class="send-button" id="sendButton">‚û§</button>
        </div>
    </div>

<script> 
    const SUPABASE_URL = 'https://olkjevlkqdafbhuiszfz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sa2pldmxrcWRhZmJodWlzemZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNzc5ODcsImV4cCI6MjA3NDg1Mzk4N30.5V7LTjITA3szqyNxUy67K0r1IhaB9MpnxSML7IygYcM';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    class ChatApp {
        constructor() {
            this.currentFlow = 'checking_auth';
            this.userData = {};
            this.isTyping = false;
            this.currentUser = null;
            this.barberProfile = null;
            this.activeView = 'bot';
            this.activeChat = { id: null, clientName: null, clientId: null };
            
            this.unreadCounts = {};
            this.newBookingsData = []; // <-- MODIFICADO
            this.newTransactionsCount = 0;

            this.chatSubscription = null;
            this.notificationsSubscription = null;
            this.bookingsSubscription = null;
            this.transactionsSubscription = null;

            this.messagesContainer = document.getElementById('messagesContainer');
            this.messageInput = document.getElementById('messageInput');
            this.sendButton = document.getElementById('sendButton');
            this.headerSubtitle = document.getElementById('headerSubtitle');
            this.backButton = document.getElementById('backButton');
            this.clientChatsList = document.getElementById('clientChatsList');
            this.singleChatMessages = document.getElementById('singleChatMessages');

            this.chatsBadge = document.getElementById('chatsBadge');
            this.bookingsBadge = document.getElementById('bookingsBadge');
            this.financeBadge = document.getElementById('financeBadge');
            

            
            this.chatsIconWrapper = document.getElementById('chatsIconWrapper');
            this.profilePicInput = document.getElementById('profilePicInput');
            
            this.bookingsIconWrapper = document.getElementById('bookingsIconWrapper');
            this.financeIconWrapper = document.getElementById('financeIconWrapper');

            this.init();
        }
        
        async init() {
            this.sendButton.addEventListener('click', () => this.handleSend());
            this.messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.handleSend(); });
            this.messagesContainer.addEventListener('click', this.handleButtonClick.bind(this));
            this.backButton.addEventListener('click', () => this.handleBack());

            this.chatsIconWrapper.addEventListener('click', () => this.showClientChats());
            
            // --- BLOQUE MODIFICADO ---
            this.bookingsIconWrapper.addEventListener('click', () => {
                this.showNewBookings();
            });

            this.financeIconWrapper.addEventListener('click', () => {
                this.showFinanceMenu();
                this.newTransactionsCount = 0;
                this.updateBadges();
            });
            
            
            
            this.profilePicInput.addEventListener('change', (event) => this.uploadProfilePicture(event));


            await this.checkAuthState();

            // --- BLOQUE ELIMINADO ---
            // Se ha quitado la llamada autom√°tica a registerServiceWorker de aqu√≠
        }



        // ‚¨áÔ∏è REEMPLAZA TU FUNCI√ìN ACTUAL POR ESTA VERSI√ìN MEJORADA ‚¨áÔ∏è
async registerServiceWorker() {
    // Primero, verificamos que el navegador soporte notificaciones.
    if (!('Notification' in window) || !('serviceWorker' in navigator)) {
        this.addBotMessage('<div class="bot-card" style="background-color: #ffdddd;"><p><strong>No Soportado.</strong> Tu navegador no es compatible con las notificaciones push.</p></div>');
        return;
    }

    // Verificamos el estado actual del permiso SIN pedirlo todav√≠a.
    const currentPermission = Notification.permission;

    if (currentPermission === 'granted') {
        this.addBotMessage('<div class="bot-card" style="background-color: #ddffdd;"><p><strong>¬°Ya est√°s suscrito!</strong> ‚úÖ No es necesario volver a activar las notificaciones.</p></div>');
        return; // Salimos de la funci√≥n porque ya est√° todo listo.
    }

    if (currentPermission === 'denied') {
        this.addBotMessage('<div class="bot-card" style="background-color: #ffffcc;"><p><strong>Permiso Bloqueado.</strong> üö´ Has bloqueado las notificaciones para esta app. Para activarlas, necesitas cambiar los permisos desde la configuraci√≥n de tu navegador.</p></div>');
        return; // Salimos porque el usuario las tiene bloqueadas.
    }

    // Si el permiso es 'default', entonces s√≠ procedemos a solicitarlo.
    this.showTyping();
    try {
        const swRegistration = await navigator.serviceWorker.register('./sw.js');
        console.log("Notificaciones: Service Worker registrado con √©xito.", swRegistration);

        // AHORA S√ç PEDIMOS EL PERMISO
        const permissionResult = await window.Notification.requestPermission();

        if (permissionResult !== 'granted') {
            console.warn("Notificaciones: El usuario no concedi√≥ el permiso.");
            this.hideTyping();
            this.addBotMessage('<div class="bot-card" style="background-color: #ffffcc;"><p><strong>Permiso denegado.</strong> No podr√© enviarte notificaciones si no aceptas el permiso en la ventana de tu navegador.</p></div>');
            return;
        }
        
        console.log("Notificaciones: Permiso concedido. Obteniendo suscripci√≥n push...");
        let pushSubscription = await swRegistration.pushManager.getSubscription();

        if (pushSubscription === null) {
            console.log("Notificaciones: No se encontr√≥ suscripci√≥n, creando una nueva...");
            const vapidPublicKey = 'BJCOJ2WGEu7_29mhcE56t5zkmkmO2phKSVEELfWjTVe1RtmeZOZ5LWZfMyNWpWo7q7jNhBqezFf5MQFNq9NYSqA';
            pushSubscription = await swRegistration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: this.urlBase64ToUint8Array(vapidPublicKey)
            });
            console.log("Notificaciones: Nueva suscripci√≥n creada.");
        } else {
            console.log("Notificaciones: Se encontr√≥ una suscripci√≥n existente.");
        }

        await this.savePushSubscription(pushSubscription);

    } catch (error) {
        console.error("Notificaciones: Error catastr√≥fico durante el registro.", error);
        this.addBotMessage(`<div class="bot-card" style="background-color: #ffdddd;"><p><strong>¬°Ups! Hubo un error.</strong> No se pudieron activar las notificaciones. <br><small>Detalle: ${error.message}</small></p></div>`);
    } finally {
        this.hideTyping();
    }
}

         

        urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
              outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

     
// ‚¨áÔ∏è REEMPLAZA TAMBI√âN ESTA FUNCI√ìN COMPLETA EN index.html ‚¨áÔ∏è
async savePushSubscription(subscription) {
    console.log("BD: Intentando guardar la suscripci√≥n en Supabase..."); // Log para consola

    if (!this.currentUser || !this.currentUser.id) {
        console.error("BD Error: No se encontr√≥ un usuario logueado para guardar la suscripci√≥n."); // Log para consola
        this.addBotMessage('<div class="bot-card" style="background-color: #ffdddd;"><p><strong>Error Cr√≠tico:</strong> No pude identificarte. Por favor, intenta recargar la p√°gina.</p></div>');
        return;
    }
    
    const userId = this.currentUser.id;
    console.log(`BD: Actualizando perfil para user_id: ${userId}`); // Log para consola

    const { data, error } = await supabase
      .from('barbers')
      .update({ push_subscription: subscription })
      .eq('user_id', userId) 
      .select();

    if (error) {
        console.error("BD Error: Fallo al guardar la suscripci√≥n.", error); // Log para consola
        this.addBotMessage(`<div class="bot-card" style="background-color: #ffdddd;"><p><strong>Error en la base de datos:</strong> No se pudo guardar la configuraci√≥n de notificaciones.<br><small>${error.message}</small></p></div>`);
    } else if (data && data.length > 0) {
        console.info("BD: ¬°Suscripci√≥n guardada con √©xito!"); // Log para consola
        this.addBotMessage('<div class="bot-card" style="background-color: #ddffdd;"><p><strong>¬°Listo! ‚úÖ</strong> Las notificaciones han sido activadas. A partir de ahora recibir√°s alertas de nuevas citas y mensajes.</p></div>');
    } else {
        console.warn("BD: La operaci√≥n no fall√≥, pero no se actualiz√≥ ninguna fila. Posible problema con RLS o ID de usuario."); // Log para consola
        this.addBotMessage('<div class="bot-card" style="background-color: #ffffcc;"><p><strong>Atenci√≥n:</strong> La configuraci√≥n se complet√≥, pero parece que no se guard√≥. Si no recibes notificaciones, contacta a soporte.</p></div>');
    }
}


        updateBadges() {
            const totalUnread = Object.values(this.unreadCounts).reduce((sum, count) => sum + count, 0);
            if (totalUnread > 0) {
                this.chatsBadge.textContent = totalUnread > 9 ? '9+' : totalUnread;
                this.chatsBadge.classList.add('visible');
            } else {
                this.chatsBadge.classList.remove('visible');
            }

            // --- BLOQUE MODIFICADO ---
            if (this.newBookingsData.length > 0) {
                this.bookingsBadge.textContent = this.newBookingsData.length > 9 ? '9+' : this.newBookingsData.length;
                this.bookingsBadge.classList.add('visible');
            } else {
                this.bookingsBadge.classList.remove('visible');
            }

            if (this.newTransactionsCount > 0) {
                this.financeBadge.textContent = this.newTransactionsCount > 9 ? '9+' : this.newTransactionsCount;
                this.financeBadge.classList.add('visible');
            } else {
                this.financeBadge.classList.remove('visible');
            }
        }

        switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewName).classList.add('active');
            this.activeView = viewName.replace('View', '');

            const headerTitleDiv = document.getElementById('header-title');
            if (this.activeView === 'bot' || this.activeView === 'clientChats') {
                headerTitleDiv.style.display = 'block';
                this.headerSubtitle.textContent = this.activeView === 'bot' ? 'Asistente Virtual' : 'Mis Chats';
                this.backButton.style.display = 'none';
                this.activeChat.id = null;
                if (this.chatSubscription) { this.chatSubscription.unsubscribe(); this.chatSubscription = null; }
            } else {
                headerTitleDiv.style.display = 'block';
                this.headerSubtitle.textContent = `Hablando con ${this.activeChat.clientName}`;
                this.backButton.style.display = 'block';
            }
        }
        
        handleBack() {
            if (this.activeView === 'singleChat') {
                this.switchView('clientChatsView');
            }
        }

        async handleButtonClick(event) {
            const button = event.target.closest('.command-button');
            if (!button || button.disabled) return;
            const buttonContainer = button.closest('.command-buttons-container, .schedule-actions');
            if (buttonContainer) { buttonContainer.querySelectorAll('.command-button').forEach(btn => btn.disabled = true); }
            const command = button.dataset.command;
            const serviceToEdit = button.dataset.serviceEdit;
            const dayToEdit = button.dataset.dayEdit;
            const dayToConfirm = button.dataset.dayConfirm;

            if (command) {
                this.addUserMessage(button.textContent.trim());
                if (command.startsWith('check_availability:')) {
                    const parts = command.split(':');
                    const dateString = parts[1];
                    const barberName = parts.length > 2 ? parts[2] : null; 
                    
                    const dateParts = dateString.split('-');
                    const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                    if (isNaN(date.getTime())) { this.addBotMessage(`<div class="bot-card"><p>‚ùå Error: La fecha recibida no es v√°lida.</p></div>`); return; }
                    
                    await this.showAvailabilityForDate(date, barberName);

                } else if (command.startsWith('select_barber_for_flow:')) {
                    const [_, barberName, nextFlow] = command.split(':');
                    this.userData.selectedBarber = barberName;
                    this.currentFlow = 'authenticated';
                    await this.handleAuthenticatedCommand(`/${nextFlow}`);

                } else {
                    await this.processUserInput(command.toLowerCase());
                }
            } else if (serviceToEdit) {
                const serviceName = JSON.parse(serviceToEdit.replace(/'/g, '"')).name;
                this.addUserMessage(`Quiero editar el servicio: ${serviceName}`);
                await this.startServiceEditFlow(serviceToEdit);
            } else if (dayToEdit) {
                const dayName = { mon: 'Lunes', tue: 'Martes', wed: 'Mi√©rcoles', thu: 'Jueves', fri: 'Viernes', sat: 'S√°bado', sun: 'Domingo' }[dayToEdit];
                this.addUserMessage(`Configurar horario para: ${dayName}`);
                await this.startDayEditFlow(dayToEdit);
            } else if (dayToConfirm) {
                const startHour = document.getElementById(`start-hour-${dayToConfirm}`).value;
                const endHour = document.getElementById(`end-hour-${dayToConfirm}`).value;
                if (parseInt(startHour) >= parseInt(endHour)) { this.addBotMessage('<div class="bot-card"><p>UPS... La hora de finalizaci√≥n debe ser mayor que la de inicio. Por favor, int√©ntalo de nuevo.</p></div>'); this.showHorarioMenu(); return; }
                this.addUserMessage(`Confirmar horario de ${startHour}:00 a ${endHour}:00`);
                let hours = [];
                for (let i = parseInt(startHour); i < parseInt(endHour); i++) { hours.push(i); }
                await this.setAvailability(dayToConfirm, hours);
            }
        }
        
        async handleSend() {
            const text = this.messageInput.value.trim();
            if (!text || this.isTyping) return;
            this.messageInput.value = '';
            if (this.activeView === 'bot') { this.addUserMessage(text); await this.processUserInput(text.toLowerCase(), text); } // Pasamos la versi√≥n min√∫scula (para comandos) y la original 
            else if (this.activeView === 'singleChat') { await this.sendClientMessage(text); }
        }

        addMessage(text, sender, container) { const message = { text, sender, time: new Date() }; this.renderMessage(message, container); }
        addUserMessage(text) { this.addMessage(text, 'user', this.messagesContainer); }
        addBotMessage(htmlContent) { this.addMessage(`<div class="bot-card-wrapper">${htmlContent}</div>`, 'bot', this.messagesContainer); }
        
        renderMessage(message, container, isNew = true) {
            const targetContainer = container || (this.activeView === 'singleChat' ? this.singleChatMessages : this.messagesContainer);
            const messageDiv = document.createElement('div');
            let senderClass = 'bot';
            if (message.sender === 'user' || message.sender_type === 'barber') { senderClass = 'user'; }
            messageDiv.className = `message ${senderClass}`;
            const content = message.text || message.content;
            let time;
            try { time = new Date(message.time || message.created_at || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); } 
            catch (error) { time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
            messageDiv.innerHTML = `<div class="message-content">${content}</div><div class="message-time">${time}</div>`;
            targetContainer.appendChild(messageDiv);
            if (isNew) { targetContainer.scrollTop = targetContainer.scrollHeight; }
        }
        
        showTyping() { if (this.isTyping) return; this.isTyping = true; const typingDiv = document.createElement('div'); typingDiv.className = 'message bot'; typingDiv.id = 'typing-indicator'; typingDiv.innerHTML = `<div class="typing"><span></span><span></span><span></span></div>`; this.messagesContainer.appendChild(typingDiv); this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight; }
        hideTyping() { this.isTyping = false; const indicator = document.getElementById('typing-indicator'); if (indicator) indicator.remove(); }
        
        async processUserInput(input, originalText = null) {
            // 'input' ser√° la versi√≥n en min√∫sculas (para comandos)
            // 'originalText' ser√° la versi√≥n original (para nombres, etc.)
            if (originalText === null) originalText = input; // Fallback por si acaso
            this.showTyping();
            await new Promise(resolve => setTimeout(resolve, 600));
            this.hideTyping();
            
            switch(this.currentFlow) {
                case 'welcome': case 'has_account': case 'register_name':
                case 'register_last_name': case 'register_email': case 'register_password':
                case 'login_email': case 'login_password':
                    await this.handleAuthFlow(input);
                    break;
                case 'servicio_add_name':
                    this.userData.tempServiceName = input;
                    this.addBotMessage(`<div class="bot-card"><p>¬°Entendido! El servicio se llamar√° "<strong>${input}</strong>".</p><p>Ahora, por favor, dime el precio (solo el n√∫mero).</p></div>`);
                    this.currentFlow = 'servicio_add_price';
                    break;
                case 'servicio_add_price':
                    await this.addService(this.userData.tempServiceName, input);
                    break;
                case 'adding_barber_name':
                    await this.addNewBarberToJSON(input.trim());
                    break;
                
                case 'authenticated':
                    await this.handleAuthenticatedCommand(input);
                    break;
                default:
                    this.addBotMessage('<div class="bot-card"><p>Vaya, no he entendido eso. ¬øPodr√≠as intentarlo de nuevo o usar uno de los botones del men√∫ principal?</p></div>');
            }
        }

        async handleAuthenticatedCommand(input) {
            const [command, ...args] = input.split(' ');
            const argString = args.join(' ');

            switch(command) {
                case '/miperfil': await this.showBarberProfile(); break;
                case '/citas': await this.showAllBookings(); break;
                case '/disponibilidad': await this.promptDateForAvailability(); break;
                case '/chats': await this.showClientChats(); break;
                case '/cerrar': await this.logout(); break;
                case '/finanzas': await this.showFinanceMenu(); break;
                case '/generar_qr': await this.promptForQRCodeGeneration(); break;
                case 'menu': case 'men√∫': this.showMainMenu(); break;
                
                // --- NUEVO COMANDO A√ëADIDO ---
                case '/suscribirse_notificaciones': await this.registerServiceWorker(); break;
                
                case '/horario':
                    if (argString === 'ver') await this.promptBarberSelection('horario ver');
                    else if (argString === 'definir') await this.promptBarberSelection('horario definir');
                    else await this.promptBarberSelection('horario');
                    break;
                case '/servicios':
                     if (argString === 'ver') await this.promptBarberSelection('servicios ver');
                    else if (argString === 'agregar') await this.promptBarberSelection('servicios agregar');
                    else if (argString === 'editar') await this.promptBarberSelection('servicios editar');
                    else await this.promptBarberSelection('servicios');
                    break;
                
                case '/equipo': this.showTeamManagementMenu(); break;
                case '/activar_equipo': await this.activateTeamAccount(); break;
                case '/ver_equipo': await this.showTeamMembers(); break;
                case '/agregar_barbero':
                    this.addBotMessage('<div class="bot-card"><p>¬°Perfecto! Escribe el nombre del nuevo barbero.</p></div>');
                    this.currentFlow = 'adding_barber_name';
                    break;
                
                case '/horario-interno':
                    if (argString === 'ver') await this.showAvailability();
                    else if (argString === 'definir') await this.promptDaySelection();
                    else this.showHorarioMenu();
                    break;
                case '/servicios-interno':
                     if (argString === 'ver') await this.showServices();
                    else if (argString === 'agregar') { this.addBotMessage('<div class="bot-card"><p>¬°Claro! Dime el nombre del nuevo servicio para <strong>' + this.userData.selectedBarber + '</strong>.</p></div>'); this.currentFlow = 'servicio_add_name'; }
                    else if (argString === 'editar') await this.promptServiceSelectionToEdit();
                    else this.showServicesMenu();
                    break;
                case '/horario-cerrado':
                    const dayKey = args[0];
                    if (dayKey) await this.setAvailability(dayKey, []);
                    break;
                default:
                    this.addBotMessage('<div class="bot-card"><p>Lo siento, no reconozco ese comando. Aqu√≠ tienes las opciones principales.</p></div>');
                    this.showMainMenu();
            }
        }
        
        showMainMenu() {
            // --- MEN√ö PRINCIPAL MODIFICADO ---
            const menuHTML = `<div class="bot-card"><h3>Men√∫ Principal</h3><p>Hola de nuevo, ¬øen qu√© te puedo ayudar hoy?</p><div class="command-buttons-container">
            <button class="command-button" data-command="/miperfil">üë§ Mi Perfil</button>
            <button class="command-button" data-command="/equipo">üë• Gestionar Equipo</button>
            <button class="command-button" data-command="/horario">‚è∞ Horarios</button>
            <button class="command-button" data-command="/servicios">üõ†Ô∏è Servicios</button>
            <button class="command-button" data-command="/citas">üìÖ Ver Citas</button>
            <button class="command-button" data-command="/finanzas">üí∞ Finanzas</button>
            <button class="command-button" data-command="/chats">üí¨ Mis Chats</button>
            <button class="command-button" data-command="/disponibilidad">üîç Ver Disponibilidad</button>
            <button class="command-button" data-command="/suscribirse_notificaciones">üîî Activar Notificaciones</button>
            <button class="command-button" data-command="/cerrar">üö™ Cerrar Sesi√≥n</button>
            </div></div>`;
            this.addBotMessage(menuHTML);
        }

        showServicesMenu() {
            const title = this.barberProfile.is_team_account 
                ? `para <strong>${this.userData.selectedBarber}</strong>` 
                : '';

            const menuHTML = `<div class="bot-card"><h3>üõ†Ô∏è Gesti√≥n de Servicios ${title}</h3><div class="command-buttons-container"><button class="command-button" data-command="/servicios-interno ver">Ver Lista</button><button class="command-button" data-command="/servicios-interno agregar">Agregar Nuevo</button><button class="command-button" data-command="/servicios-interno editar">Editar / Borrar</button><button class="command-button full-width return" data-command="menu">Volver al Men√∫</button></div></div>`;
            this.addBotMessage(menuHTML);
        }
        
        showHorarioMenu() {
            const title = this.barberProfile.is_team_account 
                ? `para <strong>${this.userData.selectedBarber}</strong>` 
                : '';

            const menuHTML = `<div class="bot-card"><h3>‚è∞ Gesti√≥n de Horario ${title}</h3><div class="command-buttons-container"><button class="command-button" data-command="/horario-interno ver">Ver mi Horario</button><button class="command-button" data-command="/horario-interno definir">Definir/Editar</button><button class="command-button full-width return" data-command="menu">Volver al Men√∫</button></div></div>`;
            this.addBotMessage(menuHTML);
        }
        
        async promptDaySelection() {
            const days = { 
                mon: 'Lunes', tue: 'Martes', wed: 'Mi√©rcoles', 
                thu: 'Jueves', fri: 'Viernes', sat: 'S√°bado', sun: 'Domingo' 
            };
            const barberName = this.userData.selectedBarber;

            const buttonsHTML = Object.keys(days).map(key => 
                `<button class="command-button" data-day-edit="${key}">${days[key]}</button>`
            ).join('');

            const menuHTML = `<div class="bot-card">
                <h3>Definir Horario para ${barberName}</h3>
                <p>Por favor, selecciona el d√≠a que quieres configurar.</p>
                <div class="command-buttons-container">
                    ${buttonsHTML}
                    <button class="command-button full-width return" data-command="/horario-interno">‚Ü©Ô∏è Volver a Horarios</button>
                </div>
            </div>`;
            this.addBotMessage(menuHTML);
        }
        
        showTeamManagementMenu() {
            if (this.barberProfile.is_team_account) {
                this.addBotMessage(`<div class="bot-card">
                    <h3>üë• Gesti√≥n de Equipo</h3>
                    <p>Desde aqu√≠ puedes a√±adir o ver los barberos de tu negocio.</p>
                    <div class="command-buttons-container">
                        <button class="command-button" data-command="/ver_equipo">Ver Mi Equipo</button>
                        <button class="command-button" data-command="/agregar_barbero">‚ûï A√±adir Barbero</button>
                        <button class="command-button full-width return" data-command="menu">Volver al Men√∫</button>
                    </div>
                </div>`);
            } else {
                this.addBotMessage(`<div class="bot-card">
                    <h3>üë• Activar Cuenta de Equipo</h3>
                    <p>Actualmente tu cuenta es para un barbero individual. Activa el modo equipo para poder a√±adir m√°s barberos, cada uno con sus propios horarios y servicios.</p>
                    <p><strong>Esta acci√≥n es permanente.</strong></p>
                    <div class="command-buttons-container">
                        <button class="command-button confirm" data-command="/activar_equipo">üöÄ Activar Cuenta de Equipo</button>
                        <button class="command-button full-width return" data-command="menu">Volver al Men√∫</button>
                    </div>
                </div>`);
            }
        }

        async activateTeamAccount() {
            this.showTyping();
            const { data, error } = await supabase
                .from('barbers')
                .update({ is_team_account: true })
                .eq('user_id', this.currentUser.id)
                .select()
                .single();

            this.hideTyping();

            if (error) {
                console.error("Error activating team account:", error);
                this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al activar la cuenta de equipo. Por favor, int√©ntalo de nuevo.</p></div>');
            } else {
                this.barberProfile = data;
                this.addBotMessage('<div class="bot-card"><h3>¬°Cuenta de Equipo Activada! ‚úÖ</h3><p>Ahora puedes empezar a a√±adir miembros a tu equipo desde este men√∫.</p></div>');
                this.showTeamManagementMenu();
            }
        }

        async showTeamMembers() {
            const b = await this.getBarberProfile();
            const barbers = Object.keys(b.availability || {});
            
            let membersHTML = '<p>A√∫n no has a√±adido a ning√∫n barbero. ¬°A√±ade el primero!</p>';
            if (barbers.length > 0) {
                membersHTML = barbers.map(name => `<li><span class="item-name">${name}</span></li>`).join('');
            }
            this.addBotMessage(`<div class="bot-card"><h3>üë• Mi Equipo</h3><ul>${membersHTML}</ul></div>`);
            this.showTeamManagementMenu();
        }

        async addNewBarberToJSON(barberName) {
            if (!barberName) { this.addBotMessage('<div class="bot-card"><p>El nombre no puede estar vac√≠o.</p></div>'); return; }
            this.showTyping();
            const b = await this.getBarberProfile();
            let availability = b.availability || {};
            let services = b.services || {};

            if (availability[barberName] || services[barberName]) {
                this.hideTyping();
                this.addBotMessage(`<div class="bot-card"><p>‚ö†Ô∏è El barbero "<strong>${barberName}</strong>" ya existe.</p></div>`);
                this.showTeamManagementMenu();
                return;
            }

            availability[barberName] = {};
            services[barberName] = [];

            const { error } = await supabase.from('barbers').update({ availability, services }).eq('user_id', this.currentUser.id);
            this.hideTyping();

            if (error) {
                this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al guardar.</p></div>');
            } else {
                this.addBotMessage(`<div class="bot-card"><p>‚úÖ <strong>${barberName}</strong> ha sido a√±adido. Ahora puedes configurar su horario y servicios.</p></div>`);
            }
            this.currentFlow = 'authenticated';
            this.showTeamManagementMenu();
        }

        async promptBarberSelection(nextFlow) {
            const b = await this.getBarberProfile();
            const barbers = Object.keys(b.availability || {});
            
            if (!b.is_team_account || barbers.length === 1) {
                this.userData.selectedBarber = barbers[0];
                await this.handleAuthenticatedCommand(`/${nextFlow}-interno`);
                return;
            }

            if (barbers.length === 0) {
                this.addBotMessage('<div class="bot-card"><p>Primero debes a√±adir al menos un barbero a tu equipo. Usa el men√∫ de "Gestionar Equipo".</p></div>');
                this.showMainMenu();
                return;
            }

            const buttonsHTML = barbers.map(name => 
                `<button class="command-button" data-command="select_barber_for_flow:${name}:${nextFlow}-interno">${name}</button>`
            ).join('');

            this.addBotMessage(`<div class="bot-card">
                <h3>¬øPara qu√© barbero deseas realizar esta acci√≥n?</h3>
                <div class="command-buttons-container">${buttonsHTML}</div>
            </div>`);
        }

        getBarberProfile() { return this.barberProfile; }
        
        async refreshProfileFromDB() {
            const { data, error } = await supabase
                .from('barbers')
                .select('*')
                .eq('user_id', this.currentUser.id)
                .single();

            if (data && !error) {
                this.barberProfile = data;
                console.log("Perfil local refrescado con √©xito desde la BD.");
            } else {
                console.error("Error al refrescar el perfil desde la BD:", error);
            }
        }
        
async showBarberProfile() {
    this.showTyping();
    const profile = this.getBarberProfile();
    await new Promise(resolve => setTimeout(resolve, 500)); 
    this.hideTyping();

    if (!profile) {
        this.addBotMessage('<div class="bot-card"><p>‚ùå No pude cargar tu perfil. Intenta recargar la p√°gina.</p></div>');
        return;
    }

    const accountType = profile.is_team_account ? 'Equipo (M√∫ltiples Barberos)' : 'Individual';
    const sanitizedShopName = profile.barber_shop_name.replace(/'/g, "\\'");

    // --- L√ìGICA PARA EL AVATAR Y BOTONES ---
    let avatarHTML = '';
    if (profile.avatar_url) {
        // Si hay foto, la mostramos
        avatarHTML = `<div class="profile-avatar"><img src="${profile.avatar_url}" alt="Foto de Perfil"></div>`;
    } else {
        // Si no, mostramos la inicial del nombre
        const initial = profile.first_name ? profile.first_name.charAt(0).toUpperCase() : '?';
        avatarHTML = `<div class="profile-avatar"><span>${initial}</span></div>`;
    }

    let photoButtonsHTML = '';
    if (profile.avatar_url) {
        // Si hay foto, mostramos botones de editar y eliminar
        photoButtonsHTML = `
            <button class="command-button" onclick="app.triggerFileUpload()">‚úèÔ∏è Editar Foto</button>
            <button class="command-button cancel" onclick="app.deleteProfilePicture()">üóëÔ∏è Eliminar Foto</button>
        `;
    } else {
        // Si no hay foto, mostramos solo el de subir
        photoButtonsHTML = `
            <button class="command-button full-width confirm" onclick="app.triggerFileUpload()">üì∏ Subir Foto de Perfil</button>
        `;
    }

    const profileHTML = `
    <div class="bot-card">
        <h3>üë§ Mi Perfil</h3>
        <div class="profile-avatar-wrapper">${avatarHTML}</div>

        <div class="command-buttons-container" style="margin-bottom: 15px; grid-template-columns: 1fr 1fr;">
            ${photoButtonsHTML}
        </div>

        <ul>
            <li><span class="item-name">Nombre:</span><span class="item-detail">${profile.first_name} ${profile.last_name}</span></li>
            <li><span class="item-name">Barber√≠a:</span><span class="item-detail">${profile.barber_shop_name}</span></li>
            <li><span class="item-name">Tipo de Cuenta:</span><span class="item-detail">${accountType}</span></li>
            <li><span class="item-name">C√≥digo Clientes:</span><span class="item-detail" style="font-weight: bold; color: #764ba2;">${profile.public_code}</span></li>
        </ul>
        <p class="helper-text">Tus clientes usan este c√≥digo para conectar contigo.</p>

        <div class="command-buttons-container" style="margin-top: 15px; grid-template-columns: 1fr 1fr;">
            <button class="command-button" onclick="app.copyCodeToClipboard('${profile.public_code}', this)">üìã Copiar C√≥digo</button>
            <button class="command-button confirm" onclick="app.shareProfileCode('${profile.public_code}', '${sanitizedShopName}')">üì≤ Compartir</button>
        </div>
        <div class="command-buttons-container" style="margin-top: 10px;">
            <button class="command-button full-width return" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button>
        </div>
    </div>`;

    this.addBotMessage(profileHTML);
}
        
        // Pega estas dos nuevas funciones en tu archivo index.html, dentro de la clase ChatApp

        async copyCodeToClipboard(code, buttonElement) {
            try {
                await navigator.clipboard.writeText(code);
                // Feedback visual para el usuario
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = '‚úÖ ¬°Copiado!';
                buttonElement.style.backgroundColor = '#28a745'; // Verde de √©xito
                
                // Vuelve al estado original despu√©s de 2 segundos
                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                    buttonElement.style.backgroundColor = ''; // Restaura el color original
                }, 2000);

            } catch (err) {
                console.error('Error al copiar el c√≥digo: ', err);
                this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al intentar copiar el c√≥digo.</p></div>');
            }
        }

        async shareProfileCode(code, shopName) {
            const shareData = {
                title: `C√≥digo para ${shopName}`,
                text: `¬°Hola! Usa este c√≥digo para conectar con nuestra barber√≠a "${shopName}" en BarberConnect: ${code}`,
                url: window.location.origin + '/Cliente.html' // <-- ¬°Esta es la correcci√≥n!
            };


            // Comprueba si el navegador soporta la API de compartir
            if (navigator.share && navigator.canShare(shareData)) {
                try {
                    await navigator.share(shareData);
                    console.log('C√≥digo compartido con √©xito');
                } catch (err) {
                    console.error('Error al compartir: ', err);
                }
            } else {
                // Mensaje por si el navegador no es compatible (ej. un PC de escritorio)
                this.addBotMessage('<div class="bot-card"><p>La funci√≥n de compartir no est√° disponible en este navegador. Puedes copiar el c√≥digo manualmente.</p></div>');
            }
        }
        
        
// ... despu√©s de la funci√≥n shareProfileCode ...

triggerFileUpload() {
    // Esta funci√≥n simple activa el click en el input de archivo oculto
    this.profilePicInput.click();
}

// REEMPLAZA ESTA FUNCI√ìN COMPLETA EN TU C√ìDIGO (index.html)
async uploadProfilePicture(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Validaciones (estas ya las tienes y est√°n bien)
    const fileTypes = ['image/png', 'image/jpeg'];
    if (!fileTypes.includes(file.type)) {
        this.addBotMessage('<div class="bot-card"><p>‚ùå Formato no v√°lido. Sube una imagen PNG o JPG.</p></div>');
        return;
    }
    if (file.size > 5 * 1024 * 1024) {
        this.addBotMessage('<div class="bot-card"><p>‚ùå La imagen es muy grande. El l√≠mite es de 5 MB.</p></div>');
        return;
    }

    this.addBotMessage('<div class="bot-card"><p>Subiendo foto, por favor espera... ‚è≥</p></div>');
    this.showTyping();

    const bucketName = 'profile_pictures';
    const filePath = `${this.currentUser.id}/profile.png`;

    try {
        // 1. Subir el archivo (esto no cambia)
        const { error: uploadError } = await supabase.storage
            .from(bucketName)
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: true,
            });

        if (uploadError) throw uploadError;

        // 2. Obtener la URL p√∫blica con el truco anti-cach√© (esto no cambia)
        const { data: urlData } = supabase.storage
            .from(bucketName)
            .getPublicUrl(filePath);
        const publicURLWithCacheBuster = `${urlData.publicUrl}?t=${new Date().getTime()}`;

        // --- CAMBIO CLAVE: ACTUALIZAR Y OBTENER EN UN SOLO PASO ---
        // Usamos .select().single() para que la operaci√≥n nos devuelva el perfil actualizado.
        const { data: updatedProfile, error: dbError } = await supabase
            .from('barbers')
            .update({ avatar_url: publicURLWithCacheBuster })
            .eq('user_id', this.currentUser.id)
            .select() // <-- Le decimos que nos devuelva la fila
            .single(); // <-- Y que sea solo una

        if (dbError) throw dbError;

        // --- SEGUNDO CAMBIO CLAVE: ACTUALIZAR EL ESTADO LOCAL DIRECTAMENTE ---
        // Ya no necesitamos llamar a refreshProfileFromDB(), porque ya tenemos los datos frescos.
        this.barberProfile = updatedProfile;

        this.addBotMessage('<div class="bot-card"><p>‚úÖ ¬°Foto de perfil actualizada con √©xito!</p></div>');
        await this.showBarberProfile(); // Ahora esta funci√≥n usar√° el perfil garantizado 100% actualizado.

    } catch (error) {
        console.error("Error subiendo la foto:", error);
        this.addBotMessage(`<div class="bot-card" style="background-color: #ffdddd;"><p><strong>‚ùå Hubo un error al subir tu foto:</strong><br><small>${error.message}</small></p></div>`);
    } finally {
        this.hideTyping();
        this.profilePicInput.value = '';
    }
}

async deleteProfilePicture() {
    if (!confirm("¬øEst√°s seguro de que quieres eliminar tu foto de perfil?")) return;

    this.addBotMessage('<div class="bot-card"><p>Eliminando foto...</p></div>');
    this.showTyping();

    const filePath = `${this.currentUser.id}/profile.png`;

    try {
        // Eliminar de Supabase Storage
        const { error: removeError } = await supabase.storage
            .from('profile_pictures')
            .remove([filePath]);

        if (removeError) throw removeError;

        // Eliminar la URL de la base de datos
        const { error: dbError } = await supabase
            .from('barbers')
            .update({ avatar_url: null })
            .eq('user_id', this.currentUser.id);

        if (dbError) throw dbError;

        await this.refreshProfileFromDB();
        this.addBotMessage('<div class="bot-card"><p>‚úÖ Foto eliminada correctamente.</p></div>');
        await this.showBarberProfile();

    } catch (error) {
        console.error("Error eliminando la foto:", error);
        this.addBotMessage(`<div class="bot-card"><p>‚ùå Hubo un error al eliminar tu foto: ${error.message}</p></div>`);
    } finally {
        this.hideTyping();
    }
}
        
        

        async showServices() {
            const barberName = this.userData.selectedBarber;
            const b = await this.getBarberProfile();
            let servicesOfBarber = (b.services || {})[barberName] || [];

            let s = '';
            if (servicesOfBarber.length > 0) {
                s = servicesOfBarber.map(svc => `<li><span class="item-name">${svc.name}</span><span class="item-detail">$${svc.price}</span></li>`).join('');
            } else {
                s = `<p><strong>${barberName}</strong> a√∫n no tiene servicios asignados.</p>`;
            }
            this.addBotMessage(`<div class="bot-card"><h3>üõ†Ô∏è Lista de Servicios de ${barberName}</h3><ul>${s}</ul></div>`);
            this.showServicesMenu();
        }
        
        async showAvailability() {
            const barberName = this.userData.selectedBarber;
            const b = await this.getBarberProfile();
            const availabilityOfBarber = (b.availability || {})[barberName] || {};
            
            const d = { mon: 'Lunes', tue: 'Martes', wed: 'Mi√©rcoles', thu: 'Jueves', fri: 'Viernes', sat: 'S√°bado', sun: 'Domingo' };
            let a = Object.keys(d).map(k => {
                const h = availabilityOfBarber[k] || [];
                const t = h.length > 0 ? h.map(hr => `${parseInt(hr)}:00`).join(', ') : 'Cerrado';
                return `<li><span class="item-name">${d[k]}</span><span class="item-detail">${t}</span></li>`;
            }).join('');
            this.addBotMessage(`<div class="bot-card"><h3>‚è∞ Horario Semanal de ${barberName}</h3><ul>${a}</ul></div>`);
            this.showHorarioMenu();
        }
        
        async showAllBookings() {
            this.showTyping();
            const { data: bookings, error } = await supabase
                .from('bookings')
                .select('*, clients(first_name, last_name)')
                .eq('barber_id', this.barberProfile.id)
                .order('booking_date', { ascending: true });
            
            this.hideTyping();

            const backButtonHTML = `<div class="command-buttons-container" style="margin-top: 15px;"><button class="command-button full-width return" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button></div>`;

            if (error) {
                this.addBotMessage(`<div class="bot-card"><p>‚ùå Error al consultar tus citas.</p>${backButtonHTML}</div>`);
                console.error("Error fetching bookings:", error);
                return;
            }

            if (!bookings || bookings.length === 0) {
                this.addBotMessage(`<div class="bot-card"><h3>üìÖ Mis Citas</h3><p>No tienes ninguna cita programada por el momento.</p>${backButtonHTML}</div>`);
                return;
            }

            const bookingsList = bookings.map(b => {
                const date = new Date(b.booking_date);
                const clientName = b.clients ? `${b.clients.first_name} ${b.clients.last_name}` : 'Cliente';
                const formattedDate = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const formattedTime = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                return `<li>
                    <span class="item-name">${b.service_name} con ${clientName}</span>
                    <span class="item-detail">${formattedDate} - ${formattedTime}</span>
                </li>`;
            }).join('');

            this.addBotMessage(`<div class="bot-card"><h3>üìÖ Mis Citas Programadas</h3><ul>${bookingsList}</ul>${backButtonHTML}</div>`);
        }

        // --- FUNCI√ìN NUEVA A√ëADIDA ---
        async showNewBookings() {
            this.switchView('botView'); // Asegurarnos de estar en la vista del bot
            
            // Copiamos las reservas nuevas y limpiamos el contador INMEDIATAMENTE
            const bookingsToProcess = [...this.newBookingsData];
            this.newBookingsData = [];
            this.updateBadges();

            const backButtonHTML = `<div class="command-buttons-container" style="margin-top: 15px;"><button class="command-button full-width return" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button></div>`;

            // Si no hab√≠a reservas nuevas
            if (bookingsToProcess.length === 0) {
                this.addBotMessage(`<div class="bot-card"><h3>üîî Notificaciones de Citas</h3><p>No tienes ninguna cita nueva en este momento.</p><hr style="border: 0; border-top: 1px solid #f1f3f5; margin: 10px 0;"><p style="font-size: 0.9em; color: #666;">Para ver todas tus citas (nuevas y antiguas), usa el comando <strong>/citas</strong>.</p>${backButtonHTML}</div>`);
                return;
            }

            this.showTyping();

            // El 'payload' de la subscripci√≥n no trae el nombre del cliente, solo el ID.
            // Necesitamos consultar los nombres de los clientes.
            const clientIds = [...new Set(bookingsToProcess.map(b => b.client_id))];
            
            const { data: clients, error } = await supabase
                .from('clients')
                .select('id, first_name, last_name')
                .in('id', clientIds);

            this.hideTyping();

            if (error) {
                 this.addBotMessage(`<div class"bot-card"><p>‚ùå Error al cargar los nombres de los clientes para las notificaciones.</p>${backButtonHTML}</div>`);
                 return;
            }

            // Creamos un "mapa" para buscar nombres por ID f√°cilmente
            const clientMap = new Map(clients.map(c => [c.id, `${c.first_name} ${c.last_name}`]));

            // Creamos el HTML para cada notificaci√≥n de reserva
            const bookingsListHTML = bookingsToProcess.map(b => {
                const date = new Date(b.booking_date);
                const clientName = clientMap.get(b.client_id) || 'Cliente Desconocido';
                const formattedDate = date.toLocaleDateString('es-ES', { weekday: 'short', day: '2-digit', month: 'short' });
                const formattedTime = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const barberPerformer = b.barber_name || 'Staff'; // Usamos el barbero asignado

                return `<li>
                    <span class="item-name">${b.service_name} con <strong>${clientName}</strong> (Atiende: ${barberPerformer})</span>
                    <span class="item-detail">${formattedDate} - ${formattedTime}</span>
                </li>`;
            }).join('');

            // Construimos la tarjeta "modal" final
            const finalCard = `
            <div class="bot-card">
                <h3>üîî ¬°${bookingsToProcess.length} Cita(s) Nueva(s)!</h3>
                <p>Aqu√≠ est√°n los detalles de las nuevas reservas:</p>
                <ul>${bookingsListHTML}</ul>
                <div class="command-buttons-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <button class="command-button" data-command="/citas">Ver Todas las Citas</button>
                    <button class="command-button return" data-command="menu">Volver al Men√∫</button>
                </div>
            </div>`;

            this.addBotMessage(finalCard);
        }

        async promptDateForAvailability() {
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);

            const formatDateForCommand = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

            const promptHTML = `<div class="bot-card">
                <h3>üîç Ver Disponibilidad</h3>
                <p>Por favor, selecciona una fecha para revisar los horarios disponibles y ocupados.</p>
                <div class="command-buttons-container">
                    <button class="command-button" data-command="check_availability:${formatDateForCommand(today)}">Hoy</button>
                    <button class="command-button" data-command="check_availability:${formatDateForCommand(tomorrow)}">Ma√±ana</button>
                </div>
                <p class="helper-text">Pr√≥ximamente podr√°s escribir una fecha espec√≠fica.</p>
            </div>`;
            this.addBotMessage(promptHTML);
        }

        async showAvailabilityForDate(date, barberName = null) {
            this.showTyping();
            
            const profile = await this.getBarberProfile();
            const allBarbers = Object.keys(profile.availability || {});
            
            if (profile.is_team_account && !barberName) {
                const buttonsHTML = allBarbers.map(name => 
                    `<button class="command-button" data-command="check_availability:${date.toISOString().split('T')[0]}:${name}">${name}</button>`
                ).join('');
                this.hideTyping();
                this.addBotMessage(`<div class="bot-card">
                    <h3>¬øPara qu√© barbero quieres ver la disponibilidad del ${date.toLocaleDateString()}?</h3>
                    <div class="command-buttons-container">${buttonsHTML}</div>
                    <div class="command-buttons-container" style="margin-top: 10px;"><button class="command-button full-width return" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button></div>
                </div>`);
                return;
            }
            
            if (!barberName) barberName = allBarbers[0];

            const backButtonHTML = `<div class="command-buttons-container" style="margin-top: 15px;"><button class="command-button full-width return" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button></div>`;

            const dayMapping = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const dayKey = dayMapping[date.getDay()];
            const barberSchedule = (profile.availability[barberName] || {})[dayKey] || [];

            if (barberSchedule.length === 0) {
                this.hideTyping();
                this.addBotMessage(`<div class="bot-card"><p><strong>${barberName}</strong> no trabaja el ${date.toLocaleDateString()}.</p>${backButtonHTML}</div>`);
                return;
            }

            const startOfDay = new Date(date); startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(date); endOfDay.setHours(23, 59, 59, 999);

            const { data: bookings, error } = await supabase.from('bookings').select('booking_date').eq('barber_name', barberName).in('status', ['pending', 'confirmed']).gte('booking_date', startOfDay.toISOString()).lte('booking_date', endOfDay.toISOString());

            const bookedHours = bookings.map(b => new Date(b.booking_date).getHours());
            
            const slotsHTML = barberSchedule.map(hour => {
                const isBooked = bookedHours.includes(hour);
                return `<div class="time-slot ${isBooked ? 'booked' : 'available'}">${hour}:00</div>`;
            }).join('');
            
            const availableCount = barberSchedule.length - bookedHours.length;
            this.hideTyping();

            const availabilityCard = `<div class="bot-card">
                <h3>Disponibilidad para ${barberName}</h3>
                <p><strong>Fecha:</strong> ${date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                <div class="availability-grid">${slotsHTML}</div>
                <div class="availability-stats">
                    <div class="stat-item"><span class="stat-value" style="color: #28a745;">${availableCount}</span><span class="stat-label">Disponibles</span></div>
                    <div class="stat-item"><span class="stat-value" style="color: #dc3545;">${bookedHours.length}</span><span class="stat-label">Ocupados</span></div>
                    <div class="stat-item"><span class="stat-value">${barberSchedule.length}</span><span class="stat-label">Total</span></div>
                </div>
                ${backButtonHTML} 
            </div>`;

            this.addBotMessage(availabilityCard);
        }

        async startDayEditFlow(dayKey) {
            const days = { mon: 'Lunes', tue: 'Martes', wed: 'Mi√©rcoles', thu: 'Jueves', fri: 'Viernes', sat: 'S√°bado', sun: 'Domingo' };
            const dayName = days[dayKey];
            let optionsHTML = '';
            for (let i = 7; i <= 22; i++) {
                optionsHTML += `<option value="${i}">${i}:00</option>`;
            }

            const scheduleHTML = `<div class="bot-card">
                <h3>Configurar Horario para ${dayName}</h3>
                <p>Selecciona las horas de inicio y fin de la jornada. Las horas intermedias se a√±adir√°n autom√°ticamente.</p>
                <div class="schedule-selector">
                    <div class="schedule-row">
                        <label for="start-hour-${dayKey}">Desde:</label>
                        <select id="start-hour-${dayKey}">${optionsHTML}</select>
                    </div>
                    <div class="schedule-row">
                        <label for="end-hour-${dayKey}">Hasta:</label>
                        <select id="end-hour-${dayKey}">${optionsHTML}</select>
                    </div>
                </div>
                <div class="schedule-actions">
                     <button class="command-button confirm" data-day-confirm="${dayKey}">üíæ Guardar Horario</button>
                     <button class="command-button cancel" data-command="/horario-cerrado ${dayKey}">‚ùå Marcar como Cerrado</button>
                </div>
                 <button class="command-button full-width return" style="margin-top: 10px;" data-command="/horario-interno definir">‚Ü©Ô∏è Volver a los d√≠as</button>
            </div>`;

            this.addBotMessage(scheduleHTML);
            document.getElementById(`start-hour-${dayKey}`).value = '9';
            document.getElementById(`end-hour-${dayKey}`).value = '18';
        }

        async showFinanceMenu() {
            this.showTyping();
            await this.refreshProfileFromDB(); 

            const { data: transactions, error } = await supabase
                .from('transactions')
                .select('*')
                .eq('barber_id', this.barberProfile.id)
                .order('created_at', { ascending: false })
                .limit(5);

            this.hideTyping();
            
            let transactionsHTML = '<li><p>A√∫n no tienes transacciones.</p></li>';
            if (transactions && transactions.length > 0) {
                transactionsHTML = transactions.map(t => {
                    const date = new Date(t.created_at).toLocaleDateString();
                    return `<li><span class="item-name">${t.description || 'Venta'} (${t.barber_name_performer})</span> <span class="item-detail" style="color: #28a745;">+${t.amount} Bs.</span></li>`;
                }).join('');
            }

            const financeCard = `
            <div class="bot-card">
                <h3>üí∞ Finanzas</h3>
                <div class="stat-item" style="text-align: left; margin-bottom: 20px;">
                    <span class="stat-label">Tu Saldo Actual</span>
                    <span class="stat-value" style="font-size: 2em;">${(this.barberProfile.balance || 0).toFixed(2)} Bs.</span>
                </div>
                <h4>√öltimas Transacciones</h4>
                <ul>${transactionsHTML}</ul>
                <div class="command-buttons-container">
                    <button class="command-button confirm" data-command="/generar_qr">üì≤ Generar Cobro QR</button>
                    <button class="command-button return full-width" data-command="menu">‚Ü©Ô∏è Volver al Men√∫</button>
                </div>
            </div>`;
            this.addBotMessage(financeCard);
        }

        async promptForQRCodeGeneration() {
            const profile = await this.getBarberProfile();
            let barberSelectorHTML = '';

            if (profile.is_team_account) {
                const barbers = Object.keys(profile.availability || {});
                const options = barbers.map(b => `<option value="${b}">${b}</option>`).join('');
                barberSelectorHTML = `
                <div class="qr-form-row">
                    <label for="qr-barber">Barbero:</label>
                    <select id="qr-barber">${options}</select>
                </div>`;
            }

            const formHTML = `
            <div class="bot-card">
                <h3>Generar Cobro QR</h3>
                <div class="qr-form">
                    ${barberSelectorHTML}
                    <div class="qr-form-row">
                        <label for="qr-amount">Monto (Bs.):</label>
                        <input type="number" id="qr-amount" placeholder="Ej: 5.00">
                    </div>
                    <div class="qr-form-row">
                        <label for="qr-desc">Descripci√≥n:</label>
                        <input type="text" id="qr-desc" placeholder="Ej: Corte de cabello">
                    </div>
                </div>
                <div class="command-buttons-container">
                    <button class="command-button confirm" onclick="app.generatePaymentQR()">Generar QR</button>
                    <button class="command-button return" data-command="/finanzas">Cancelar</button>
                </div>
            </div>`;
            this.addBotMessage(formHTML);
        }

        generatePaymentQR() {
            const amount = document.getElementById('qr-amount').value;
            const description = document.getElementById('qr-desc').value;
            const barberSelect = document.getElementById('qr-barber');
            const performer = barberSelect ? barberSelect.value : this.barberProfile.first_name;

            if (!amount || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
                alert("Por favor, introduce un monto v√°lido.");
                return;
            }

            const paymentData = {
                barber_id: this.barberProfile.id,
                amount: parseFloat(amount).toFixed(2),
                description: description || 'Servicio de Barber√≠a',
                performer: performer
            };

            const qr = qrcode(0, 'M');
            qr.addData(JSON.stringify(paymentData));
            qr.make();

            const qrCodeHTML = `
            <div class="bot-card">
                <h3>Muestra este QR al cliente</h3>
                <p>El cliente debe escanearlo desde su app para registrar el pago de <strong>${paymentData.amount} Bs.</strong></p>
                <div id="qrcode-display">${qr.createImgTag(6, 8)}</div>
                <p class="helper-text">Esperando confirmaci√≥n del cliente...</p>
                <div class="command-buttons-container">
                    <button class="command-button return full-width" data-command="/finanzas">‚Ü©Ô∏è Volver a Finanzas</button>
                </div>
            </div>`;

            this.addUserMessage(`Generar QR por ${paymentData.amount} Bs.`);
            this.addBotMessage(qrCodeHTML);
        }

        async addService(name, price) {
            const barberName = this.userData.selectedBarber;
            const p = parseFloat(price);
            if (isNaN(p) || p < 0) {
                this.addBotMessage('<div class="bot-card"><p>El precio no es v√°lido.</p></div>');
                this.showServicesMenu();
                return;
            }

            this.showTyping();
            
            const b = await this.getBarberProfile();
            const services = JSON.parse(JSON.stringify(b.services || {}));
            if (!services[barberName]) {
                services[barberName] = [];
            }
            services[barberName].push({ name: name, price: p });

            const { error } = await supabase
                .from('barbers')
                .update({ services: services })
                .eq('user_id', this.currentUser.id);

            this.hideTyping();

            if (error) {
                console.error("Error al guardar el servicio:", error);
                this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al guardar el servicio.</p></div>');
            } else {
                this.addBotMessage(`<div class="bot-card"><p>¬°Genial! ‚ú® He a√±adido "<strong>${name}</strong>" a los servicios de <strong>${barberName}</strong>.</p></div>`);
                await this.refreshProfileFromDB();
            }

            this.currentFlow = 'authenticated';
            await this.showServices();
        }
        
        async setAvailability(dayKey, hours) {
            const barberName = this.userData.selectedBarber;
            if (!barberName) { this.addBotMessage('<div class="bot-card"><p>Error: No se ha seleccionado un barbero.</p></div>'); return; }
            
            const b = await this.getBarberProfile();
            let avail = b.availability || {};
            if (!avail[barberName]) avail[barberName] = {};

            avail[barberName][dayKey] = Array.isArray(hours) ? hours.sort((a,b) => a-b) : [];
            
            const { error } = await supabase.from('barbers').update({ availability: avail }).eq('user_id', this.currentUser.id);
            if (!error) {
                this.addBotMessage(`<div class="bot-card"><p>¬°Perfecto! El horario de <strong>${barberName}</strong> ha sido guardado. üëç</p></div>`);
            } else {
                 this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al guardar el horario.</p></div>');
            }
            this.currentFlow = 'authenticated';
            await this.showAvailability();
        }

        async checkAuthState() { 
            this.showTyping(); 
            const { data: { session } } = await supabase.auth.getSession(); 
            this.hideTyping(); 
            if (session && session.user) { 
                this.currentUser = session.user; 
                const { data, error } = await supabase.from('barbers').select('*').eq('user_id', this.currentUser.id).single();
                if(data) this.barberProfile = data;

                const name = this.barberProfile.first_name || this.currentUser.email; 
                this.addBotMessage(`<div class="bot-card"><p>¬°Qu√© bueno verte de nuevo, <strong>${name}</strong>! üëã</p><p>Estoy listo para ayudarte a organizar tu d√≠a.</p></div>`); 
                this.showMainMenu(); 
                this.currentFlow = 'authenticated'; 
                this.subscribeToNotifications(); 
                this.subscribeToBookings();
                this.subscribeToTransactions();
            } else { 
                this.startWelcomeFlow(); 
            } 
        }

        startWelcomeFlow() { this.addBotMessage(`<div class="bot-card"><h3>¬°Bienvenido a BarberConnect! üíà</h3><p>Soy tu asistente virtual, y estoy aqu√≠ para ayudarte a gestionar tu barber√≠a de forma sencilla.</p><p>Para empezar, ¬øeres un <strong>barbero</strong>?</p></div>`); this.currentFlow = 'welcome'; }
        async handleAuthFlow(input) { switch(this.currentFlow) { case 'welcome': if (input === 'barbero') { this.addBotMessage(`<div class="bot-card"><p>¬°Excelente! ¬øYa tienes una cuenta con nosotros?</p><p>Por favor, responde <strong>s√≠</strong> o <strong>no</strong>.</p></div>`); this.currentFlow = 'has_account'; } else { this.addBotMessage(`<div class="bot-card"><p>Entendido. Esta interfaz est√° dise√±ada especialmente para barberos. ¬°Esperamos verte pronto!</p></div>`) } break; case 'has_account': if (input.startsWith('s')) { this.addBotMessage('<div class="bot-card"><p>¬°Perfecto! Por favor, ingresa tu correo electr√≥nico para iniciar sesi√≥n.</p></div>'); this.currentFlow = 'login_email'; } else { this.addBotMessage('<div class="bot-card"><p>¬°Genial, vamos a crear tu cuenta! Primero, ¬øcu√°l es tu nombre?</p></div>'); this.currentFlow = 'register_name'; } break; case 'register_name': this.userData.firstName = input; this.addBotMessage(`<div class="bot-card"><p>¬°Un placer, ${input}! Ahora, ¬øcu√°l es tu apellido?</p></div>`); this.currentFlow = 'register_last_name'; break; case 'register_last_name': this.userData.lastName = input; this.addBotMessage('<div class="bot-card"><p>Muy bien. Ahora necesito tu correo electr√≥nico. Lo usaremos para iniciar sesi√≥n.</p></div>'); this.currentFlow = 'register_email'; break; case 'register_email': this.userData.email = input; this.addBotMessage('<div class="bot-card"><p>Para terminar, crea una contrase√±a segura (debe tener al menos 6 caracteres).</p></div>'); this.currentFlow = 'register_password'; break; case 'register_password': if (input.length < 6) { this.addBotMessage('<div class="bot-card"><p>La contrase√±a es muy corta. Por seguridad, necesita al menos 6 caracteres. ¬°Intenta con otra!</p></div>'); return; } this.userData.password = input; await this.registerUser(); break; case 'login_email': this.userData.email = input; this.addBotMessage('<div class="bot-card"><p>Gracias. Ahora, ingresa tu contrase√±a.</p></div>'); this.currentFlow = 'login_password'; break; case 'login_password': await this.loginUser(input); break; } }
        async registerUser() { const { data, error } = await supabase.auth.signUp({ email: this.userData.email, password: this.userData.password, options: { data: { first_name: this.userData.firstName, last_name: this.userData.lastName, user_type: 'barbero' } } }); if (error) { this.addBotMessage(`<div class="bot-card"><p>‚ùå Hubo un error en el registro: ${error.message}. Por favor, int√©ntalo de nuevo.</p></div>`); this.startWelcomeFlow(); return; } if (data.user) { this.currentUser = data.user; await this.createBarberProfile(data.user.id); this.addBotMessage('<div class="bot-card"><h3>¬°Cuenta Creada! üöÄ</h3><p>Tu registro fue un √©xito. Te he enviado un correo de confirmaci√≥n. Una vez que lo verifiques, tendr√°s acceso a todo.</p></div>'); this.showMainMenu(); this.currentFlow = 'authenticated'; } }
        
        async createBarberProfile(userId) {
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            const barberName = this.userData.firstName;
            const initialAvailability = { [barberName]: {} };
            const initialServices = { [barberName]: [] };

            await supabase.from('barbers').insert([{ 
                user_id: userId, 
                first_name: this.userData.firstName, 
                last_name: this.userData.lastName, 
                barber_shop_name: `Barber√≠a de ${this.userData.firstName}`, 
                services: initialServices,
                availability: initialAvailability,
                public_code: code,
                is_team_account: false,
                balance: 0
            }]); 
        }

// ‚¨áÔ∏è REEMPLAZA TU FUNCI√ìN ACTUAL POR ESTA VERSI√ìN MEJORADA EN index.html ‚¨áÔ∏è
async loginUser(password) {
    this.showTyping(); // A√±ade un feedback visual mientras se procesa
    const { data, error } = await supabase.auth.signInWithPassword({
        email: this.userData.email,
        password: password
    });
    this.hideTyping();

    if (error) {
        // 1. Siempre registra el error en la consola para depuraci√≥n
        console.error("Error de inicio de sesi√≥n de Supabase:", error);

        // 2. Comprueba si el error es por falta de confirmaci√≥n de email
        if (error.message && error.message.includes('Email not confirmed')) {
            this.addBotMessage(
                `<div class="bot-card" style="background-color: #ffffcc;">
                    <p><strong>‚ö†Ô∏è Tu cuenta no ha sido confirmada.</strong></p>
                    <p>Por favor, revisa tu bandeja de entrada (y la carpeta de spam) y haz clic en el enlace de confirmaci√≥n que te enviamos al registrarte.</p>
                </div>`
            );
        } else {
            // 3. Para cualquier otro error, muestra el mensaje gen√©rico mejorado
            this.addBotMessage(
                `<div class="bot-card">
                    <p>‚ùå Usuario o contrase√±a incorrectos.</p>
                    <small style="color: #666;">Si el problema persiste, aseg√∫rate de que tus datos son correctos y que has confirmado tu correo electr√≥nico.</small>
                </div>`
            );
        }
        
        // Reinicia el flujo para que el usuario pueda intentarlo de nuevo
        this.currentFlow = 'has_account';
        setTimeout(() => this.handleAuthFlow('si'), 1500);
        return;
    }
    
    // Si no hay error, el inicio de sesi√≥n es exitoso
    this.currentUser = data.user;
    this.addBotMessage('<div class="bot-card"><p>‚úÖ ¬°Inicio de sesi√≥n exitoso!</p></div>');
    this.checkAuthState();
}
        
        async logout() { 
            await supabase.auth.signOut(); 
            if (this.notificationsSubscription) { this.notificationsSubscription.unsubscribe(); this.notificationsSubscription = null; } 
            if (this.bookingsSubscription) { this.bookingsSubscription.unsubscribe(); this.bookingsSubscription = null; } 
            if (this.chatSubscription) { this.chatSubscription.unsubscribe(); this.chatSubscription = null; } 
            if (this.transactionsSubscription) { this.transactionsSubscription.unsubscribe(); this.transactionsSubscription = null; }
            this.currentUser = null; this.barberProfile = null; this.userData = {}; this.addBotMessage('<div class="bot-card"><p>¬°Hasta pronto! Tu sesi√≥n se ha cerrado de forma segura. üëã</p></div>'); 
            setTimeout(() => { this.messagesContainer.innerHTML = ''; this.startWelcomeFlow(); }, 1500); 
        }
        
        async subscribeToNotifications() { 
            if (this.notificationsSubscription || !this.barberProfile) return; 
            const { data: chats, error } = await supabase.from('chats').select('id').eq('barber_id', this.barberProfile.id); 
            if (error || !chats || chats.length === 0) return; 
            const chatIds = chats.map(c => c.id); 
            this.notificationsSubscription = supabase.channel('barber_notifications')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=in.(${chatIds.join(',')})` }, payload => { 
                    if (payload.new.sender_type === 'client' && payload.new.chat_id !== this.activeChat.id) { 
                        const chatId = payload.new.chat_id;
                        this.unreadCounts[chatId] = (this.unreadCounts[chatId] || 0) + 1;
                        this.updateBadges();
                        const indicator = document.getElementById(`unread-${chatId}`); 
                        if (indicator) indicator.classList.add('visible'); 
                    } 
                }).subscribe(); 
        }

        async subscribeToBookings() {
            if (this.bookingsSubscription || !this.barberProfile) return;
            this.bookingsSubscription = supabase
                .channel('barber_bookings')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'bookings',
                    filter: `barber_id=eq.${this.barberProfile.id}`
                }, payload => {
                    // --- BLOQUE MODIFICADO ---
                    this.newBookingsData.push(payload.new);
                    this.updateBadges();
                })
                .subscribe();
        }

        async subscribeToTransactions() {
            if (this.transactionsSubscription || !this.barberProfile) return;
            
            this.transactionsSubscription = supabase
                .channel(`barber_transactions_${this.barberProfile.id}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'transactions',
                    filter: `barber_id=eq.${this.barberProfile.id}`
                }, async (payload) => {
                    this.newTransactionsCount++;
                    this.updateBadges();

                    await this.refreshProfileFromDB();

                    if (document.querySelector('[data-command="/finanzas"]')) {
                         this.addBotMessage(`<div class="bot-card" style="border-left: 4px solid #28a745;"><p><strong>¬°Nuevo pago recibido!</strong> Tu saldo ha sido actualizado.</p></div>`);
                    }
                })
                .subscribe();
        }
        
        async showClientChats() { 
            const { data: chats, error } = await supabase.from('chats').select(`id, clients (id, first_name, last_name)`).eq('barber_id', this.barberProfile.id); 
            if (error) { console.error(error); return; } 
            this.clientChatsList.innerHTML = ''; 
            if (chats.length === 0) { 
                this.clientChatsList.innerHTML = '<li>A√∫n no tienes ninguna conversaci√≥n. Cuando un cliente te contacte, aparecer√° aqu√≠.</li>'; 
            } else { 
                chats.forEach(chat => { 
                    const client = chat.clients; 
                    const clientName = `${client.first_name} ${client.last_name}`; 
                    const listItem = document.createElement('li'); 
                    listItem.dataset.chatId = chat.id; listItem.dataset.clientId = client.id; 
                    listItem.dataset.clientName = clientName; 
                    
                    const isUnread = this.unreadCounts[chat.id] > 0;
                    
                    listItem.innerHTML = `<div class="avatar">${clientName.charAt(0)}</div><div class="chat-info"><div class="chat-name">${clientName}</div></div><div class="unread-indicator ${isUnread ? 'visible' : ''}" id="unread-${chat.id}"></div>`; 
                    listItem.addEventListener('click', () => this.openChat(chat.id, client.id, clientName)); 
                    this.clientChatsList.appendChild(listItem); 
                }); 
            } 
            this.switchView('clientChatsView'); 
        }

        async openChat(chatId, clientId, clientName) { 
            if (this.unreadCounts[chatId]) {
                delete this.unreadCounts[chatId];
                this.updateBadges();
            }
            const indicator = document.getElementById(`unread-${chatId}`); 
            if (indicator) indicator.classList.remove('visible'); 
            
            this.activeChat = { id: chatId, clientName, clientId }; 
            this.switchView('singleChatView'); 
            this.singleChatMessages.innerHTML = 'Cargando mensajes...'; 
            const { data: messages, error } = await supabase.from('messages').select('*').eq('chat_id', chatId).order('created_at', { ascending: true }); 
            this.singleChatMessages.innerHTML = ''; 
            if (messages) messages.forEach(msg => this.renderMessage(msg, this.singleChatMessages, false)); 
            this.singleChatMessages.scrollTop = this.singleChatMessages.scrollHeight; 
            this.subscribeToChatChannel(chatId); 
        }

        subscribeToChatChannel(chatId) { 
            if (this.chatSubscription) this.chatSubscription.unsubscribe(); 
            this.chatSubscription = supabase.channel(`chat_${chatId}`)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}`}, (payload) => { 
                    if (payload.new.sender_type === 'client') this.renderMessage(payload.new, this.singleChatMessages); 
                }).subscribe(); 
        }
        
        async sendClientMessage(text) { 
            if (!this.activeChat.id) return; 
            const messagePayload = { chat_id: this.activeChat.id, sender_type: 'barber', sender_id: this.barberProfile.id, content: text }; 
            this.renderMessage({ ...messagePayload }, this.singleChatMessages); 
            await supabase.from('messages').insert(messagePayload); 
        }
    }
    
    let app;
    document.addEventListener('DOMContentLoaded', () => {
        app = new ChatApp();
    }); 
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarberConnect</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Estilos base (sin cambios) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-container { width: 100%; max-width: 400px; height: 100vh; background: white; display: flex; flex-direction: column; box-shadow: 0 0 10px rgba(0,0,0,0.1); overflow: hidden; }
        .chat-header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 20px; 
            text-align: center; 
            border-bottom: 1px solid #e0e0e0; 
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-header h1 { margin: 0; font-size: 1.5em; }
        .chat-header p { margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em; }
        .back-button { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 1.5em; cursor: pointer; display: none; }
        .messages-container { flex: 1; padding: 15px; overflow-y: auto; background: #f8f9fa; }
        .message { margin-bottom: 12px; display: flex; flex-direction: column; animation: fadeIn 0.3s ease-in; }
        .message.user { align-items: flex-end; }
        .message.bot { align-items: flex-start; }
        .message-content { padding: 10px 14px; border-radius: 18px; max-width: 85%; word-wrap: break-word; line-height: 1.4; }
        .message.user .message-content { background: #764ba2; color: white; border-bottom-right-radius: 4px; }
        .message.bot .message-content { background: #e9ecef; color: #333; border-bottom-left-radius: 4px; }
        .message.bot .bot-card-wrapper { background: transparent; padding: 0; border: none; max-width: 95%; }
        .message-time { font-size: 0.7em; color: #666; margin-top: 4px; padding: 0 8px; }
        .typing { display: flex; padding: 10px 14px; background: white; border-radius: 18px; border-bottom-left-radius: 4px; border: 1px solid #e0e0e0; }
        .typing span { height: 6px; width: 6px; background: #999; border-radius: 50%; display: block; margin: 0 2px; animation: typing 1s infinite ease-in-out; }
        .typing span:nth-child(1) { animation-delay: 0.2s; }
        .typing span:nth-child(2) { animation-delay: 0.4s; }
        .typing span:nth-child(3) { animation-delay: 0.6s; }
        .input-container { display: flex; padding: 12px; background: white; border-top: 1px solid #e0e0e0; gap: 8px; }
        .message-input { flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px; outline: none; font-size: 14px; }
        .send-button { padding: 10px 16px; background: #007bff; color: white; border: none; border-radius: 20px; cursor: pointer; }
        .send-button:disabled { background: #ccc; cursor: not-allowed; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        .bot-card { background-color: #ffffff; border: 1px solid #e9ecef; border-radius: 12px; padding: 16px; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .bot-card h3 { margin: 0 0 12px 0; color: #343a40; border-bottom: 1px solid #f1f3f5; padding-bottom: 8px; font-size: 1.1em; }
        .bot-card h4 { margin-top: 20px; margin-bottom: 8px; padding-top: 12px; border-top: 1px solid #f1f3f5; }
        .bot-card p { margin: 0 0 8px 0; line-height: 1.5; color: #495057; }
        .bot-card ul { list-style: none; padding: 0; margin: 0; }
        .bot-card li { padding: 8px 0; border-bottom: 1px solid #f1f3f5; display: flex; justify-content: space-between; align-items: center; }
        .bot-card li:last-child { border-bottom: none; }
        .bot-card .item-name { font-weight: 500; color: #212529; }
        .bot-card .item-detail { color: #6c757d; font-size: 0.9em; text-align: right; }
        .bot-card .helper-text { font-size: 0.8em; color: #888; margin-top: 5px; }
        .command-buttons-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
        .command-button { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px 8px; font-size: 0.9em; font-weight: 500; color: #495057; cursor: pointer; text-align: center; transition: background-color 0.2s, box-shadow 0.2s; width: 100%; }
        .command-button:hover { background-color: #e9ecef; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .command-button.full-width { grid-column: 1 / -1; }
        .command-button.confirm { background-color: #28a745; color: white; }
        .command-button.cancel { background-color: #dc3545; color: white; }
        .command-button.return { background-color: #f1f3f5; color: #888; }
        .schedule-selector { display: flex; flex-direction: column; gap: 12px; }
        .schedule-row { display: flex; align-items: center; gap: 10px; }
        .schedule-row label { font-weight: 500; color: #495057; flex-basis: 100px; }
        .schedule-row select { flex-grow: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1em; }
        .schedule-actions { margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .view { display: none; flex: 1; flex-direction: column; min-height: 0; }
        .view.active { display: flex; }
        #clientChatsView ul { list-style: none; padding: 10px 0; overflow-y: auto; }
        #clientChatsView li { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; gap: 12px; }
        #clientChatsView li:hover { background: #f8f9fa; }
        #clientChatsView .avatar { width: 45px; height: 45px; background: #667eea; color: white; border-radius: 50%; display: grid; place-items: center; font-weight: bold; flex-shrink: 0; }
        #clientChatsView .chat-info { flex: 1; }
        #clientChatsView .chat-name { font-weight: 500; }
        #clientChatsView .unread-indicator { width: 10px; height: 10px; background: #007bff; border-radius: 50%; visibility: hidden; transition: visibility 0.2s; }
        #clientChatsView .unread-indicator.visible { visibility: visible; }
        .availability-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 8px; margin: 10px 0; }
        .time-slot { padding: 8px 5px; border-radius: 6px; text-align: center; font-size: 0.8em; font-weight: 500; }
        .time-slot.available { background: #28a745; color: white; }
        .time-slot.booked { background: #dc3545; color: white; }
        .availability-stats { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 10px; border-top: 1px solid #e9ecef; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.2em; font-weight: bold; }
        .stat-label { font-size: 0.8em; color: #6c757d; }
        
        /* --- ESTILOS PARA NOTIFICACIONES (NUEVO) --- */
        .header-icons {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 16px;
        }
        .icon-wrapper {
            position: relative;
            cursor: pointer;
        }
        .icon-wrapper svg {
            width: 26px;
            height: 26px;
            fill: white;
            opacity: 0.9;
            transition: opacity 0.2s;
        }
        .icon-wrapper:hover svg {
            opacity: 1;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -8px;
            background-color: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
            font-weight: bold;
            border: 2px solid #667eea;
        }
        .notification-badge.visible {
            display: flex;
            animation: pulse-badge 2s infinite;
        }
        @keyframes pulse-badge {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 8px rgba(255, 71, 87, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
             <span class="back-button" id="backButton">‚Üê</span>
             <div id="header-title">
                <h1>üíà BarberConnect</h1>
                <p id="headerSubtitle">Asistente Virtual</p>
             </div>
             <!-- Iconos de notificaci√≥n -->
             <div class="header-icons">
                <div class="icon-wrapper" id="chatsIconWrapper" title="Ver mis chats">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 10H6v-2h12v2zm0-4H6V6h12v2z"></path></svg>
                    <span class="notification-badge" id="chatsBadge"></span>
                </div>
                <div class="icon-wrapper" id="bookingsIconWrapper" title="Ver nuevas citas">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"></path></svg>
                    <span class="notification-badge" id="bookingsBadge"></span>
                </div>
            </div>
        </div>

        <div id="botView" class="view active">
            <div class="messages-container" id="messagesContainer"></div>
        </div>

        <div id="clientChatsView" class="view">
            <ul id="clientChatsList"></ul>
        </div>
        
        <div id="singleChatView" class="view">
            <div class="messages-container" id="singleChatMessages"></div>
        </div>

        <div class="input-container">
            <input type="text" class="message-input" id="messageInput" placeholder="Escribe un mensaje...">
            <button class="send-button" id="sendButton">‚û§</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://olkjevlkqdafbhuiszfz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sa2pldmxrcWRhZmJodWlzemZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNzc5ODcsImV4cCI6MjA3NDg1Mzk4N30.5V7LTjITA3szqyNxUy67K0r1IhaB9MpnxSML7IygYcM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        class ChatApp {
            constructor() {
                this.currentFlow = 'checking_auth';
                this.userData = {};
                this.isTyping = false;
                this.currentUser = null;
                this.barberProfile = null;
                this.activeView = 'bot';
                this.activeChat = { id: null, clientName: null, clientId: null };
                
                // State para notificaciones
                this.unreadCounts = {};
                this.newBookingsCount = 0;

                // Subscripciones de Supabase
                this.chatSubscription = null;
                this.notificationsSubscription = null;
                this.bookingsSubscription = null;

                // Elementos de la UI
                this.messagesContainer = document.getElementById('messagesContainer');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.headerSubtitle = document.getElementById('headerSubtitle');
                this.backButton = document.getElementById('backButton');
                this.clientChatsList = document.getElementById('clientChatsList');
                this.singleChatMessages = document.getElementById('singleChatMessages');

                // Elementos de notificaciones
                this.chatsBadge = document.getElementById('chatsBadge');
                this.bookingsBadge = document.getElementById('bookingsBadge');
                this.chatsIconWrapper = document.getElementById('chatsIconWrapper');
                this.bookingsIconWrapper = document.getElementById('bookingsIconWrapper');

                this.init();
            }
            
            async init() {
                this.sendButton.addEventListener('click', () => this.handleSend());
                this.messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.handleSend(); });
                this.messagesContainer.addEventListener('click', this.handleButtonClick.bind(this));
                this.backButton.addEventListener('click', () => this.handleBack());

                // Event listeners para los iconos de notificaci√≥n
                this.chatsIconWrapper.addEventListener('click', () => this.showClientChats());
                this.bookingsIconWrapper.addEventListener('click', () => {
                    this.showAllBookings();
                    this.newBookingsCount = 0;
                    this.updateBadges();
                });

                await this.checkAuthState();
            }

            updateBadges() {
                // Insignia de mensajes
                const totalUnread = Object.values(this.unreadCounts).reduce((sum, count) => sum + count, 0);
                if (totalUnread > 0) {
                    this.chatsBadge.textContent = totalUnread > 9 ? '9+' : totalUnread;
                    this.chatsBadge.classList.add('visible');
                } else {
                    this.chatsBadge.classList.remove('visible');
                }

                // Insignia de reservas
                if (this.newBookingsCount > 0) {
                    this.bookingsBadge.textContent = this.newBookingsCount > 9 ? '9+' : this.newBookingsCount;
                    this.bookingsBadge.classList.add('visible');
                } else {
                    this.bookingsBadge.classList.remove('visible');
                }
            }

            switchView(viewName) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(viewName).classList.add('active');
                this.activeView = viewName.replace('View', '');

                const headerTitleDiv = document.getElementById('header-title');
                if (this.activeView === 'bot' || this.activeView === 'clientChats') {
                    headerTitleDiv.style.display = 'block';
                    this.headerSubtitle.textContent = this.activeView === 'bot' ? 'Asistente Virtual' : 'Mis Chats';
                    this.backButton.style.display = 'none';
                    this.activeChat.id = null;
                    if (this.chatSubscription) { this.chatSubscription.unsubscribe(); this.chatSubscription = null; }
                } else {
                    headerTitleDiv.style.display = 'block';
                    this.headerSubtitle.textContent = `Hablando con ${this.activeChat.clientName}`;
                    this.backButton.style.display = 'block';
                }
            }
            
            handleBack() {
                if (this.activeView === 'singleChat') {
                    this.switchView('clientChatsView');
                }
            }

            async handleButtonClick(event) {
                const button = event.target.closest('.command-button');
                if (!button || button.disabled) return;
                const buttonContainer = button.closest('.command-buttons-container, .schedule-actions');
                if (buttonContainer) { buttonContainer.querySelectorAll('.command-button').forEach(btn => btn.disabled = true); }
                const command = button.dataset.command;
                const serviceToEdit = button.dataset.serviceEdit;
                const dayToEdit = button.dataset.dayEdit;
                const dayToConfirm = button.dataset.dayConfirm;

                if (command) {
                    this.addUserMessage(button.textContent.trim());
                    if (command.startsWith('check_availability:')) {
                        const dateString = command.split(':')[1];
                        const parts = dateString.split('-');
                        const date = new Date(parts[0], parts[1] - 1, parts[2]);
                        if (isNaN(date.getTime())) { this.addBotMessage(`<div class="bot-card"><p>‚ùå Error: La fecha recibida no es v√°lida.</p></div>`); return; }
                        await this.showAvailabilityForDate(date);
                    } else {
                        await this.processUserInput(command.toLowerCase());
                    }
                } else if (serviceToEdit) {
                    const serviceName = JSON.parse(serviceToEdit.replace(/'/g, '"')).name;
                    this.addUserMessage(`Quiero editar el servicio: ${serviceName}`);
                    await this.startServiceEditFlow(serviceToEdit);
                } else if (dayToEdit) {
                    const dayName = { mon: 'Lunes', tue: 'Martes', wed: 'Mi√©rcoles', thu: 'Jueves', fri: 'Viernes', sat: 'S√°bado', sun: 'Domingo' }[dayToEdit];
                    this.addUserMessage(`Configurar horario para: ${dayName}`);
                    await this.startDayEditFlow(dayToEdit);
                } else if (dayToConfirm) {
                    const startHour = document.getElementById(`start-hour-${dayToConfirm}`).value;
                    const endHour = document.getElementById(`end-hour-${dayToConfirm}`).value;
                    if (parseInt(startHour) >= parseInt(endHour)) { this.addBotMessage('<div class="bot-card"><p>UPS... La hora de finalizaci√≥n debe ser mayor que la de inicio. Por favor, int√©ntalo de nuevo.</p></div>'); this.showHorarioMenu(); return; }
                    this.addUserMessage(`Confirmar horario de ${startHour}:00 a ${endHour}:00`);
                    let hours = [];
                    for (let i = parseInt(startHour); i < parseInt(endHour); i++) { hours.push(i); }
                    await this.setAvailability(dayToConfirm, hours);
                }
            }
            
            async handleSend() {
                const text = this.messageInput.value.trim();
                if (!text || this.isTyping) return;
                this.messageInput.value = '';
                if (this.activeView === 'bot') { this.addUserMessage(text); await this.processUserInput(text.toLowerCase()); } 
                else if (this.activeView === 'singleChat') { await this.sendClientMessage(text); }
            }

            addMessage(text, sender, container) { const message = { text, sender, time: new Date() }; this.renderMessage(message, container); }
            addUserMessage(text) { this.addMessage(text, 'user', this.messagesContainer); }
            addBotMessage(htmlContent) { this.addMessage(`<div class="bot-card-wrapper">${htmlContent}</div>`, 'bot', this.messagesContainer); }
            
            renderMessage(message, container, isNew = true) {
                const targetContainer = container || (this.activeView === 'singleChat' ? this.singleChatMessages : this.messagesContainer);
                const messageDiv = document.createElement('div');
                let senderClass = 'bot';
                if (message.sender === 'user' || message.sender_type === 'barber') { senderClass = 'user'; }
                messageDiv.className = `message ${senderClass}`;
                const content = message.text || message.content;
                let time;
                try { time = new Date(message.time || message.created_at || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); } 
                catch (error) { time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
                messageDiv.innerHTML = `<div class="message-content">${content}</div><div class="message-time">${time}</div>`;
                targetContainer.appendChild(messageDiv);
                if (isNew) { targetContainer.scrollTop = targetContainer.scrollHeight; }
            }
            
            showTyping() { if (this.isTyping) return; this.isTyping = true; const typingDiv = document.createElement('div'); typingDiv.className = 'message bot'; typingDiv.id = 'typing-indicator'; typingDiv.innerHTML = `<div class="typing"><span></span><span></span><span></span></div>`; this.messagesContainer.appendChild(typingDiv); this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight; }
            hideTyping() { this.isTyping = false; const indicator = document.getElementById('typing-indicator'); if (indicator) indicator.remove(); }
            
            async processUserInput(input) {
                this.showTyping();
                await new Promise(resolve => setTimeout(resolve, 600));
                this.hideTyping();
                
                switch(this.currentFlow) {
                    case 'welcome': case 'has_account': case 'register_name':
                    case 'register_last_name': case 'register_email': case 'register_password':
                    case 'login_email': case 'login_password':
                        await this.handleAuthFlow(input);
                        break;
                    case 'servicio_add_name':
                        this.userData.tempServiceName = input;
                        this.addBotMessage(`<div class="bot-card"><p>¬°Entendido! El servicio se llamar√° "<strong>${input}</strong>".</p><p>Ahora, por favor, dime el precio (solo el n√∫mero).</p></div>`);
                        this.currentFlow = 'servicio_add_price';
                        break;
                    case 'servicio_add_price':
                        await this.addService(this.userData.tempServiceName, input);
                        break;
                    case 'servicio_edit_name':
                        this.userData.newServiceName = input;
                        const currentPrice = this.userData.serviceToEdit.price;
                        this.addBotMessage(`<div class="bot-card"><p>El precio actual es <strong>$${currentPrice}</strong>.</p><p>¬øCu√°l ser√° el nuevo precio?</p><p class="helper-text">Si no quieres cambiarlo, simplemente escribe 'mismo'.</p></div>`);
                        this.currentFlow = 'servicio_edit_price';
                        break;
                    case 'servicio_edit_price':
                        this.userData.newServicePrice = input;
                        await this.updateService();
                        break;
                    case 'authenticated':
                        await this.handleAuthenticatedCommand(input);
                        break;
                    default:
                        this.addBotMessage('<div class="bot-card"><p>Vaya, no he entendido eso. ¬øPodr√≠as intentarlo de nuevo o usar uno de los botones del men√∫ principal?</p></div>');
                }
            }

            async handleAuthenticatedCommand(input) {
                const [command, ...args] = input.split(' ');
                const argString = args.join(' ');

                switch(command) {
                    case '/miperfil': await this.showBarberProfile(); break;
                    case '/citas': await this.showAllBookings(); break;
                    case '/disponibilidad': await this.promptDateForAvailability(); break;
                    case '/chats': await this.showClientChats(); break;
                    case '/cerrar': await this.logout(); break;
                    case 'menu': case 'men√∫': this.showMainMenu(); break;
                    case '/horario':
                        if (argString === 'ver') await this.showAvailability();
                        else if (argString === 'definir') await this.promptDaySelection();
                        else this.showHorarioMenu();
                        break;
                    case '/horario-cerrado':
                        const dayKey = args[0];
                        if (dayKey) await this.setAvailability(dayKey, []);
                        break;
                    case '/servicios':
                        if (argString === 'ver') await this.showServices();
                        else if (argString === 'agregar') { this.addBotMessage('<div class="bot-card"><p>¬°Claro! Dime el nombre del nuevo servicio que quieres agregar.</p></div>'); this.currentFlow = 'servicio_add_name'; }
                        else if (argString === 'editar') await this.promptServiceSelectionToEdit();
                        else this.showServicesMenu();
                        break;
                    default:
                        this.addBotMessage('<div class="bot-card"><p>Lo siento, no reconozco ese comando. Aqu√≠ tienes las opciones principales para que elijas.</p></div>');
                        this.showMainMenu();
                }
            }

            showMainMenu() { const menuHTML = `<div class="bot-card"><h3>Men√∫ Principal</h3><p>Hola de nuevo, ¬øen qu√© te puedo ayudar hoy?</p><div class="command-buttons-container"><button class="command-button" data-command="/miperfil">üë§ Mi Perfil</button><button class="command-button" data-command="/horario">‚è∞ Mi Horario</button><button class="command-button" data-command="/servicios">üõ†Ô∏è Mis Servicios</button><button class="command-button" data-command="/citas">üìÖ Ver Citas</button><button class="command-button" data-command="/chats">üí¨ Mis Chats</button><button class="command-button full-width" data-command="/disponibilidad">üîç Ver Disponibilidad</button><button class="command-button full-width" data-command="/cerrar">üö™ Cerrar Sesi√≥n</button></div></div>`; this.addBotMessage(menuHTML); }
            showServicesMenu() { const menuHTML = `<div class="bot-card"><h3>üõ†Ô∏è Gesti√≥n de Servicios</h3><p>Desde aqu√≠ puedes administrar todo lo relacionado con los servicios que ofreces.</p><div class="command-buttons-container"><button class="command-button" data-command="/servicios ver">Ver Lista</button><button class="command-button" data-command="/servicios agregar">Agregar Nuevo</button><button class="command-button" data-command="/servicios editar">Editar / Borrar</button><button class="command-button full-width return" data-command="menu">Volver al Men√∫</button></div></div>`; this.addBotMessage(menuHTML); }
            showHorarioMenu() { const menuHTML = `<div class="bot-card"><h3>‚è∞ Gesti√≥n de Horario</h3><p>Define cu√°ndo est√°s disponible para que tus clientes puedan reservar.</p><div class="command-buttons-container"><button class="command-button" data-command="/horario ver">Ver mi Horario</button><button class="command-button" data-command="/horario definir">Definir/Editar</button><button class="command-button full-width return" data-command="menu">Volver al Men√∫</button></div></div>`; this.addBotMessage(menuHTML); }
            
            async showAllBookings() {
                const { data: bookings, error } = await supabase.from('bookings').select(`*, clients (first_name, last_name)`).eq('barber_id', this.barberProfile.id).order('booking_date', { ascending: true });
                if (error) { this.addBotMessage('<div class="bot-card"><p>‚ùå Hubo un error al cargar tus citas. Por favor, intenta de nuevo.</p></div>'); return; }
                
                const returnButton = `<div class="command-buttons-container" style="margin-top: 15px;"><button class="command-button full-width return" data-command="menu">üìã Volver al Men√∫</button></div>`;

                if (!bookings || bookings.length === 0) {
                    this.addBotMessage(`<div class="bot-card"><h3>üìÖ Todas tus Citas</h3><p>Por ahora no tienes ninguna cita programada. ¬°Cuando tus clientes reserven, aparecer√°n aqu√≠!</p>${returnButton}</div>`);
                    return;
                }
                
                let bookingsHTML = bookings.map(b => { const clientName = `${b.clients.first_name} ${b.clients.last_name}`; const formattedDate = new Date(b.booking_date).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' }); const statusBadge = b.status === 'confirmed' ? '‚úÖ Confirmada' : b.status === 'pending' ? '‚è≥ Pendiente' : '‚ùå Cancelada'; return `<li><span class="item-name">${clientName}</span><span class="item-detail">${formattedDate}<br><strong>${b.service_name}</strong> - $${b.price}<br>${statusBadge}</span></li>`; }).join('');
                this.addBotMessage(`<div class="bot-card"><h3>üìÖ Todas tus Citas (${bookings.length})</h3><ul>${bookingsHTML}</ul>${returnButton}</div>`);
            }

            async showDailyAvailability(date) {
                if (isNaN(date.getTime())) return { available: false, message: "‚ùå Fecha no v√°lida" };
                const dayMapping = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                const dayKey = dayMapping[date.getDay()];
                if (!this.barberProfile.availability || !this.barberProfile.availability[dayKey]) return { available: false, message: "A√∫n no has definido tu horario para este d√≠a. ¬øQuieres configurarlo ahora?" };
                const barberSchedule = this.barberProfile.availability[dayKey] || [];
                if (barberSchedule.length === 0) return { available: false, message: "Has marcado este d√≠a como no laborable. Si quieres cambiarlo, puedes editar tu horario." };
                const startOfDay = new Date(date); startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(date); endOfDay.setHours(23, 59, 59, 999);
                try {
                    const { data: existingBookings, error } = await supabase.from('bookings').select(`booking_date, status, service_name, clients ( first_name, last_name )`).eq('barber_id', this.barberProfile.id).in('status', ['pending', 'confirmed']).gte('booking_date', startOfDay.toISOString()).lte('booking_date', endOfDay.toISOString());
                    if (error) return { available: false, message: "‚ùå Error al consultar las reservas: " + error.message };
                    const bookedHours = existingBookings ? existingBookings.map(b => new Date(b.booking_date).getHours()) : [];
                    const availableHours = barberSchedule.filter(hour => !bookedHours.includes(hour));
                    const bookedHoursInSchedule = barberSchedule.filter(hour => bookedHours.includes(hour));
                    return { available: true, availableHours, bookedHours: bookedHoursInSchedule, totalSlots: barberSchedule.length, availableSlots: availableHours.length, bookedSlots: bookedHoursInSchedule.length, bookings: existingBookings || [] };
                } catch (error) { return { available: false, message: "‚ùå Error inesperado: " + error.message }; }
            }

            async showAvailabilityForDate(date) {
                if (isNaN(date.getTime())) { this.addBotMessage(`<div class="bot-card"><h3>‚ùå Error</h3><p>La fecha que seleccionaste no parece ser v√°lida.</p></div>`); return; }
                this.showTyping();
                const availability = await this.showDailyAvailability(date);
                this.hideTyping();
                const formattedDate = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                const returnButton = `<div class="command-buttons-container" style="margin-top: 20px;"><button class="command-button full-width return" data-command="menu">üìã Volver al Men√∫</button></div>`;

                if (!availability.available) {
                    this.addBotMessage(`<div class="bot-card"><h3>üîç Disponibilidad para ${formattedDate}</h3><p>${availability.message}</p><div class="command-buttons-container"><button class="command-button" data-command="/horario definir">‚è∞ Definir Horario</button></div>${returnButton}</div>`);
                    return;
                }
                
                let bookingsListHTML = '';
                if (availability.bookings && availability.bookings.length > 0) {
                    const bookingsItems = availability.bookings.sort((a, b) => new Date(a.booking_date) - new Date(b.booking_date)).map(b => { const clientName = b.clients ? `${b.clients.first_name} ${b.clients.last_name}` : 'Cliente'; const bookingTime = new Date(b.booking_date).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); return `<li><span class="item-name">${bookingTime} - ${clientName}</span><span class="item-detail">${b.service_name}</span></li>`; }).join('');
                    bookingsListHTML = `<h4>üóìÔ∏è Citas para este d√≠a (${availability.bookings.length})</h4><ul>${bookingsItems}</ul>`;
                }
                
                const availableHoursHTML = availability.availableHours.length > 0 ? `<p><strong>‚úÖ Horarios Disponibles (${availability.availableSlots}):</strong></p><div class="availability-grid">${availability.availableHours.map(hour => `<div class="time-slot available">${hour}:00</div>`).join('')}</div>` : '';
                const bookedHoursHTML = availability.bookedHours.length > 0 ? `<p><strong>‚ùå Horarios Ocupados (${availability.bookedSlots}):</strong></p><div class="availability-grid">${availability.bookedHours.map(hour => `<div class="time-slot booked">${hour}:00</div>`).join('')}</div>` : '';
                const occupancyRate = availability.totalSlots > 0 ? Math.round((availability.bookedSlots / availability.totalSlots) * 100) : 0;
                
                this.addBotMessage(`<div class="bot-card"><h3>üîç Disponibilidad para ${formattedDate}</h3><div class="availability-stats"><div class="stat-item"><div class="stat-value">${availability.totalSlots}</div><div class="stat-label">Total</div></div><div class="stat-item"><div class="stat-value" style="color: #28a745;">${availability.availableSlots}</div><div class="stat-label">Disponibles</div></div><div class="stat-item"><div class="stat-value" style="color: #dc3545;">${availability.bookedSlots}</div><div class="stat-label">Ocupados</div></div><div class="stat-item"><div class="stat-value">${occupancyRate}%</div><div class="stat-label">Ocupaci√≥n</div></div></div>${availableHoursHTML}${bookedHoursHTML}${bookingsListHTML}${returnButton}</div>`);
            }

            async promptDateForAvailability() {
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
                const dayAfterTomorrow = new Date(tomorrow); dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 1);
                const dateOptions = [{ label: 'Hoy', date: today }, { label: 'Ma√±ana', date: tomorrow }, { label: 'Pasado ma√±ana', date: dayAfterTomorrow }];
                const buttonsHTML = dateOptions.map(opt => { const year = opt.date.getFullYear(); const month = String(opt.date.getMonth() + 1).padStart(2, '0'); const day = String(opt.date.getDate()).padStart(2, '0'); const dateString = `${year}-${month}-${day}`; return `<button class="command-button" data-command="check_availability:${dateString}">${opt.label} (${opt.date.toLocaleDateString('es-ES')})</button>`; }).join('');
                this.addBotMessage(`<div class="bot-card"><h3>üîç Verificar Disponibilidad</h3><p>Selecciona una fecha para revisar tu agenda y las citas programadas.</p><div class="command-buttons-container">${buttonsHTML}<button class="command-button full-width return" data-command="menu">Volver al Men√∫</button></div></div>`);
            }

            async getBarberProfile() { if (this.barberProfile) return this.barberProfile; const { data, error } = await supabase.from('barbers').select('*').eq('user_id', this.currentUser.id).single(); if (error) { console.error(error); return null; } this.barberProfile = data; return data; }
            
            async showBarberProfile() {
                const b = await this.getBarberProfile();
                if (!b) return;
                const p = `<div class="bot-card">
                    <h3>üë§ Tu Perfil Profesional</h3>
                    <p>Aqu√≠ est√°n los datos principales de tu cuenta. Tus clientes ver√°n el nombre de tu barber√≠a y el c√≥digo para conectar contigo.</p>
                    <ul>
                        <li><span class="item-name">Nombre</span> <span class="item-detail">${b.first_name} ${b.last_name}</span></li>
                        <li><span class="item-name">Barber√≠a</span> <span class="item-detail">${b.barber_shop_name}</span></li>
                        <li><span class="item-name">Ubicaci√≥n</span> <span class="item-detail">${b.location || 'No especificada'}</span></li>
                        <li><span class="item-name">C√≥digo Cliente</span> <span class="item-detail" style="font-weight: bold; color: #000;">${b.public_code || 'N/A'}</span></li>
                    </ul>
                    <div class="command-buttons-container" style="margin-top: 15px;">
                        <button class="command-button full-width return" data-command="menu">üìã Volver al Men√∫</button>
                    </div>
                </div>`;
                this.addBotMessage(p);
            }

            async showServices() { const b = await this.getBarberProfile(); if (!b) return; let s = ''; if (b.services && b.services.length > 0) { s = b.services.map(svc => `<li><span class="item-name">${svc.name}</span><span class="item-detail">$${svc.price}</span></li>`).join(''); } else { s = '<p>Parece que a√∫n no has agregado ning√∫n servicio. ¬°Vamos a a√±adir el primero!</p>'; } this.addBotMessage(`<div class="bot-card"><h3>üõ†Ô∏è Tu Lista de Servicios</h3><ul>${s}</ul></div>`); this.showServicesMenu(); }
            async showAvailability() { const b = await this.getBarberProfile(); if (!b) return; const d = { mon: 'Lunes', tue: 'Martes', wed: 'Mi√©rcoles', thu: 'Jueves', fri: 'Viernes', sat: 'S√°bado', sun: 'Domingo' }; let a = Object.keys(d).map(k => { const h = b.availability[k] || []; const t = h.length > 0 ? h.map(hr => `${parseInt(hr)}:00`).join(', ') : 'Cerrado'; return `<li><span class="item-name">${d[k]}</span><span class="item-detail">${t}</span></li>`; }).join(''); this.addBotMessage(`<div class="bot-card"><h3>‚è∞ Tu Horario Semanal</h3><p>Este es el horario que tus clientes ver√°n al momento de reservar.</p><ul>${a}</ul></div>`); this.showHorarioMenu(); }
            async promptServiceSelectionToEdit() { const b = await this.getBarberProfile(); if (!b || !b.services || b.services.length === 0) { this.addBotMessage('<div class="bot-card"><p>No tienes servicios para editar. ¬øQuieres agregar uno nuevo?</p></div>'); this.showServicesMenu(); return; } const btns = b.services.map(s => `<button class="command-button" data-service-edit="${JSON.stringify(s).replace(/"/g, "'")}">${s.name} ($${s.price})</button>`).join(''); this.addBotMessage(`<div class="bot-card"><h3>Selecciona un servicio para editar</h3><div class="command-buttons-container">${btns}<button class="command-button full-width return" data-command="/servicios">Cancelar</button></div></div>`); }
            async startServiceEditFlow(serviceDataString) { this.userData.serviceToEdit = JSON.parse(serviceDataString.replace(/'/g, '"')); this.addBotMessage(`<div class="bot-card"><p>Est√°s editando "<strong>${this.userData.serviceToEdit.name}</strong>".</p><p>¬øCu√°l es el nuevo nombre que le quieres dar?</p><p class="helper-text">Si no quieres cambiarlo, simplemente escribe 'mismo'.</p></div>`); this.currentFlow = 'servicio_edit_name'; }
            async promptDaySelection() { const d = { mon: 'Lunes', tue: 'Martes', wed: 'Mi√©rcoles', thu: 'Jueves', fri: 'Viernes', sat: 'S√°bado', sun: 'Domingo' }; const btns = Object.entries(d).map(([k, n]) => `<button class="command-button" data-day-edit="${k}">${n}</button>`).join(''); this.addBotMessage(`<div class="bot-card"><h3>Selecciona un d√≠a de la semana</h3><p>Vamos a configurar las horas en las que trabajas cada d√≠a.</p><div class="command-buttons-container">${btns}<button class="command-button full-width return" data-command="/horario">Cancelar</button></div></div>`); }
            async startDayEditFlow(dayKey) { const d = { mon: 'Lunes', tue: 'Martes', wed: 'Mi√©rcoles', thu: 'Jueves', fri: 'Viernes', sat: 'S√°bado', sun: 'Domingo' }[dayKey]; let opts = ''; for (let i = 7; i <= 21; i++) opts += `<option value="${i}">${i.toString().padStart(2, '0')}:00</option>`; const card = `<div class="bot-card"><h3>Define tu horario para <strong>${d}</strong></h3><div class="schedule-selector"><div class="schedule-row"><label for="start-hour-${dayKey}">Inicio:</label><select id="start-hour-${dayKey}">${opts}</select></div><div class="schedule-row"><label for="end-hour-${dayKey}">Fin:</label><select id="end-hour-${dayKey}">${opts}</select></div></div><p class="helper-text">Selecciona la primera y la √∫ltima hora que trabajas. Por ejemplo, de 9:00 a 17:00.</p><div class="schedule-actions"><button class="command-button confirm" data-day-confirm="${dayKey}">Confirmar Horario</button><button class="command-button cancel" data-command="/horario-cerrado ${dayKey}">Marcar como no laborable</button></div></div>`; this.addBotMessage(card); document.getElementById(`start-hour-${dayKey}`).value = 9; document.getElementById(`end-hour-${dayKey}`).value = 17; }
            async addService(name, price) { const p = parseFloat(price); if (isNaN(p) || p < 0) { this.addBotMessage('<div class="bot-card"><p>El precio que ingresaste no parece v√°lido. Por favor, introduce solo un n√∫mero positivo.</p></div>'); this.currentFlow = 'servicio_add_price'; return; } const b = await this.getBarberProfile(); const s = b.services || []; s.push({ name: name, price: p }); const { error } = await supabase.from('barbers').update({ services: s }).eq('user_id', this.currentUser.id); if (!error) { this.addBotMessage(`<div class="bot-card"><p>¬°Genial! ‚ú® He a√±adido "<strong>${name}</strong>" con un precio de $${p} a tu lista de servicios.</p></div>`); } this.currentFlow = 'authenticated'; await this.showServices(); }
            async updateService() { const { serviceToEdit, newServiceName, newServicePrice } = this.userData; const name = (newServiceName.toLowerCase() === 'mismo') ? serviceToEdit.name : newServiceName; const price = (newServicePrice.toLowerCase() === 'mismo') ? serviceToEdit.price : parseFloat(newServicePrice); if (isNaN(price)) { this.addBotMessage('<div class="bot-card"><p>El precio no parece v√°lido. Int√©ntalo de nuevo.</p></div>'); this.currentFlow = 'authenticated'; this.showServicesMenu(); return; } const b = await this.getBarberProfile(); const s = b.services.map(svc => (svc.name === serviceToEdit.name) ? { name, price } : svc); const { error } = await supabase.from('barbers').update({ services: s }).eq('user_id', this.currentUser.id); if (!error) { this.addBotMessage('<div class="bot-card"><p>‚úÖ ¬°Servicio actualizado con √©xito!</p></div>'); } this.currentFlow = 'authenticated'; this.userData = {}; await this.showServices(); }
            async setAvailability(dayKey, hours) { const b = await this.getBarberProfile(); let avail = b.availability || {}; avail[dayKey] = Array.isArray(hours) ? hours.sort((a,b) => a-b) : []; const { error } = await supabase.from('barbers').update({ availability: avail }).eq('user_id', this.currentUser.id); if (!error) { this.addBotMessage(`<div class="bot-card"><p>¬°Perfecto! Tu horario ha sido guardado. üëç</p></div>`); } this.currentFlow = 'authenticated'; await this.showAvailability(); }
            
            async checkAuthState() { 
                this.showTyping(); 
                const { data: { session } } = await supabase.auth.getSession(); 
                this.hideTyping(); 
                if (session && session.user) { 
                    this.currentUser = session.user; 
                    await this.getBarberProfile(); 
                    const name = this.barberProfile.first_name || this.currentUser.email; 
                    this.addBotMessage(`<div class="bot-card"><p>¬°Qu√© bueno verte de nuevo, <strong>${name}</strong>! üëã</p><p>Estoy listo para ayudarte a organizar tu d√≠a.</p></div>`); 
                    this.showMainMenu(); 
                    this.currentFlow = 'authenticated'; 
                    this.subscribeToNotifications(); 
                    this.subscribeToBookings();
                } else { 
                    this.startWelcomeFlow(); 
                } 
            }
            startWelcomeFlow() { this.addBotMessage(`<div class="bot-card"><h3>¬°Bienvenido a BarberConnect! üíà</h3><p>Soy tu asistente virtual, y estoy aqu√≠ para ayudarte a gestionar tu barber√≠a de forma sencilla.</p><p>Para empezar, ¬øeres un <strong>barbero</strong>?</p></div>`); this.currentFlow = 'welcome'; }
            async handleAuthFlow(input) { switch(this.currentFlow) { case 'welcome': if (input === 'barbero') { this.addBotMessage(`<div class="bot-card"><p>¬°Excelente! ¬øYa tienes una cuenta con nosotros?</p><p>Por favor, responde <strong>s√≠</strong> o <strong>no</strong>.</p></div>`); this.currentFlow = 'has_account'; } else { this.addBotMessage(`<div class="bot-card"><p>Entendido. Esta interfaz est√° dise√±ada especialmente para barberos. ¬°Esperamos verte pronto!</p></div>`) } break; case 'has_account': if (input.startsWith('s')) { this.addBotMessage('<div class="bot-card"><p>¬°Perfecto! Por favor, ingresa tu correo electr√≥nico para iniciar sesi√≥n.</p></div>'); this.currentFlow = 'login_email'; } else { this.addBotMessage('<div class="bot-card"><p>¬°Genial, vamos a crear tu cuenta! Primero, ¬øcu√°l es tu nombre?</p></div>'); this.currentFlow = 'register_name'; } break; case 'register_name': this.userData.firstName = input; this.addBotMessage(`<div class="bot-card"><p>¬°Un placer, ${input}! Ahora, ¬øcu√°l es tu apellido?</p></div>`); this.currentFlow = 'register_last_name'; break; case 'register_last_name': this.userData.lastName = input; this.addBotMessage('<div class="bot-card"><p>Muy bien. Ahora necesito tu correo electr√≥nico. Lo usaremos para iniciar sesi√≥n.</p></div>'); this.currentFlow = 'register_email'; break; case 'register_email': this.userData.email = input; this.addBotMessage('<div class="bot-card"><p>Para terminar, crea una contrase√±a segura (debe tener al menos 6 caracteres).</p></div>'); this.currentFlow = 'register_password'; break; case 'register_password': if (input.length < 6) { this.addBotMessage('<div class="bot-card"><p>La contrase√±a es muy corta. Por seguridad, necesita al menos 6 caracteres. ¬°Intenta con otra!</p></div>'); return; } this.userData.password = input; await this.registerUser(); break; case 'login_email': this.userData.email = input; this.addBotMessage('<div class="bot-card"><p>Gracias. Ahora, ingresa tu contrase√±a.</p></div>'); this.currentFlow = 'login_password'; break; case 'login_password': await this.loginUser(input); break; } }
            async registerUser() { const { data, error } = await supabase.auth.signUp({ email: this.userData.email, password: this.userData.password, options: { data: { first_name: this.userData.firstName, last_name: this.userData.lastName, user_type: 'barbero' } } }); if (error) { this.addBotMessage(`<div class="bot-card"><p>‚ùå Hubo un error en el registro: ${error.message}. Por favor, int√©ntalo de nuevo.</p></div>`); this.startWelcomeFlow(); return; } if (data.user) { this.currentUser = data.user; await this.createBarberProfile(data.user.id); this.addBotMessage('<div class="bot-card"><h3>¬°Cuenta Creada! üöÄ</h3><p>Tu registro fue un √©xito. Te he enviado un correo de confirmaci√≥n. Una vez que lo verifiques, tendr√°s acceso a todo.</p></div>'); this.showMainMenu(); this.currentFlow = 'authenticated'; } }
            async createBarberProfile(userId) { const code = Math.random().toString(36).substring(2, 8).toUpperCase(); await supabase.from('barbers').insert([{ user_id: userId, first_name: this.userData.firstName, last_name: this.userData.lastName, barber_shop_name: `Barber√≠a de ${this.userData.firstName}`, services: [], availability: {}, public_code: code }]); }
            async loginUser(password) { const { data, error } = await supabase.auth.signInWithPassword({ email: this.userData.email, password: password }); if (error) { this.addBotMessage(`<div class="bot-card"><p>‚ùå Usuario o contrase√±a incorrectos. Vamos a intentarlo de nuevo.</p></div>`); this.currentFlow = 'has_account'; this.handleAuthFlow('si'); return; } this.currentUser = data.user; this.addBotMessage('<div class="bot-card"><p>‚úÖ ¬°Inicio de sesi√≥n exitoso!</p></div>'); this.checkAuthState(); }
            
            async logout() { 
                await supabase.auth.signOut(); 
                if (this.notificationsSubscription) { this.notificationsSubscription.unsubscribe(); this.notificationsSubscription = null; } 
                if (this.bookingsSubscription) { this.bookingsSubscription.unsubscribe(); this.bookingsSubscription = null; } 
                if (this.chatSubscription) { this.chatSubscription.unsubscribe(); this.chatSubscription = null; } 
                this.currentUser = null; this.barberProfile = null; this.userData = {}; this.addBotMessage('<div class="bot-card"><p>¬°Hasta pronto! Tu sesi√≥n se ha cerrado de forma segura. üëã</p></div>'); 
                setTimeout(() => { this.messagesContainer.innerHTML = ''; this.startWelcomeFlow(); }, 1500); 
            }
            
            async subscribeToNotifications() { 
                if (this.notificationsSubscription || !this.barberProfile) return; 
                const { data: chats, error } = await supabase.from('chats').select('id').eq('barber_id', this.barberProfile.id); 
                if (error || !chats || chats.length === 0) return; 
                const chatIds = chats.map(c => c.id); 
                this.notificationsSubscription = supabase.channel('barber_notifications')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=in.(${chatIds.join(',')})` }, payload => { 
                        if (payload.new.sender_type === 'client' && payload.new.chat_id !== this.activeChat.id) { 
                            const chatId = payload.new.chat_id;
                            this.unreadCounts[chatId] = (this.unreadCounts[chatId] || 0) + 1;
                            this.updateBadges();
                            const indicator = document.getElementById(`unread-${chatId}`); 
                            if (indicator) indicator.classList.add('visible'); 
                        } 
                    }).subscribe(); 
            }
            async subscribeToBookings() {
                if (this.bookingsSubscription || !this.barberProfile) return;
                this.bookingsSubscription = supabase
                    .channel('barber_bookings')
                    .on('postgres_changes', {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'bookings',
                        filter: `barber_id=eq.${this.barberProfile.id}`
                    }, payload => {
                        this.newBookingsCount++;
                        this.updateBadges();
                    })
                    .subscribe();
            }
            async showClientChats() { 
                const { data: chats, error } = await supabase.from('chats').select(`id, clients (id, first_name, last_name)`).eq('barber_id', this.barberProfile.id); 
                if (error) { console.error(error); return; } 
                this.clientChatsList.innerHTML = ''; 
                if (chats.length === 0) { 
                    this.clientChatsList.innerHTML = '<li>A√∫n no tienes ninguna conversaci√≥n. Cuando un cliente te contacte, aparecer√° aqu√≠.</li>'; 
                } else { 
                    chats.forEach(chat => { 
                        const client = chat.clients; 
                        const clientName = `${client.first_name} ${client.last_name}`; 
                        const listItem = document.createElement('li'); 
                        listItem.dataset.chatId = chat.id; listItem.dataset.clientId = client.id; 
                        listItem.dataset.clientName = clientName; 
                        
                        // Determinar si el chat tiene mensajes no le√≠dos
                        const isUnread = this.unreadCounts[chat.id] > 0;
                        
                        listItem.innerHTML = `<div class="avatar">${clientName.charAt(0)}</div><div class="chat-info"><div class="chat-name">${clientName}</div></div><div class="unread-indicator ${isUnread ? 'visible' : ''}" id="unread-${chat.id}"></div>`; 
                        listItem.addEventListener('click', () => this.openChat(chat.id, client.id, clientName)); 
                        this.clientChatsList.appendChild(listItem); 
                    }); 
                } 
                this.switchView('clientChatsView'); 
            }
            async openChat(chatId, clientId, clientName) { 
                if (this.unreadCounts[chatId]) {
                    delete this.unreadCounts[chatId];
                    this.updateBadges();
                }
                const indicator = document.getElementById(`unread-${chatId}`); 
                if (indicator) indicator.classList.remove('visible'); 
                
                this.activeChat = { id: chatId, clientName, clientId }; 
                this.switchView('singleChatView'); 
                this.singleChatMessages.innerHTML = 'Cargando mensajes...'; 
                const { data: messages, error } = await supabase.from('messages').select('*').eq('chat_id', chatId).order('created_at', { ascending: true }); 
                this.singleChatMessages.innerHTML = ''; 
                if (messages) messages.forEach(msg => this.renderMessage(msg, this.singleChatMessages, false)); 
                this.singleChatMessages.scrollTop = this.singleChatMessages.scrollHeight; 
                this.subscribeToChatChannel(chatId); 
            }
            subscribeToChatChannel(chatId) { 
                if (this.chatSubscription) this.chatSubscription.unsubscribe(); 
                this.chatSubscription = supabase.channel(`chat_${chatId}`)
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}`}, (payload) => { 
                        if (payload.new.sender_type === 'client') this.renderMessage(payload.new, this.singleChatMessages); 
                    }).subscribe(); 
            }
            async sendClientMessage(text) { 
                if (!this.activeChat.id) return; 
                const messagePayload = { chat_id: this.activeChat.id, sender_type: 'barber', sender_id: this.barberProfile.id, content: text }; 
                this.renderMessage({ ...messagePayload }, this.singleChatMessages); 
                await supabase.from('messages').insert(messagePayload); 
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => new ChatApp());
    </script>
</body>
</html>
